<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è´ªç©è“æœˆ-é¬¼ç•œè‡³å°Šç‰ˆ</title>
    <style>
        /* --- æè‡´åœŸå—¨ CSS æ ·å¼åŒº --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'SimHei', sans-serif; touch-action: none;}
        
        /* ççœ¼èƒŒæ™¯é—ªçƒ */
        @keyframes bg-flash { 
            0% { background: #110000; } 50% { background: #330000; } 100% { background: #110000; } 
        }
        body.active-mode { animation: bg-flash 0.2s infinite; }

        /* å½©è™¹å¤§å­— */
        @keyframes rainbow { 
            0% {color: red; text-shadow: 2px 2px yellow;} 
            50% {color: yellow; text-shadow: 2px 2px blue;} 
            100% {color: red; text-shadow: 2px 2px yellow;} 
        }

        /* UI å®¹å™¨ */
        #ui-container {
            position: absolute; bottom: 20px; width: 100%; text-align: center; z-index: 100;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°ç”»å¸ƒ */
        }
        .control-box {
            display: inline-block; background: rgba(0,0,0,0.7); border: 3px solid gold;
            padding: 15px; border-radius: 10px; pointer-events: auto;
        }
        .btn-role {
            background: linear-gradient(#ff0000, #990000); border: 2px solid yellow; color: yellow;
            font-size: 20px; font-weight: bold; padding: 10px 25px; margin: 5px; cursor: pointer;
            box-shadow: 0 5px #660000;
        }
        .btn-role:active { box-shadow: 0 2px #660000; transform: translateY(3px); }
        .btn-role.selected { filter: brightness(1.5); border-color: white; }

        /* æµ®å¤¸æ ‡è¯­ */
        #slogan {
            position: absolute; top: 5%; width: 100%; text-align: center;
            font-size: 40px; font-weight: 900; animation: rainbow 0.5s infinite linear;
            pointer-events: none;
             -webkit-text-stroke: 1px black;
        }
        #sub-slogan {
            position: absolute; top: 15%; width: 100%; text-align: center; color: white; font-size: 18px;
        }

        /* ä¼¤å®³æ•°å­—å¼¹å‡ºå±‚ */
        #damage-layer {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; overflow: hidden;
        }
        .damage-text {
            position: absolute; font-size: 50px; color: yellow; font-weight: bold; 
            text-shadow: 3px 3px red; opacity: 1;
            animation: popUp 1s forwards;
        }
        @keyframes popUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            50% { transform: translate(-50%, -150%) scale(1.5); opacity: 0.8; }
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
        }
        
        #video-debug { position: absolute; top:0; right:0; width: 100px; opacity: 0.5; z-index: 999; border: 2px solid red;}
    </style>
</head>
<body>

    <div id="slogan">ğŸ”¥ ç³»å…„å¼Ÿå°±ä¼¸æ‰‹ç æˆ‘ï¼ğŸ”¥</div>
    <div id="sub-slogan">äº¤äº’ï¼šå¼ å¼€æ‰‹æŒè§¦å‘ã€é¬¼ç•œæš´å‡»ã€‘æ¨¡å¼</div>

    <div id="damage-layer"></div>

    <div id="ui-container">
        <div class="control-box">
            <button class="btn-role selected" id="btn-zzh">æ¸£æ¸£è¾‰</button>
            <button class="btn-role" id="btn-gtl">å¤å¤©ä¹</button>
            <button class="btn-role" id="btn-jay">å‘¨è‘£(ä¼ª)</button>
        </div>
    </div>

    <video id="input_video" style="display:none"></video>
    <canvas id="video-debug"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';

        // ==========================================
        // 0. åœŸå—¨ç´ æåŒº (Base64 åƒç´ å›¾ï¼Œç¡®ä¿åŠ è½½)
        // ==========================================
        // ä½¿ç”¨æä½åˆ†è¾¨ç‡çš„åƒç´ å›¾ï¼Œæ”¾å¤§åæœ‰å¤©ç„¶çš„é©¬èµ›å…‹LOWæ„Ÿ
        const ZZH_DATA = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAE5JREFUOE9jZKAQcDEwMDTj4v9nQhfjwsVlI8NIBgY8hjCjazI1NBPwGcLNwIDNEFwG4LME3RB8lrAbQoAlpIKB4WkK3fQ0hYF8SgEAd70MNc717OQAAAAASUVORK5CYII='; // çº¢è‰²çš„æ¸£
        const GTL_DATA = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAE9JREFUOE9jZKAQcDEwMDTj4v9nQhfjwsVlI8NIBgY8hjCjazI1NBPwGcLNwIDNEFwG4LME3RB8lrAbQoAlpIKB4WkK3fQ0hYF8SgEAd70MNc717OQAAAAASUVORK5CYII='; // ç»¿è‰²çš„å¤ (å¤ç”¨åƒç´ ç»“æ„ï¼Œä»…ç¤ºæ„)
        const JAY_DATA = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAE9JREFUOE9jZKAQcDEwMDTj4v9nQhfjwsVlI8NIBgY8hjCjazI1NBPwGcLNwIDNEFwG4LME3RB8lrAbQoAlpIKB4WkK3fQ0hYF8SgEAd70MNc717OQAAAAASUVORK5CYII='; // è“è‰²çš„å‘¨ (å¤ç”¨åƒç´ ç»“æ„ï¼Œä»…ç¤ºæ„)

        const textureLoader = new THREE.TextureLoader();
        // è®¾ç½®çº¹ç†ä¸ºæœ€é‚»è¿‘è¿‡æ»¤ï¼Œä¿è¯æ”¾å¤§åæ˜¯é©¬èµ›å…‹è€Œä¸æ˜¯æ¨¡ç³Š
        const loadPixelTexture = (data) => {
            const tex = textureLoader.load(data);
            tex.magFilter = THREE.NearestFilter;
            return tex;
        };
        const texZZH = loadPixelTexture(ZZH_DATA);
        // ä¸ºäº†åŒºåˆ†ï¼Œæˆ‘ä»¬åœ¨ä»£ç é‡Œç»™æè´¨å˜è‰²ï¼Œè™½ç„¶è´´å›¾ä¸€æ ·
        const texGTL = loadPixelTexture(GTL_DATA); 
        const texJAY = loadPixelTexture(JAY_DATA);

        // ==========================================
        // 1. Three.js åœºæ™¯åˆå§‹åŒ–
        // ==========================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: false }); // å…³é—­æŠ—é”¯é½¿æ›´LOW
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- ä¸»è§’ï¼šå·¨å‹é¬¼ç•œ Sprite ---
        const spriteMaterial = new THREE.SpriteMaterial({ map: texZZH, color: 0xffffff });
        const mainRole = new THREE.Sprite(spriteMaterial);
        mainRole.scale.set(3, 3, 1); // è®¾ç½®åˆå§‹å¤§å°
        scene.add(mainRole);

        // --- é…è§’ï¼šå»‰ä»·çˆ†ç ´ç²’å­æ±  ---
        const particleCount = 200;
        const particlesGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(particleCount * 3);
        const velocityArray = new Float32Array(particleCount * 3); // å­˜å‚¨é€Ÿåº¦
        
        for(let i=0; i<particleCount; i++) {
            posArray[i*3] = (Math.random()-0.5)*2;
            posArray[i*3+1] = (Math.random()-0.5)*2;
            posArray[i*3+2] = (Math.random()-0.5)*1 - 1; // åœ¨ä¸»è§’åé¢
            // åˆå§‹é€Ÿåº¦ä¸º0
            velocityArray[i*3] = 0; velocityArray[i*3+1] = 0; velocityArray[i*3+2] = 0;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particleMat = new THREE.PointsMaterial({
            size: 0.2, color: 0xffff00, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending
        });
        const explosionParticles = new THREE.Points(particlesGeo, particleMat);
        scene.add(explosionParticles);


        // ==========================================
        // 2. æ ¸å¿ƒé€»è¾‘ä¸åŠ¨ç”»å¾ªç¯
        // ==========================================
        let isCrazyMode = false; // æ˜¯å¦å¤„äºé¬¼ç•œæ¨¡å¼
        let handOpenness = 0;    // æ‰‹å¼ å¼€ç¨‹åº¦ (0-1)
        let frameCounter = 0;
        let lastDamageTime = 0;

        function animate() {
            requestAnimationFrame(animate);
            frameCounter++;
            const time = Date.now() * 0.005;

            // --- çŠ¶æ€åˆ¤æ–­ ---
            // é˜ˆå€¼è®¾ç½®ä½ä¸€ç‚¹ï¼Œæ›´å®¹æ˜“è§¦å‘
            isCrazyMode = handOpenness > 0.6;

            if (isCrazyMode) {
                document.body.classList.add('active-mode');
                
                // 1. ä¸»è§’é¬¼ç•œæŠ–åŠ¨ (æ ¸å¿ƒLOWç‚¹)
                mainRole.position.x = (Math.random() - 0.5) * 0.5 * handOpenness;
                mainRole.position.y = (Math.random() - 0.5) * 0.5 * handOpenness;
                // 2. ä¸»è§’æ”¾å¤§é€¼è¿‘
                const targetScale = 3 + handOpenness * 2;
                mainRole.scale.lerp(new THREE.Vector3(targetScale, targetScale, 1), 0.2);
                // 3. å…‰æ±¡æŸ“é—ªçƒ (æ¯3å¸§æ¢ä¸ªè‰²)
                if (frameCounter % 3 === 0) {
                    mainRole.material.color.setHSL(Math.random(), 1.0, 0.5);
                }

                // 4. è§¦å‘çˆ†ç ´ç²’å­å’Œä¼¤å®³æ•°å­—
                explodeParticles();
                if (Date.now() - lastDamageTime > 500) { // æ¯0.5ç§’è¹¦ä¸€ä¸ªæ•°å­—
                    showDamageNumber();
                    lastDamageTime = Date.now();
                }

            } else {
                // --- å¹³é™çŠ¶æ€ ---
                document.body.classList.remove('active-mode');
                // ç¼“æ…¢å¤åŸ
                mainRole.position.lerp(new THREE.Vector3(0,0,0), 0.1);
                mainRole.scale.lerp(new THREE.Vector3(3,3,1), 0.1);
                mainRole.material.color.set(0xffffff); // å¤åŸç™½è‰²

                // ç²’å­ç¼“æ…¢å½’ä½
                resetParticles();
            }

            // ç²’å­ä½ç½®æ›´æ–°
            explosionParticles.geometry.attributes.position.needsUpdate = true;
            
            renderer.render(scene, camera);
        }

        // --- ç²’å­è¡Œä¸ºå‡½æ•° ---
        function explodeParticles() {
            const positions = explosionParticles.geometry.attributes.position.array;
            for(let i=0; i<particleCount; i++) {
                const idx = i*3;
                // ç»™ä¸€ä¸ªå‘å¤–çš„çˆ†å‘é€Ÿåº¦
                velocityArray[idx] += (Math.random()-0.5) * 0.05;
                velocityArray[idx+1] += (Math.random()-0.5) * 0.05;
                velocityArray[idx+2] += Math.random() * 0.05; // å‘å‰å–·å°„

                positions[idx] += velocityArray[idx];
                positions[idx+1] += velocityArray[idx+1];
                positions[idx+2] += velocityArray[idx+2];

                 // è¾¹ç•Œæ£€æŸ¥ï¼Œé£å¤ªè¿œå°±é‡ç½®åˆ°ä¸­é—´ï¼Œå½¢æˆå¾ªç¯å–·å°„
                 if(positions[idx+2] > 5 || Math.abs(positions[idx]) > 3) {
                     positions[idx] = 0; positions[idx+1] = 0; positions[idx+2] = -1;
                     velocityArray[idx] = 0; velocityArray[idx+1] = 0; velocityArray[idx+2] = 0;
                 }
            }
            explosionParticles.material.color.setHSL(Math.random(), 1.0, 0.5); // ç²’å­ä¹Ÿè·Ÿç€é—ª
        }

        function resetParticles() {
             const positions = explosionParticles.geometry.attributes.position.array;
             for(let i=0; i<particleCount; i++) {
                 const idx = i*3;
                 // ç¼“æ…¢å›åˆ°ä¸­å¿ƒåæ–¹
                 positions[idx] += (0 - positions[idx]) * 0.05;
                 positions[idx+1] += (0 - positions[idx+1]) * 0.05;
                 positions[idx+2] += (-1 - positions[idx+2]) * 0.05;
                 velocityArray[idx] *= 0.9; // é˜»åŠ›
             }
             explosionParticles.material.color.set(0xffff00);
        }

        // --- è¹¦ä¼¤å®³æ•°å­— ---
        function showDamageNumber() {
            const dmgLayer = document.getElementById('damage-layer');
            const el = document.createElement('div');
            el.className = 'damage-text';
            // éšæœºç”Ÿæˆå·¨å¤§æ•°å­—
            const dmg = Math.floor(Math.random() * 89999 + 10000);
            el.innerText = `æš´å‡»+${dmg}!!`;
            // éšæœºä½ç½®å‡ºç°åœ¨ä¸»è§’å‘¨å›´
            const left = 50 + (Math.random()-0.5)*40;
            const top = 50 + (Math.random()-0.5)*40;
            el.style.left = left + '%';
            el.style.top = top + '%';
            dmgLayer.appendChild(el);
            // åŠ¨ç”»ç»“æŸååˆ é™¤ DOM
            setTimeout(() => { el.remove(); }, 1000);
        }


        // ==========================================
        // 3. MediaPipe æ‰‹åŠ¿è¯†åˆ«
        // ==========================================
        const videoElement = document.getElementById('input_video');
        // è°ƒè¯•ç”»å¸ƒ
        const debugCanvas = document.getElementById('video-debug');
        const debugCtx = debugCanvas.getContext('2d');
        
        function onResults(results) {
            // å°†æ‘„åƒå¤´ç”»é¢ç»˜åˆ¶åˆ°è°ƒè¯•ç”»å¸ƒä¸Š
            debugCtx.save();
            debugCtx.clearRect(0, 0, debugCanvas.width, debugCanvas.height);
            debugCtx.drawImage(results.image, 0, 0, debugCanvas.width, debugCanvas.height);
            debugCtx.restore();

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                // ç®€å•è®¡ç®—æ‰‹æŒå¼ å¼€åº¦ï¼šè®¡ç®— æ‹‡æŒ‡æŒ‡å°–(4) åˆ° å°æŒ‡æŒ‡å°–(20) çš„è·ç¦»
                const p1 = landmarks[4];
                const p2 = landmarks[20];
                // ç®€åŒ–çš„è·ç¦»ä¼°ç®—
                const distance = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
                
                // æ˜ å°„è·ç¦»åˆ° 0-1 ä¹‹é—´ã€‚ç»éªŒå€¼ï¼šé—­åˆå¤§æ¦‚ 0.1ï¼Œå¼ å¼€å¤§æ¦‚ 0.4-0.5
                let rawOpenness = (distance - 0.1) * 3.0;
                handOpenness = Math.max(0, Math.min(1, rawOpenness));
            } else {
                handOpenness = 0; // æ²¡æ‰‹å°±å½’é›¶
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 320, height: 240 // é™ä½åˆ†è¾¨ç‡æé«˜æ€§èƒ½
        });
        
        // åˆå§‹åŒ–è°ƒè¯•ç”»å¸ƒå¤§å°
        debugCanvas.width = 320; debugCanvas.height = 240;
        cameraUtils.start();
        animate(); // å¯åŠ¨æ¸²æŸ“å¾ªç¯

        // ==========================================
        // 4. UI äº¤äº’
        // ==========================================
        const btns = { zzh: document.getElementById('btn-zzh'), gtl: document.getElementById('btn-gtl'), jay: document.getElementById('btn-jay') };
        
        function switchRole(roleId, texture, colorTint) {
            Object.values(btns).forEach(b => b.classList.remove('selected'));
            btns[roleId].classList.add('selected');
            mainRole.material.map = texture;
            // è™½ç„¶è´´å›¾ä¸€æ ·ï¼Œä½†æˆ‘ä»¬ç”¨ä¸åŒé¢œè‰²tintåŒºåˆ†ä¸€ä¸‹
            spriteMaterial.color.set(colorTint);
        }

        btns.zzh.addEventListener('click', () => switchRole('zzh', texZZH, 0xffffff)); // åŸè‰²
        btns.gtl.addEventListener('click', () => switchRole('gtl', texGTL, 0x55ff55)); // ç»¿è‰²æ»¤é•œ
        btns.jay.addEventListener('click', () => switchRole('jay', texJAY, 0x5555ff)); // è“è‰²æ»¤é•œ

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>

    
