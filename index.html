<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden AR Christmas - Hand Gesture Edition</title>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* ========================
           å…¨å±€æ ·å¼ (Global)
           ======================== */
        :root {
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --bg-dark: #050505;
            --glass: rgba(20, 20, 20, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            overflow: hidden; color: var(--gold); user-select: none;
        }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* è§†å›¾å®¹å™¨ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.6s ease;
            background: radial-gradient(circle at center, rgba(20,20,20,0.4), #000);
        }
        .view-section.active { display: flex; opacity: 1; }

        /* é€šç”¨æŒ‰é’® */
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: none; color: #000; padding: 12px 30px; font-size: 16px; font-weight: bold;
            border-radius: 25px; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s; margin-top: 20px; width: 80%; max-width: 200px;
            position: relative; z-index: 20;
        }
        .btn-gold:active { transform: scale(0.95); }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 20px; font-size: 14px; margin: 0 5px; cursor: pointer;
        }

        .input-gold {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: var(--gold);
            border-radius: 8px; text-align: center; font-size: 16px; outline: none;
        }

        /* ========================
           1. ç™»å½•é¡µåŠ¨ç”»
           ======================== */
        .login-panel {
            width: 85%; max-width: 320px; padding: 40px 20px;
            background: var(--glass); border: 1px solid var(--gold); border-radius: 15px;
            text-align: center; backdrop-filter: blur(10px); position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.9); z-index: 5;
        }

        /* é£ç«è½®ç‰¹æ•ˆ */
        .fire-wheel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 120%; height: 120%; border-radius: 50%;
            border: 2px dashed rgba(255, 215, 0, 0.3);
            pointer-events: none; animation: spinWheel 10s linear infinite;
        }
        @keyframes spinWheel { from {transform: translate(-50%, -50%) rotate(0deg);} to {transform: translate(-50%, -50%) rotate(360deg);} }

        /* èƒŒæ™¯å¾ªç¯åŠ¨ç”» */
        .bg-anim-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        .anim-item { position: absolute; font-size: 40px; opacity: 0; will-change: transform, opacity; }

        /* ç›èæ‹‰è’‚ */
        .anim-car { bottom: 15%; left: -150px; animation: driveRight 8s linear infinite; animation-delay: 1s; font-size: 50px; }
        @keyframes driveRight { 0% {transform: translateX(0); opacity:0;} 10% {opacity:1;} 90% {opacity:1;} 100% {transform: translateX(120vw); opacity:0;} }

        /* åœ£è¯æ ‘ */
        .anim-tree { top: 15%; right: -100px; animation: flyLeft 12s linear infinite; animation-delay: 4s; font-size: 60px; }
        @keyframes flyLeft { 0% {transform: translateX(0) rotate(0deg); opacity:0;} 10% {opacity:0.8;} 90% {opacity:0.8;} 100% {transform: translateX(-120vw) rotate(-360deg); opacity:0;} }

        /* åœ£è¯è€äºº */
        .anim-santa { top: 40%; left: -200px; animation: driveRight 15s linear infinite; animation-delay: 8s; font-size: 80px; }

        /* ========================
           2. è‹±é›„é€‰æ‹©é¡µ
           ======================== */
        .hero-grid { display: flex; gap: 15px; justify-content: center; perspective: 1000px; }
        .hero-card {
            width: 95px; height: 160px; background: rgba(20,20,20,0.9); border: 1px solid #444;
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.3s; cursor: pointer; animation: floatCard 3s ease-in-out infinite;
        }
        .hero-card:nth-child(2) { animation-delay: 0.5s; }
        @keyframes floatCard { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(1) brightness(0.4); }
        .hero-icon { font-size: 40px; margin-bottom: 10px; }
        .lock-tag { position: absolute; top: 5px; right: 5px; font-size: 12px; }

        /* ========================
           3. åœ£è¯è€äººäº’åŠ¨é¡µ (æŒ¥æ‰‹)
           ======================== */
        #santa-story-img {
            width: 90%; max-width: 400px; object-fit: contain; margin-bottom: 20px;
            filter: drop-shadow(0 0 30px var(--gold)); transform: scale(0.5); opacity: 0;
            transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .santa-appear { transform: scale(1) !important; opacity: 1 !important; }

        .gesture-hint {
            background: rgba(0,0,0,0.6); border: 1px solid var(--gold); padding: 10px 20px;
            border-radius: 20px; font-size: 16px; color: #fff; text-align: center;
            animation: pulseHint 1s infinite alternate; margin-top: 20px;
        }
        @keyframes pulseHint { from {box-shadow: 0 0 5px var(--gold-glow);} to {box-shadow: 0 0 20px var(--gold-glow);} }

        /* ========================
           4. AR åœºæ™¯ (æ ¸å¿ƒäº¤äº’)
           ======================== */
        /* èƒŒæ™¯æ˜Ÿç©º */
        #view-ar {
            background:
                radial-gradient(circle at 20% 0%, rgba(255, 215, 0, 0.1), transparent 50%),
                radial-gradient(circle at 80% 100%, rgba(255, 215, 0, 0.05), transparent 50%),
                radial-gradient(circle at 50% 50%, #050510, #000 100%);
        }

        /* å³ä¸Šè§’ç”»ä¸­ç”»æ‘„åƒå¤´ */
        #ar-camera-feed {
            position: absolute; top: 16px; right: 16px;
            width: 28vw; max-width: 140px; aspect-ratio: 3/4;
            object-fit: cover; border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transform: scaleX(-1); /* é•œåƒ */
            z-index: 5;
            background: #111;
        }

        /* æ‚¬æµ® AR èˆå° */
        #ar-tree-stage {
            position: absolute;
            left: 50%; top: 60%; /* åä¸‹ï¼Œé è¿‘æ‰‹çš„ä½ç½® */
            transform: translate(-50%, -50%);
            width: 70vw; max-width: 350px; aspect-ratio: 3/4;
            perspective: 1000px; transform-style: preserve-3d;
            z-index: 10;
        }

        /* æ ‘å›¾ç‰‡ */
        #ar-tree-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.8)) brightness(1.1);
            transform-origin: 50% 80%; /* æ—‹è½¬è½´åœ¨åº•éƒ¨ */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }

        /* åº•éƒ¨å…‰æ™• (å¢å¼ºæ‚¬æµ®æ„Ÿ) */
        #ar-tree-stage::after {
            content: ""; position: absolute; left: 50%; bottom: 5%;
            width: 60%; height: 15%; transform: translateX(-50%);
            background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.3), transparent 70%);
            filter: blur(15px); pointer-events: none; z-index: -1;
        }

        /* AR UI */
        .ar-ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 20;
        }
        .ar-timer { font-size: 32px; font-weight: 800; text-shadow: 0 0 10px #000; position: absolute; top: 20px; left: 20px; }

        .ar-guide-box {
            align-self: center; text-align: center; margin-bottom: 20px;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 12px;
            border: 1px solid rgba(255,215,0,0.3); min-width: 260px;
        }

        /* åŠ è½½ä¸­ */
        #mp-loader {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: rgba(0,0,0,0.8); color: var(--gold); padding: 20px; border-radius: 10px;
            z-index: 100; display: none; text-align: center;
        }

        /* å…¨å±€ç‰¹æ•ˆ */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-body {
            background: var(--glass); border: 1px solid var(--gold);
            padding: 30px; border-radius: 15px; text-align: center; width: 85%;
            box-shadow: 0 0 40px var(--gold-glow); transform: scale(0.9); transition: 0.3s;
        }
        .modal-body.show { transform: scale(1); }

        #flying-gift {
            position: fixed; top: 50%; left: 50%; font-size: 100px; z-index: 150;
            transform: translate(-50%, -50%) scale(0); pointer-events: none;
        }
        #explosion-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .boom-particle { position: absolute; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold-glow); }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <div id="mp-loader">ğŸ–ï¸ æ­£åœ¨å¯åŠ¨è§†è§‰è¯†åˆ«å¼•æ“...</div>

    <section id="view-login" class="view-section active">
        <div class="bg-anim-layer">
            <div class="anim-item anim-car">ğŸï¸</div>
            <div class="anim-item anim-tree">ğŸ„</div>
            <div class="anim-item anim-santa">ğŸ…</div>
        </div>
        <div class="login-panel">
            <div class="fire-wheel"></div>
            <h2 style="margin-top:0; text-shadow: 0 0 10px var(--gold);">VIP ACCESS</h2>
            <div style="margin-bottom:20px; font-size:14px; color:#aaa; position:relative;">å¼€å¯ä½ çš„é‡‘è‰²åœ£è¯ä¹‹æ—…</div>
            <input type="tel" class="input-gold" placeholder="æ‰‹æœºå·">
            <input type="text" class="input-gold" placeholder="éªŒè¯ç ">
            <button class="btn-gold" onclick="app.handleLogin()">ç«‹å³ç™»å½•</button>
        </div>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="margin-bottom:40px;">é€‰æ‹©ä½ çš„è‹±é›„</h2>
        <div class="hero-grid">
            <div class="hero-card unlocked" onclick="app.toast('å·²è£…å¤‡ï¼šé‡‘è‰²ç›èæ‹‰è’‚')">
                <div class="hero-icon">ğŸï¸</div>
                <div style="font-size:12px; color:var(--gold);">é»„é‡‘ GT</div>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.handleTreeClick()">
                <div class="lock-tag">ğŸ”’</div>
                <div class="hero-icon">ğŸ„</div>
                <div style="font-size:12px; color:#aaa;">å¹»å½±æ ‘</div>
            </div>
            <div class="hero-card locked" onclick="app.toast('æ•¬è¯·æœŸå¾…')">
                <div class="hero-icon">â“</div>
                <div style="font-size:12px; color:#aaa;">ç¥ç§˜å˜‰å®¾</div>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ä½ çš„ç¥ç¦</h2>
        <input type="text" id="wish-input" class="input-gold" style="width:80%;" maxlength="20" placeholder="ä¾‹å¦‚ï¼šé—ºèœœä»Šå¹´ä¸€èµ·æš´å¯Œï¼">
        <button class="btn-gold" onclick="app.confirmWish()">ç¡®è®¤ç”Ÿæˆ</button>
    </section>

    <section id="view-santa" class="view-section">
        <img id="santa-story-img" src="ChatGPT Image Dec 1, 2025, 10_09_26 PM.png" alt="Santa">

        <div id="santa-hint" class="gesture-hint">
            ğŸ‘‹ æŠŠæ‰‹ä¸¾åˆ°ç”»é¢é‡Œï¼ŒæŒ¥ä¸€æŒ¥ï¼
        </div>
    </section>

    <section id="view-ar" class="view-section">
        <video id="ar-camera-feed" playsinline muted></video>

        <div id="ar-tree-stage">
            <img id="ar-tree-img" src="ChatGPT Image Dec 1, 2025, 09_36_29 PM.png" alt="AR Tree">
        </div>

        <div class="ar-ui-overlay">
            <div id="ar-timer" class="ar-timer">12s</div>

            <div class="ar-guide-box" id="ar-guide">
                <div style="font-size:18px; color:var(--gold); font-weight:bold; margin-bottom:5px;">ğŸ‘‹ æ‰‹åŠ¿æ§åˆ¶</div>
                <div style="font-size:14px; color:#fff; line-height:1.5;">
                    å·¦å³ç§»åŠ¨æ‰‹æŒ â†’ æ ‘æ—‹è½¬<br>
                    æ‰‹é è¿‘/è¿œç¦» â†’ æ ‘æ”¾å¤§/ç¼©å°
                </div>
                <div style="font-size:10px; color:#aaa; margin-top:5px; border-top:1px solid #444; padding-top:5px;">
                    å³ä¸Šè§’é¢„è§ˆä»…è¾…åŠ©è¯†åˆ«ï¼Œä¸å­˜å‚¨äººè„¸
                </div>
            </div>
        </div>
    </section>

    <div id="flying-gift">ğŸ</div>
    <div id="explosion-layer"></div>

    <div id="modal" class="modal-mask">
        <div class="modal-body" id="modal-box">
            <h3 id="modal-title" style="color:var(--gold);">æç¤º</h3>
            <p id="modal-content" style="color:#ccc; margin:20px 0;">å†…å®¹</p>
            <div id="modal-btns" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                currentView: 'login',
                treeUnlocked: false,
                cameraActive: false,
                mpLoaded: false,
                waveCount: 0,
                lastHandPos: null // {x, y, time}
            },
            hands: null,
            cameraUtils: null,
            videoElement: null,

            init() {
                this.initParticles();
                this.initMediaPipe();
                console.log("App Initialized.");
            },

            // --- MediaPipe Setup ---
            initMediaPipe() {
                this.videoElement = document.getElementById('ar-camera-feed');

                this.hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});

                this.hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.6,
                    minTrackingConfidence: 0.5
                });

                this.hands.onResults(this.onHandResults.bind(this));

                // ä½¿ç”¨ CameraUtils ç®¡ç†è§†é¢‘æµ
                this.cameraUtils = new Camera(this.videoElement, {
                    onFrame: async () => {
                        await this.hands.send({image: this.videoElement});
                    },
                    width: 640,
                    height: 480
                });
            },

            // --- æ ¸å¿ƒè¯†åˆ«é€»è¾‘ ---
            onHandResults(results) {
                // å¦‚æœå½“å‰ä¸åœ¨éœ€è¦è¯†åˆ«çš„è§†å›¾ï¼Œç›´æ¥è¿”å›
                if (this.state.currentView !== 'santa' && this.state.currentView !== 'ar') return;

                const loader = document.getElementById('mp-loader');
                if (loader.style.display !== 'none') {
                    loader.style.display = 'none'; // é¦–æ¬¡è¯†åˆ«æˆåŠŸï¼Œéšè— loading
                    this.state.mpLoaded = true;
                }

                const treeImg = document.getElementById('ar-tree-img');
                const guide = document.getElementById('ar-guide');
                const santaHint = document.getElementById('santa-hint');

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const landmarks = results.multiHandLandmarks[0];

                    // è®¡ç®—æ ¸å¿ƒå‚æ•°
                    const wrist = landmarks[0];
                    const middleFingerTip = landmarks[12];

                    // Xåæ ‡ (é•œåƒå: 0å·¦ -> 1å³)
                    const handX = wrist.x; 
                    const handY = wrist.y;

                    // æ‰‹çš„å¤§å° (æ¨¡æ‹Ÿè·ç¦»)
                    const dx = middleFingerTip.x - wrist.x;
                    const dy = middleFingerTip.y - wrist.y;
                    const handSize = Math.sqrt(dx*dx + dy*dy); // çº¦ 0.1(è¿œ) - 0.5(è¿‘)

                    // === åˆ†åœºæ™¯å¤„ç† ===

                    // 1. åœ£è¯è€äººé¡µï¼šæ£€æµ‹æŒ¥æ‰‹
                    if (this.state.currentView === 'santa') {
                        this.detectWave(handX, handY);
                    }

                    // 2. AR é¡µï¼šæ§åˆ¶æ ‘
                    else if (this.state.currentView === 'ar') {
                        guide.style.opacity = 0.3; // æ­£åœ¨æ§åˆ¶ï¼Œæ·¡åŒ–æç¤º

                        // æ—‹è½¬: å·¦(0) -> -60deg, å³(1) -> 60deg
                        const rotateY = (handX - 0.5) * 140; 

                        // å€¾æ–œ (å¯é€‰): ä¸Šä¸‹ç§»åŠ¨æ§åˆ¶Xè½´
                        const rotateX = (0.6 - handY) * 30;

                        // ç¼©æ”¾: handSize 0.2 ä¸ºåŸºå‡†
                        let scale = handSize / 0.2;
                        scale = Math.min(Math.max(scale, 0.7), 1.6); // é™åˆ¶èŒƒå›´

                        treeImg.style.transform = `scale(${scale.toFixed(2)}) rotateX(${rotateX.toFixed(0)}deg) rotateY(${rotateY.toFixed(0)}deg)`;
                    }

                } else {
                    // æ²¡æœ‰æ£€æµ‹åˆ°æ‰‹
                    if (this.state.currentView === 'ar') {
                        guide.style.opacity = 1;
                        // ç¼“åŠ¨å¤ä½
                        treeImg.style.transform = "scale(1) rotateY(0deg)";
                    }
                    if (this.state.currentView === 'santa') {
                        santaHint.innerText = "ğŸ‘‹ æŠŠæ‰‹ä¸¾åˆ°ç”»é¢é‡Œï¼ŒæŒ¥ä¸€æŒ¥ï¼";
                    }
                }
            },

            // æ£€æµ‹æŒ¥æ‰‹é€»è¾‘
            detectWave(x, y) {
                const now = Date.now();
                if (!this.state.lastHandPos) {
                    this.state.lastHandPos = {x, y, time: now};
                    return;
                }

                const deltaT = now - this.state.lastHandPos.time;
                if (deltaT > 500) { // è¶…è¿‡0.5ç§’é‡ç½®
                    this.state.lastHandPos = {x, y, time: now};
                    return;
                }

                // è®¡ç®—é€Ÿåº¦
                const dist = Math.abs(x - this.state.lastHandPos.x) + Math.abs(y - this.state.lastHandPos.y);
                const speed = dist / deltaT * 1000; // units per sec

                if (speed > 0.5) { // é˜ˆå€¼
                    this.state.waveCount++;
                    const hint = document.getElementById('santa-hint');
                    hint.innerText = `ğŸ‘‹ çœ‹åˆ°ä½ äº†ï¼å†æŒ¥æŒ¥ï¼(${this.state.waveCount}/15)`;

                    // ç®€å•çš„è§†è§‰åé¦ˆ
                    document.getElementById('santa-story-img').style.transform = `scale(1.1) rotate(${Math.random()*10-5}deg)`;

                    if (this.state.waveCount > 15) {
                        this.state.waveCount = 0;
                        this.finishSantaScene();
                    }
                }
                this.state.lastHandPos = {x, y, time: now};
            },

            // --- æµç¨‹æ§åˆ¶ ---

            startCamera() {
                if (!this.state.cameraActive) {
                    document.getElementById('mp-loader').style.display = 'block';
                    this.cameraUtils.start();
                    this.state.cameraActive = true;
                }
            },

            stopCamera() {
                // MediaPipe çš„ CameraUtils å¾ˆéš¾å®Œå…¨åœæ­¢ï¼Œè¿™é‡Œä¸»è¦é€šè¿‡æ§åˆ¶é€»è¾‘ä¸å¤„ç† onResults
                // å¹¶éšè— video å…ƒç´ 
                // this.cameraUtils.stop(); // å¯é€‰ï¼Œè§†åº“ç‰ˆæœ¬æ”¯æŒ
            },

            switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                this.state.currentView = viewId.replace('view-', '');

                // åªæœ‰ Santa å’Œ AR éœ€è¦æ‘„åƒå¤´
                if (this.state.currentView === 'santa' || this.state.currentView === 'ar') {
                    this.startCamera();
                }
            },

            // 1. ç™»å½•
            handleLogin() {
                const btn = document.querySelector('#view-login .btn-gold');
                btn.innerText = "æ­£åœ¨éªŒè¯...";
                setTimeout(() => {
                    btn.innerText = "ç™»å½•æˆåŠŸ";
                    setTimeout(() => this.switchView('view-hero'), 800);
                }, 1000);
            },

            // 2. é€‰è§’
            handleTreeClick() {
                if (this.state.treeUnlocked) {
                    this.showModal("å·²è§£é”", "å†æ¬¡ä½“éªŒæ‚¬æµ®é‡‘æ ‘ï¼Ÿ", [
                        { text: "å–æ¶ˆ", action: () => this.closeModal() },
                        { text: "è¿›å…¥ AR", action: () => { this.closeModal(); this.startArScene(); } }
                    ]);
                } else {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±ç¤¼ç‰©ï¼Ÿ", [
                        { text: "ç›´æ¥ä½“éªŒ", action: () => { this.closeModal(); this.startArScene(); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            // 3. å®šåˆ¶
            confirmWish() {
                if(!document.getElementById('wish-input').value) return this.toast('è¯·è¾“å…¥ç¥ç¦');
                this.startSantaScene();
            },

            // 4. åœ£è¯è€äºº
            startSantaScene() {
                this.switchView('view-santa');
                this.state.waveCount = 0;
                const img = document.getElementById('santa-story-img');
                img.classList.remove('santa-appear');
                setTimeout(() => img.classList.add('santa-appear'), 100);
            },

            finishSantaScene() {
                // é˜²æ­¢é‡å¤è§¦å‘
                if(this.state.currentView !== 'santa') return;

                const hint = document.getElementById('santa-hint');
                hint.innerText = "ğŸ åœ£è¯è€äººæ”¶åˆ°ä¿¡å·äº†ï¼ç¤¼ç‰©æ´¾é€ä¸­...";
                hint.style.color = "var(--gold)";

                const gift = document.getElementById('flying-gift');
                gift.style.transition = "all 0.8s ease-in";
                gift.style.opacity = 1;
                gift.style.transform = "translate(-50%, -50%) scale(20)";

                setTimeout(() => {
                    document.body.style.background = "#000";
                    setTimeout(() => {
                        gift.style.display = 'none';
                        gift.style.transform = "translate(-50%, -50%) scale(0)";
                        document.body.style.background = "";
                        this.startArScene();
                    }, 500);
                }, 800);
            },

            // 5. AR
            startArScene() {
                this.switchView('view-ar');
                const tree = document.getElementById('ar-tree-img');
                const timer = document.getElementById('ar-timer');

                // å…¥åœºåŠ¨ç”»
                tree.style.transform = "scale(0) rotateY(0deg)";
                setTimeout(() => {
                    tree.style.transform = "scale(1) rotateY(0deg)";
                }, 500);

                // å€’è®¡æ—¶
                let t = 12;
                timer.innerText = "12s";
                this.arTimer = setInterval(() => {
                    if (this.state.currentView !== 'ar') return clearInterval(this.arTimer);
                    t--;
                    timer.innerText = t + "s";
                    if (t <= 0) {
                        clearInterval(this.arTimer);
                        this.explodeTree();
                    }
                }, 1000);
            },

            explodeTree() {
                const treeImg = document.getElementById('ar-tree-img');
                const rect = treeImg.getBoundingClientRect();

                // é«˜äº®
                treeImg.style.transition = "0.2s";
                treeImg.style.filter = "brightness(5) drop-shadow(0 0 80px gold)";

                setTimeout(() => {
                    treeImg.style.opacity = 0;
                    this.spawnExplosion(rect.left + rect.width/2, rect.top + rect.height/2);

                    setTimeout(() => {
                        this.state.treeUnlocked = true;
                        document.getElementById('card-tree').classList.replace('locked', 'unlocked');
                        document.querySelector('#card-tree .lock-tag').style.display = 'none';

                        this.toast("ğŸ‰ ä½“éªŒå®Œæˆï¼åœ£è¯æ ‘å·²æ°¸ä¹…è§£é”ï¼", 3000);
                        this.switchView('view-hero');

                        // æ¢å¤æ ‘çŠ¶æ€
                        setTimeout(() => {
                            treeImg.style.opacity = 1;
                            treeImg.style.filter = "drop-shadow(0 0 40px rgba(255, 215, 0, 0.8)) brightness(1.1)";
                        }, 1000);
                    }, 1500);
                }, 300);
            },

            // --- è¾…åŠ©åŠŸèƒ½ ---
            toast(msg) { console.log(msg); alert(msg); },
            showModal(t, c, btns) {
                document.getElementById('modal-title').innerText = t;
                document.getElementById('modal-content').innerText = c;
                const g = document.getElementById('modal-btns'); g.innerHTML = '';
                btns.forEach(b => {
                    const btn = document.createElement('button'); btn.className = 'btn-outline';
                    btn.innerText = b.text; btn.onclick = b.action; g.appendChild(btn);
                });
                document.getElementById('modal').style.display = 'flex';
                setTimeout(() => document.getElementById('modal-box').classList.add('show'), 10);
            },
            closeModal() {
                document.getElementById('modal-box').classList.remove('show');
                setTimeout(() => document.getElementById('modal').style.display = 'none', 300);
            },
            spawnExplosion(x, y) {
                const layer = document.getElementById('explosion-layer');
                for(let i=0; i<60; i++) {
                    const p = document.createElement('div'); p.className = 'boom-particle';
                    const s = Math.random()*8 + 3;
                    p.style.cssText = `width:${s}px; height:${s}px; left:${x}px; top:${y}px;`;
                    layer.appendChild(p);
                    const angle = Math.random()*6.28; const v = Math.random()*200 + 80;
                    p.animate([
                        {transform: 'translate(0,0) scale(1)', opacity:1},
                        {transform: `translate(${Math.cos(angle)*v}px, ${Math.sin(angle)*v}px) scale(0)`, opacity:0}
                    ], {duration: 800+Math.random()*600}).onfinish = () => p.remove();
                }
            },
            initParticles() {
                const cvs = document.getElementById('particle-canvas');
                const ctx = cvs.getContext('2d');
                let w, h; const resize = () => { w = cvs.width = window.innerWidth; h = cvs.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();

    
