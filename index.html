<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR æ‹›è´¢çŒ« 2025</title>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin:0; padding:0; overflow:hidden; background:black; font-family:"Microsoft YaHei"; }
        #input-video {
            position: fixed; top: 16px; right: 16px; width: 100px;
            border-radius: 10px; border: 2px solid rgba(255,215,0,0.5);
            transform: scaleX(-1); z-index: 20; opacity: 0.8;
        }
        #three-canvas { width:100%; height:100%; display:block; }
        #ui-layer { 
            position:absolute; top:0; left:0; width:100%; height:100%;
            z-index:15; pointer-events:none; display:flex; flex-direction:column; align-items:center;
        }
        #status-pill {
            margin-top:40px; padding:8px 20px; border-radius:30px;
            background:rgba(20,20,20,0.8); border:1px solid rgba(255,215,0,0.4);
            color:#FFD700; font-weight:bold; font-size:14px;
            display:flex; gap:10px; align-items:center;
        }
        #guide-panel {
            position:absolute; bottom:40px; display:flex; gap:20px;
            background:rgba(0,0,0,0.7); padding:12px 24px; border-radius:16px; border:1px solid rgba(255,255,255,0.1);
        }
        .guide-item { text-align:center; color:rgba(255,255,255,0.8); font-size:12px; }
        .guide-icon { font-size:24px; display:block; margin-bottom:4px; }

        #loading {
            position:absolute; top:0; left:0; width:100%; height:100%; background:black; z-index:200;
            display:flex; flex-direction:column; justify-content:center; align-items:center; color:#FFD700;
        }
        .spinner {
            width:40px; height:40px; border:3px solid #333; border-top:3px solid #FFD700;
            border-radius:50%; animation:spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
</head>

<body>

    <video id="input-video" playsinline></video>
    <canvas id="three-canvas"></canvas>

    <div id="ui-layer">
        <div id="status-pill">
            <span id="gesture-icon">ğŸ‘€</span>
            <span id="gesture-text">å¯»æ‰¾æ‰‹åŠ¿...</span>
        </div>

        <div id="guide-panel">
            <div class="guide-item"><span class="guide-icon">âœŠ</span>æŠ“å–æ”¾å¤§</div>
            <div class="guide-item"><span class="guide-icon">ğŸ–</span>å¼ å¼€ç¼©å°</div>
            <div class="guide-item"><span class="guide-icon">âœŒï¸</span>Victoryæ—‹è½¬</div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <div style="margin-top:15px">åŠ è½½æ‹›è´¢çŒ«æ¨¡å‹ä¸­...</div>
    </div>

    <!-- éšè—å›¾ç‰‡èµ„æº -->
    <div style="display:none">
        <img id="img-santa" src="./ChatGPT Image Dec 1, 2025_09_36_29 PM.png">
        <img id="img-tree" src="./ChatGPT Image Dec 1, 2025_10_09_26 PM.png">
    </div>

    <script type="module">
        import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";
        import { GLTFLoader } from "https://unpkg.com/three@0.158.0/examples/jsm/loaders/GLTFLoader.js";

        let scene, camera, renderer, catModel;
        let targetScale = 1, targetRotationY = 0;

        // === THREE åˆå§‹åŒ– ===
        function initThree() {
            const canvas = document.getElementById("three-canvas");

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            scene = new THREE.Scene();
            scene.background = new THREE.Color("#000");

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1, 6);

            const amb = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 1.2);
            dir.position.set(3,5,5);
            scene.add(dir);

            loadCatModel();
            animate();
        }

        // === åŠ è½½æ‹›è´¢çŒ«æ¨¡å‹ ===
        function loadCatModel() {
            const loader = new GLTFLoader();

            loader.load(
                "./cutecat01.glb",
                (gltf) => {
                    catModel = gltf.scene;
                    catModel.scale.set(2,2,2);
                    catModel.position.set(0, -1, 0);
                    scene.add(catModel);

                    document.getElementById("loading").style.display = "none";
                },
                undefined,
                (err) => {
                    alert("âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å cutecat01.glb");
                    console.error(err);
                }
            );
        }

        // === æ¸²æŸ“å¾ªç¯ ===
        function animate() {
            requestAnimationFrame(animate);

            if (catModel) {
                catModel.rotation.y += (targetRotationY - catModel.rotation.y) * 0.08;
                const s = catModel.scale.x;
                const ns = s + (targetScale - s) * 0.1;
                catModel.scale.set(ns, ns, ns);
            }

            renderer.render(scene, camera);
        }

        // === æ‰‹åŠ¿æ£€æµ‹ ===
        function detectGesture(lm) {
            const dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
            const palm = dist(lm[0], lm[9]);

            const fingerOpen = (tip, base) => dist(lm[tip], lm[0]) > palm * 1.1;

            const index = fingerOpen(8, 5);
            const middle = fingerOpen(12, 9);
            const ring = fingerOpen(16, 13);
            const pinky = fingerOpen(20, 17);

            const openCount = [index, middle, ring, pinky].filter(Boolean).length;

            if (openCount >= 3) return "OPEN";
            if (openCount === 0) return "FIST";
            if (index && middle && !ring) return "VICTORY";
            return "NEUTRAL";
        }

        // === MediaPipe Hands ===
        window.onload = () => {
            const video = document.getElementById("input-video");
            const hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
            hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.6 });

            hands.onResults(res => {
                if (!res.multiHandLandmarks.length) {
                    document.getElementById("gesture-icon").innerText = "ğŸ‘€";
                    document.getElementById("gesture-text").innerText = "å¯»æ‰¾æ‰‹åŠ¿...";
                    return;
                }

                const lm = res.multiHandLandmarks[0];
                const g = detectGesture(lm);

                const icon = document.getElementById("gesture-icon");
                const text  = document.getElementById("gesture-text");

                if (g === "FIST") {
                    icon.innerText = "âœŠ"; text.innerText = "æŠ“å–æ”¾å¤§";
                    targetScale = 1.6;
                }
                else if (g === "OPEN") {
                    icon.innerText = "ğŸ–"; text.innerText = "å¼ å¼€ç¼©å°";
                    targetScale = 0.8;
                }
                else if (g === "VICTORY") {
                    icon.innerText = "âœŒï¸"; text.innerText = "æ—‹è½¬æ¨¡å¼";
                    targetRotationY = Math.sin(Date.now()*0.001)*2;
                }
                else {
                    icon.innerText = "âœ‹"; text.innerText = "ä¿æŒå§¿åŠ¿";
                    targetScale = 1.0;
                }
            });

            const cam = new Camera(video, {
                onFrame: async () => await hands.send({ image: video }),
                width: 640, height: 480
            });
            cam.start();

            initThree();
        };
    </script>
</body>
</html>

