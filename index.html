<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden Christmas AR - Vision Hand Control</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* =========================================
           å…¨å±€æ ·å¼ (ä¿æŒæš—é»‘é‡‘é£æ ¼)
           ========================================= */
        :root {
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            overflow: hidden; color: var(--gold); user-select: none;
        }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* è§†å›¾å®¹å™¨ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.5s ease;
            background: rgba(0,0,0,0.3);
        }
        .view-section.active { display: flex; opacity: 1; }

        /* é€šç”¨æŒ‰é’® */
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: none; color: #000; padding: 12px 30px; font-size: 16px; font-weight: bold;
            border-radius: 25px; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s; margin-top: 20px; width: 80%; max-width: 200px;
        }
        .btn-gold:active { transform: scale(0.95); }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 20px; font-size: 14px; margin: 0 5px;
        }

        .input-gold {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: var(--gold);
            border-radius: 8px; text-align: center; font-size: 16px; outline: none;
        }

        /* =========================================
           ç‰¹å®šè§†å›¾æ ·å¼
           ========================================= */
        
        /* ç™»å½•é¡µ */
        .login-panel {
            width: 85%; max-width: 320px; padding: 30px 20px;
            background: var(--glass-bg); border: 1px solid var(--gold); border-radius: 15px;
            text-align: center; backdrop-filter: blur(10px); position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .bg-anim-item { position: absolute; font-size: 40px; opacity: 0.6; pointer-events: none; }
        .anim-car { top: 70%; left: -100px; animation: driveBy 8s linear infinite; }
        .anim-tree { top: 20%; right: -100px; animation: floatBy 10s linear infinite; animation-delay: 2s; font-size: 50px; }
        @keyframes driveBy { 0% { opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(120vw); opacity:0; } }
        @keyframes floatBy { 0% { opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(-120vw) rotate(360deg); opacity:0; } }

        /* è‹±é›„é€‰æ‹©é¡µ */
        .hero-grid { display: flex; gap: 15px; justify-content: center; perspective: 1000px; }
        .hero-card {
            width: 90px; height: 150px; background: rgba(20,20,20,0.9); border: 1px solid #444;
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.3s; cursor: pointer; animation: cardFloat 3s ease-in-out infinite;
        }
        .hero-card:nth-child(2) { animation-delay: 0.5s; }
        @keyframes cardFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(1) brightness(0.5); }
        .hero-icon { font-size: 40px; margin-bottom: 10px; }
        .lock-tag { position: absolute; top: 5px; right: 5px; font-size: 12px; }

        /* åœ£è¯è€äººé¡µ */
        #santa-story-img {
            width: 90%; max-width: 400px; object-fit: contain; margin-bottom: 30px;
            filter: drop-shadow(0 0 30px var(--gold)); transform: scale(0.8); opacity: 0;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .santa-appear { transform: scale(1.1) !important; opacity: 1 !important; }
        .shake-alert { color: #ff3333; font-size: 22px; font-weight: bold; text-align: center; animation: pulseFast 0.5s infinite; }
        @keyframes pulseFast { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }

        /* =========================================
           AR æ ¸å¿ƒåœºæ™¯ (Vision Control)
           ========================================= */
        /* å‰ç½®æ‘„åƒå¤´é•œåƒæ˜¾ç¤º */
        #ar-camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2; transform: scaleX(-1); background: #000;
        }
        
        /* æ ‘å®¹å™¨ */
        #ar-tree-container {
            position: relative; width: 300px; height: 400px;
            perspective: 1200px; transform-style: preserve-3d;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* å¢åŠ å¹³æ»‘åº¦ */
            transform: scale(0) rotateY(0deg); opacity: 0;
        }

        #ar-tree-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 40px var(--gold-glow)) brightness(1.1);
            pointer-events: none; will-change: transform;
        }

        /* æ ‘å‘¨å›´çš„åŠ¨æ€å…‰æ™• */
        .tree-aura {
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            transform: translate(-50%, -50%); border-radius: 50%;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.3); pointer-events: none; z-index: -1;
            animation: auraPulse 3s infinite;
        }
        @keyframes auraPulse { 0%,100%{opacity:0.5; transform:translate(-50%,-50%) scale(0.8);} 50%{opacity:0.8; transform:translate(-50%,-50%) scale(1.1);} }

        /* UI */
        .ar-ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px 20px;
        }
        .ar-timer { align-self: flex-end; font-size: 36px; font-weight: 800; text-shadow: 0 0 10px #000; }
        
        .ar-guide {
            align-self: center; text-align: center; background: rgba(0,0,0,0.6);
            padding: 15px; border-radius: 12px; border: 1px solid var(--gold-glow);
            animation: floatGuide 2s infinite ease-in-out; min-width: 250px;
        }
        @keyframes floatGuide { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .guide-icon { font-size: 24px; display: block; margin-bottom: 5px; }

        /* å¼¹çª—ä¸ç‰¹æ•ˆ */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-body {
            background: var(--glass-bg); border: 1px solid var(--gold);
            padding: 30px; border-radius: 15px; text-align: center; width: 85%;
            box-shadow: 0 0 40px var(--gold-glow); transform: scale(0.9); transition: 0.3s;
        }
        .modal-body.show { transform: scale(1); }

        #flying-gift {
            position: fixed; top: 50%; left: 50%; font-size: 100px; z-index: 200;
            transform: translate(-50%, -50%) scale(0); pointer-events: none;
        }
        #explosion-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .boom-particle { position: absolute; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold-glow); }

        /* MediaPipe Loading */
        #mp-loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            color: var(--gold); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            display: none; z-index: 50;
        }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <section id="view-login" class="view-section active">
        <div class="bg-anim-item anim-car">ğŸï¸</div>
        <div class="bg-anim-item anim-tree">ğŸ„</div>
        <div class="login-panel">
            <h2 style="margin-top:0; text-shadow: 0 0 10px var(--gold);">VIP ACCESS</h2>
            <input type="tel" class="input-gold" placeholder="æ‰‹æœºå·">
            <input type="text" class="input-gold" placeholder="éªŒè¯ç ">
            <button class="btn-gold" onclick="app.handleLogin()">ç«‹å³ç™»å½•</button>
        </div>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="margin-bottom:40px;">é€‰æ‹©ä½ çš„è‹±é›„</h2>
        <div class="hero-grid">
            <div class="hero-card unlocked" onclick="app.toast('å·²è£…å¤‡ï¼šé‡‘è‰²ç›èæ‹‰è’‚')">
                <div class="hero-icon">ğŸï¸</div>
                <div class="hero-name">é»„é‡‘ GT</div>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.handleTreeClick()">
                <div class="lock-tag">ğŸ”’</div>
                <div class="hero-icon">ğŸ„</div>
                <div class="hero-name">å¹»å½±æ ‘</div>
            </div>
            <div class="hero-card locked" onclick="app.toast('æ•¬è¯·æœŸå¾…')">
                <div class="hero-icon">â“</div>
                <div class="hero-name">ç¥ç§˜å˜‰å®¾</div>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ä½ çš„ç¥ç¦</h2>
        <input type="text" id="wish-input" class="input-gold" style="width:80%;" maxlength="20" placeholder="å†™ä¸‹ä½ çš„ç¥ç¦...">
        <button class="btn-gold" onclick="app.confirmWish()">ç¡®è®¤ç”Ÿæˆ</button>
    </section>

    <section id="view-santa" class="view-section">
        <img id="santa-story-img" src="image_2.png" alt="Santa">
        <div id="santa-hint" class="shake-alert">é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼</div>
        <button onclick="app.triggerShakeMock()" style="margin-top:30px; opacity:0.5; background:none; border:1px solid #fff; color:#fff;">(æ¨¡æ‹Ÿæ‘‡æ™ƒ)</button>
    </section>

    <section id="view-ar" class="view-section" style="background: #000;">
        <video id="ar-camera-feed" playsinline muted></video>
        
        <div id="ar-tree-container">
            <img id="ar-tree-img" src="image_0.png" alt="Golden AR Tree">
            <div class="tree-aura"></div>
        </div>

        <div class="ar-ui-overlay">
            <div id="ar-timer" class="ar-timer">12s</div>
            <div id="mp-loader">ğŸ–ï¸ æ­£åœ¨å¯åŠ¨æ‰‹åŠ¿è¯†åˆ«å¼•æ“...</div>
            <div class="ar-guide" id="ar-guide-box">
                <span class="guide-icon">ğŸ‘‹</span>
                <span style="color:var(--gold); font-weight:bold;">æŠŠæ‰‹æ”¾å…¥ç”»é¢ä¸­</span><br>
                <div style="font-size:12px; margin-top:5px; text-align:left; display:inline-block;">
                â†”ï¸ å·¦å³ç§»åŠ¨æ‰‹æŒ = æ—‹è½¬<br>
                â†•ï¸ æ‰‹æŒé è¿‘é•œå¤´ = æ”¾å¤§
                </div>
                <div style="font-size:10px; opacity:0.6; margin-top:8px;">(ä»…è¯†åˆ«æ‰‹åŠ¿ï¼Œä¸å­˜å‚¨äººè„¸æ•°æ®)</div>
            </div>
        </div>
    </section>

    <div id="flying-gift">ğŸ</div>
    <div id="explosion-layer"></div>

    <div id="modal" class="modal-mask">
        <div class="modal-body" id="modal-box">
            <h3 id="modal-title" style="color:var(--gold);">æç¤º</h3>
            <p id="modal-content" style="color:#ccc;">å†…å®¹</p>
            <div id="modal-btns" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                treeUnlocked: false,
                passedSantaFlow: false,
                shakeCount: 0,
                isArRunning: false,
                mpLoaded: false
            },
            hands: null,
            camera: null,
            lastTransform: "scale(1) rotateY(0deg)",

            init() {
                this.initParticles();
                this.initMediaPipe(); // é¢„åŠ è½½ MediaPipe
                console.log("App Initialized with MediaPipe.");
            },

            // --- MediaPipe åˆå§‹åŒ– ---
            initMediaPipe() {
                // é…ç½® MediaPipe Hands
                this.hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});
                
                this.hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.hands.onResults(this.onHandResults.bind(this));
            },

            // --- æ ¸å¿ƒï¼šæ‰‹åŠ¿è¯†åˆ«å›è°ƒ ---
            onHandResults(results) {
                if (!this.state.isArRunning) return;

                const tree = document.getElementById('ar-tree-container');
                const guide = document.getElementById('ar-guide-box');
                const loader = document.getElementById('mp-loader');
                
                // éšè—åŠ è½½çŠ¶æ€
                if(loader.style.display !== 'none') loader.style.display = 'none';

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    // æ£€æµ‹åˆ°æ‰‹
                    const landmarks = results.multiHandLandmarks[0];
                    guide.style.opacity = '0.3'; // æ·¡åŒ–æç¤º

                    // 1. è®¡ç®—æ‰‹éƒ¨ä¸­å¿ƒ X åæ ‡ (0-1)
                    // ä½¿ç”¨æ‰‹è…•(0)å’Œä¸­æŒ‡æ ¹éƒ¨(9)çš„å¹³å‡å€¼
                    const wrist = landmarks[0];
                    const middleRoot = landmarks[9];
                    const middleTip = landmarks[12];
                    
                    // æ³¨æ„ï¼šMediaPipe åæ ‡åœ¨è‡ªæ‹é•œåƒæ¨¡å¼ä¸‹ï¼Œx=0 æ˜¯ç”»é¢å·¦è¾¹ï¼ˆç”¨æˆ·å³è¾¹ï¼‰
                    // æˆ‘ä»¬çš„ CSS flip äº† videoï¼Œæ‰€ä»¥è§†è§‰ä¸Šæ˜¯ä¸€è‡´çš„ã€‚
                    // ä½†æ˜¯é€»è¾‘ä¸Šï¼šhandX 0->1ï¼Œæˆ‘ä»¬å¸Œæœ› rotate -60 -> 60
                    const handX = (wrist.x + middleRoot.x) / 2;
                    
                    // æ˜ å°„æ—‹è½¬: 0(å·¦) -> -60deg, 1(å³) -> 60deg
                    // åè½¬ç³»æ•°ï¼Œè®©ç§»åŠ¨æ–¹å‘ç¬¦åˆç›´è§‰ï¼ˆæ‰‹å¾€å³ç§»ï¼Œæ ‘å¾€å³è½¬ï¼‰
                    const rotateY = (0.5 - handX) * 140; 

                    // 2. è®¡ç®—æ‰‹çš„å¤§å° (æ¨¡æ‹Ÿè·ç¦»)
                    // è®¡ç®—æ‰‹è…•åˆ°ä¸­æŒ‡å°–çš„è·ç¦»
                    const dx = middleTip.x - wrist.x;
                    const dy = middleTip.y - wrist.y;
                    const dist = Math.sqrt(dx*dx + dy*dy); // èŒƒå›´å¤§æ¦‚åœ¨ 0.1 (è¿œ) åˆ° 0.5 (è¿‘)

                    // æ˜ å°„ç¼©æ”¾: è·ç¦»å¤§(è¿‘) -> æ”¾å¤§
                    // åŸºå‡† distance çº¦ 0.25
                    let scale = (dist / 0.25);
                    scale = Math.min(Math.max(scale, 0.7), 1.6); // é™åˆ¶èŒƒå›´ [0.7, 1.6]

                    // æ›´æ–° Transform
                    this.lastTransform = `scale(${scale.toFixed(2)}) rotateY(${rotateY.toFixed(1)}deg)`;
                    tree.style.transform = this.lastTransform;

                } else {
                    // æœªæ£€æµ‹åˆ°æ‰‹ï¼Œä¿æŒæœ€åçŠ¶æ€æˆ–å¤ä½
                    guide.style.opacity = '1';
                    // tree.style.transform = this.lastTransform; // ä¿æŒä¸åŠ¨
                    // æˆ–è€…ç¼“æ…¢å¤ä½ï¼š
                    // tree.style.transform = "scale(1) rotateY(0deg)";
                }
            },

            // --- è§†å›¾åˆ‡æ¢ ---
            switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId !== 'view-ar') this.stopCamera();
            },

            // --- ä¸šåŠ¡æµç¨‹ ---
            handleLogin() {
                const btn = document.querySelector('#view-login .btn-gold');
                btn.innerText = "æ­£åœ¨éªŒè¯...";
                setTimeout(() => {
                    btn.innerText = "ç™»å½•æˆåŠŸ";
                    setTimeout(() => this.switchView('view-hero'), 800);
                }, 1000);
            },

            handleTreeClick() {
                if (this.state.treeUnlocked) {
                    this.showModal("å·²è§£é”", "å†æ¬¡ä½“éªŒ AR ç‰¹æ•ˆï¼Ÿ", [
                        { text: "å–æ¶ˆ", action: () => this.closeModal() },
                        { text: "è¿›å…¥ AR", action: () => { this.closeModal(); this.startArFlow(); } }
                    ]);
                } else {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±ç¤¼ç‰©ï¼Ÿ", [
                        { text: "ç›´æ¥ä½“éªŒ", action: () => { this.closeModal(); this.startArFlow(); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            confirmWish() {
                const val = document.getElementById('wish-input').value;
                if(!val) return this.toast('è¯·è¾“å…¥ç¥ç¦');
                this.startSantaFlow();
            },

            // --- åœ£è¯è€äºº ---
            startSantaFlow() {
                this.switchView('view-santa');
                const img = document.getElementById('santa-story-img');
                const hint = document.getElementById('santa-hint');
                this.state.shakeCount = 0;
                img.classList.remove('santa-appear');
                hint.className = 'shake-alert'; hint.innerText = "é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼";
                setTimeout(() => img.classList.add('santa-appear'), 100);

                this.shakeHandler = (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if(acc && (Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z)) > 25) this.handleShake(1);
                };
                window.addEventListener('devicemotion', this.shakeHandler);
            },
            triggerShakeMock() { this.handleShake(2); },
            handleShake(n) {
                this.state.shakeCount += n;
                document.getElementById('santa-story-img').style.transform = `scale(1.15) rotate(${Math.random()*10-5}deg)`;
                if(this.state.shakeCount > 8) {
                    window.removeEventListener('devicemotion', this.shakeHandler);
                    this.finishSanta();
                }
            },
            finishSanta() {
                document.getElementById('santa-hint').style.color = 'gold';
                document.getElementById('santa-hint').innerText = "æ”¶åˆ°ä¿¡å·ï¼ç¤¼ç‰©æ´¾é€ä¸­...";
                const gift = document.getElementById('flying-gift');
                gift.style.transition = "all 0.8s ease"; gift.style.opacity=1; gift.style.transform="translate(-50%,-50%) scale(20)";
                setTimeout(() => {
                    document.body.style.background="#000";
                    setTimeout(() => {
                        gift.style.display='none'; document.body.style.background="";
                        this.state.passedSantaFlow = true;
                        this.startArFlow();
                    }, 500);
                }, 800);
            },

            // --- AR æµç¨‹ (é›†æˆ MediaPipe) ---
            async startArFlow() {
                this.switchView('view-ar');
                this.state.isArRunning = true;
                const videoElement = document.getElementById('ar-camera-feed');
                const tree = document.getElementById('ar-tree-container');
                const timer = document.getElementById('ar-timer');
                const loader = document.getElementById('mp-loader');

                // æ˜¾ç¤ºåŠ è½½æç¤º
                loader.style.display = 'block';

                // 1. å¯åŠ¨æ‘„åƒå¤´ (ä½¿ç”¨åŸç”Ÿ getUserMedia ä»¥ä¾¿å®Œå…¨æ§åˆ¶)
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 }, // é™åˆ¶åˆ†è¾¨ç‡æé«˜ MediaPipe æ€§èƒ½
                            height: { ideal: 480 }
                        }, 
                        audio: false 
                    });
                    videoElement.srcObject = stream;
                    await videoElement.play();
                } catch (e) {
                    console.error(e);
                    this.toast("æ— æ³•å¼€å¯æ‘„åƒå¤´");
                    loader.innerText = "æ‘„åƒå¤´å¼€å¯å¤±è´¥";
                    return;
                }

                // 2. æ ‘å…¥åœº
                tree.style.opacity = 1; 
                tree.style.transform = "scale(1) rotateY(0deg)";

                // 3. å¯åŠ¨ MediaPipe å¸§å¾ªç¯
                // ä½¿ç”¨ send æ–¹æ³•æ‰‹åŠ¨å‘é€è§†é¢‘å¸§
                const sendFrame = async () => {
                    if (!this.state.isArRunning) return;
                    if (videoElement.readyState >= 2) {
                        await this.hands.send({image: videoElement});
                    }
                    requestAnimationFrame(sendFrame);
                };
                sendFrame();

                // 4. å€’è®¡æ—¶
                let t = 12;
                timer.innerText = "12s";
                this.arTimer = setInterval(() => {
                    if(!this.state.isArRunning) return clearInterval(this.arTimer);
                    t--; timer.innerText = t+"s";
                    if(t<=0) {
                        clearInterval(this.arTimer);
                        this.explodeTree();
                    }
                }, 1000);
            },

            stopCamera() {
                this.state.isArRunning = false;
                const v = document.getElementById('ar-camera-feed');
                if(v.srcObject) {
                    v.srcObject.getTracks().forEach(t=>t.stop());
                    v.srcObject = null;
                }
            },

            explodeTree() {
                const treeImg = document.getElementById('ar-tree-img');
                const rect = treeImg.getBoundingClientRect();
                treeImg.style.transition = "0.2s"; treeImg.style.filter = "brightness(5) drop-shadow(0 0 50px gold)";
                setTimeout(() => {
                    treeImg.style.opacity = 0;
                    this.spawnExplosion(rect.left+rect.width/2, rect.top+rect.height/2);
                    this.stopCamera();
                    setTimeout(() => this.finishAr(), 1500);
                }, 300);
            },

            finishAr() {
                if(this.state.passedSantaFlow) {
                    this.state.treeUnlocked = true;
                    document.getElementById('card-tree').classList.replace('locked','unlocked');
                    document.querySelector('#card-tree .lock-tag').style.display='none';
                    this.toast("ğŸ‰ ä½“éªŒå®Œæˆï¼åœ£è¯æ ‘å·²æ°¸ä¹…è§£é”ï¼", 3000);
                    this.switchView('view-hero');
                    this.state.passedSantaFlow = false;
                } else {
                    this.showModal("ä½“éªŒç»“æŸ", "æƒ³æ°¸ä¹…æ‹¥æœ‰å®ƒå—ï¼Ÿ", [
                        { text: "å›ä¸»é¡µ", action: () => { this.closeModal(); this.switchView('view-hero'); }},
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); }}
                    ]);
                }
                // æ¢å¤æ ‘
                setTimeout(() => {
                    document.getElementById('ar-tree-img').style.opacity=1;
                    document.getElementById('ar-tree-img').style.filter="";
                }, 1000);
            },

            // --- è¾…åŠ© ---
            toast(msg) { console.log(msg); alert(msg); },
            showModal(t,c,btns) {
                document.getElementById('modal-title').innerText=t;
                document.getElementById('modal-content').innerText=c;
                const g = document.getElementById('modal-btns'); g.innerHTML='';
                btns.forEach(b=>{
                    const btn=document.createElement('button'); btn.className='btn-outline';
                    btn.innerText=b.text; btn.onclick=b.action; g.appendChild(btn);
                });
                document.getElementById('modal').style.display='flex';
                setTimeout(()=>document.getElementById('modal-box').classList.add('show'),10);
            },
            closeModal() {
                document.getElementById('modal-box').classList.remove('show');
                setTimeout(()=>document.getElementById('modal').style.display='none',300);
            },
            initParticles() {
                const cvs = document.getElementById('particle-canvas');
                const ctx = cvs.getContext('2d');
                let w,h; const resize=()=>{w=cvs.width=window.innerWidth;h=cvs.height=window.innerHeight;};
                window.addEventListener('resize',resize); resize();
                const p = Array.from({length:50},()=>({x:Math.random()*w,y:Math.random()*h,s:Math.random()*2,v:Math.random()*0.5+0.2}));
                const draw=()=>{
                    ctx.clearRect(0,0,w,h); ctx.fillStyle="rgba(255,215,0,0.5)";
                    p.forEach(i=>{i.y-=i.v;if(i.y<0)i.y=h;ctx.beginPath();ctx.arc(i.x,i.y,i.s,0,6.28);ctx.fill();});
                    requestAnimationFrame(draw);
                };
                draw();
            },
            spawnExplosion(x,y) {
                const layer = document.getElementById('explosion-layer');
                for(let i=0;i<60;i++) {
                    const d = document.createElement('div'); d.className='boom-particle';
                    const s = Math.random()*8+3;
                    d.style.cssText=`width:${s}px;height:${s}px;left:${x}px;top:${y}px;`;
                    layer.appendChild(d);
                    const a = Math.random()*6.28; const v = Math.random()*200+80;
                    d.animate([
                        {transform:'translate(0,0) scale(1)', opacity:1},
                        {transform:`translate(${Math.cos(a)*v}px,${Math.sin(a)*v}px) scale(0)`, opacity:0}
                    ], {duration:800+Math.random()*600, easing:'cubic-bezier(0,.9,.57,1)'}).onfinish=()=>d.remove();
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
