<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden AR Interaction</title>
    <link rel="stylesheet" href="/src/styles/style.css">
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm"
        }
    }
    </script>

    <style>
        /* ==================== 1. åŸºç¡€èƒŒæ™¯ ==================== */
        #landing-page {
            background-image: url('/assets/images/landing-bg.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent !important; 
        }
        .landing-title {
            background: linear-gradient(to bottom, #d4a017 0%, #8a6e0b 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: none !important;
        }
        .product-card {
            background: rgba(255, 255, 255, 0.4) !important;
            border: 1px solid rgba(212, 160, 23, 0.3) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05) !important;
        }
        .product-card p { color: #555 !important; }
        .product-card.active {
            background: rgba(255, 255, 255, 0.8) !important;
            border-color: #B8860B !important;
            transform: translateY(-5px) scale(1.05);
        }
        #landing-page p { color: #666 !important; text-shadow: none !important; }

        /* ==================== 2. è®¸æ„¿ä»ªå¼æ¨¡æ€æ¡† (é»‘é‡‘é£æ ¼) ==================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none; /* JS æ§åˆ¶æ˜¾ç¤º */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            width: 85%;
            max-width: 340px;
            background: rgba(30, 20, 10, 0.95); /* æ·±è‰²èƒŒæ™¯ */
            border: 1px solid #d4af37; /* é‡‘è‰²è¾¹æ¡† */
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
            color: #fff;
        }
        .modal-title {
            color: #d4af37;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        .modal-icon-area {
            font-size: 50px;
            margin-bottom: 20px;
        }
        .modal-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .modal-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #555;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            box-sizing: border-box;
            outline: none;
        }
        .upload-label {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 10px;
            display: block;
        }
        /* è™šçº¿ä¸Šä¼ æ¡† */
        .upload-box {
            width: 80px; height: 80px;
            border: 1px dashed #d4af37;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #d4af37;
            font-size: 30px;
            cursor: pointer;
            background: rgba(212, 175, 55, 0.05);
            position: relative;
            overflow: hidden;
        }
        .upload-box img {
            width: 100%; height: 100%; object-fit: cover;
            display: none;
        }
        .btn-group {
            display: flex; gap: 15px; margin-top: 30px;
        }
        .btn-cancel {
            flex: 1; background: transparent; border: 1px solid #666;
            color: #ccc; padding: 10px 0; border-radius: 25px; cursor: pointer;
        }
        .btn-confirm {
            flex: 1.5; background: linear-gradient(135deg, #b8860b, #ffd700);
            border: none; color: #000; padding: 10px 0;
            border-radius: 25px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <canvas id="main-canvas"></canvas>

    <section id="landing-page">
        <div class="landing-content">
            <h1 class="landing-title">âœ¨ è¯·é€‰æ‹©ä½ çš„é­”æ³• âœ¨</h1>
            <div id="product-showcase"></div>
            <p style="color: #aaa; font-size: 12px; margin: 15px 0;">ğŸ”Š è¯·æ‰“å¼€å£°éŸ³ä½“éªŒæœ€ä½³æ•ˆæœ</p>
            <button id="start-btn">å¼€å§‹åŠ è½½</button>
        </div>
    </section>

    <div id="wish-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">è®¸æ„¿ä»ªå¼</h3>
            <div class="modal-icon-area">ğŸ‚</div>
            
            <div class="modal-input-group">
                <input type="text" class="modal-input" placeholder="è¾“å…¥ç¥ç¦è¯­...">
            </div>

            <div class="modal-input-group">
                <span class="upload-label">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ (æœ€å¤š4å¼ ) <span id="upload-count">0/4</span></span>
                <input type="file" id="photo-input" multiple accept="image/*" style="display:none">
                <div class="upload-box" onclick="document.getElementById('photo-input').click()">
                    <span>+</span>
                    <img id="preview-thumb" src="">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-cancel" onclick="closeWishModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmWishStart()">ç«‹å³ç‚¹äº®</button>
            </div>
        </div>
    </div>

    <section id="view-ar" class="view-section">
        <div class="ar-ui-overlay">
            <div id="home-btn" class="glass-btn">ğŸ  ä¸»é¡µ</div>
            <div id="audio-btn" class="glass-btn" style="top: 80px;">ğŸ”Š å£°éŸ³</div>
            <div id="gesture-guide" class="glass-panel">
                <h3 id="guide-title">å‡†å¤‡å°±ç»ª</h3>
                <div id="guide-list"></div>
            </div>
        </div>
    </section>

    <div class="camera-widget" id="camera-box" style="display:none;"> 
        <video id="ar-camera-feed" muted playsinline></video>
        <div class="camera-toggle-btn" onclick="toggleCamera()">â–¼</div>
    </div>
    
    <div id="privacy-bar" class="privacy-toast" style="display: none;">
        <div class="privacy-content">ğŸ”’ éšç§ä¿æŠ¤ï¼šæ•°æ®æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼ ã€‚</div>
        <button id="privacy-ok" class="privacy-btn">çŸ¥é“äº†</button>
    </div>

    <script type="module" src="/src/main.js?v=final_deploy"></script>

    <script>
        function toggleCamera() {
            const box = document.getElementById('camera-box');
            box.classList.toggle('collapsed');
        }
        function closeWishModal() {
            document.getElementById('wish-modal').style.display = 'none';
        }
        // å ä½
        window.confirmWishStart = function() {}
    </script>
</body>
</html>
import { apiClient } from './logic/apiClient.js';

const canvas = document.querySelector('#main-canvas');
const startBtn = document.querySelector('#start-btn');
const landingPage = document.querySelector('#landing-page');
const wishModal = document.getElementById('wish-modal');

let uploadedPhotos = []; // å­˜å‚¨ç…§ç‰‡
let animationFrameId = null;
let currentProductKey = 'Birthdaycake';
let sceneManager = null;
let handTracker = null;

// æ¨¡å—æ˜ å°„
const SCENE_MODULES = {
    'WoodenFish': { scene: () => import('./logic/WoodenFish/SceneManager.js'), tracker: () => import('./logic/WoodenFish/HandTracker.js') },
    'GoldenTree': { scene: () => import('./logic/GoldenTree/SceneManager.js'), tracker: () => import('./logic/GoldenTree/HandTracker.js') },
    'Diamond3D': { scene: () => import('./logic/Diamond3D/SceneManager.js'), tracker: () => import('./logic/GoldenTree/HandTracker.js') },
    'LuckyCat': { scene: () => import('./logic/LuckyCat/SceneManager.js'), tracker: () => import('./logic/LuckyCat/HandTracker.js') },
    'LuckyDog': { scene: () => import('./logic/LuckyDog/SceneManager.js'), tracker: () => import('./logic/LuckyDog/HandTracker.js') },
    'PhotoTree': { scene: () => import('./logic/Treewith Photos/SceneManager.js'), tracker: () => import('./logic/Treewith Photos/HandTracker.js') },
    'SydneyFireworks': { scene: () => import('./logic/SydneyFireworks/SceneManager.js'), tracker: () => import('./logic/SydneyFireworks/HandTracker.js') },
    // âœ… å…³é”®ï¼šåŠ åç¼€
    'Birthdaycake': { 
        scene: () => import('./logic/Birthdaycake/SceneManager.js?v=final'), 
        tracker: () => import('./logic/Birthdaycake/HandTracker.js?v=final') 
    }
};

const PRODUCT_CONFIG = {
    SydneyFireworks: { key: 'SydneyFireworks', title: 'ğŸ† æ‚‰å°¼çƒŸèŠ±', btnText: 'ç‚¹äº®å¤œç©º', iconEmoji: 'ğŸ†', guides: [{ icon: 'ğŸ¤', text: 'æåˆ' }] },
    GoldenTree: { key: 'GoldenTree', title: 'ğŸ„ è®¸æ„¿æŒ‡å—', btnText: 'å¬å”¤é‡‘æ ‘', iconEmoji: 'ğŸ„', guides: [{ icon: 'âœŠ', text: 'æ¡æ‹³' }] },
    WoodenFish: { key: 'WoodenFish', title: 'ğŸ¹ åŠŸå¾·æŒ‡å—', btnText: 'å¼€å§‹ç§¯å¾·', iconEmoji: 'ğŸŸ', guides: [{ icon: 'ğŸ‘‹', text: 'æ•²å‡»' }] },
    LuckyCat: { key: 'LuckyCat', title: 'ğŸ± æ‹›è´¢è¿›å®', btnText: 'å¬å”¤è´¢ç¥', iconEmoji: 'ğŸ§§', guides: [{ icon: 'ğŸ‘‹', text: 'æ‹›æ‰‹' }] },
    Diamond3D: { key: 'Diamond3D', title: 'ğŸ’ ç²¾çµå®é’»', btnText: 'å”¤é†’å®çŸ³', iconEmoji: 'ğŸ’', guides: [{ icon: 'ğŸ–ï¸', text: 'æ—‹è½¬' }] },
    PhotoTree: { key: 'PhotoTree', title: 'ğŸ„ åœ£è¯ç…§ç‰‡å¢™', btnText: 'ç‚¹äº®å›å¿†', iconEmoji: 'ğŸ“¸', guides: [{ icon: 'ğŸ‘‹', text: 'æµè§ˆ' }] },
    // âœ… æŒ‰é’®åæ”¹ä¸ºâ€œå¼€å¯è®¸æ„¿â€
    Birthdaycake: { key: 'Birthdaycake', title: 'ğŸ‚ è®¸æ„¿è›‹ç³•', btnText: 'å¼€å¯è®¸æ„¿', iconEmoji: 'ğŸ‚', guides: [{ icon: 'ğŸ‘†', text: 'ç‚¹å‡»ç‚¹äº®' }, { icon: 'ğŸŒ¬ï¸', text: 'å˜Ÿå˜´å¹ç­' }] },
};

function initShowcase() {
    const container = document.getElementById('product-showcase');
    if (!container) return;
    container.innerHTML = '';

    Object.values(PRODUCT_CONFIG).forEach(p => {
        const card = document.createElement('div');
        card.className = `product-card ${p.key === currentProductKey ? 'active' : ''}`;
        card.onclick = () => {
            currentProductKey = p.key;
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            if (startBtn) startBtn.textContent = p.btnText;
        };
        card.innerHTML = `<div class="card-icon">${p.iconEmoji}</div><p>${p.title.split(' ')[1]}</p>`;
        container.appendChild(card);
    });

    if (startBtn) {
        startBtn.textContent = PRODUCT_CONFIG[currentProductKey].btnText;
        startBtn.onclick = onUserStartCheck;
    }
    initFileUpload();
}

function onUserStartCheck() {
    if (currentProductKey === 'Birthdaycake' && wishModal) {
        wishModal.style.display = 'flex';
    } else {
        startARExperience();
    }
}

function initFileUpload() {
    const input = document.getElementById('photo-input');
    const thumb = document.getElementById('preview-thumb');
    const count = document.getElementById('upload-count');
    const icon = document.querySelector('.upload-box span');

    if (!input) return;

    input.onchange = (e) => {
        const files = Array.from(e.target.files).slice(0, 4);
        uploadedPhotos = [];
        if (files.length === 0) return;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                uploadedPhotos.push(evt.target.result);
                if (uploadedPhotos.length === 1 && thumb) {
                    thumb.src = evt.target.result;
                    thumb.style.display = 'block';
                    if (icon) icon.style.display = 'none';
                }
                if (count) count.innerText = `${uploadedPhotos.length}/4`;
            };
            reader.readAsDataURL(file);
        });
    };

    window.confirmWishStart = () => {
        if (wishModal) wishModal.style.display = 'none';
        startARExperience();
    };
}

async function startARExperience() {
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    startBtn.disabled = true; 
    startBtn.textContent = "èµ„æºè£…è½½ä¸­...";

    const loader = SCENE_MODULES[currentProductKey];
    if (!loader) return alert('æ¨¡å—æœªæ‰¾åˆ°');

    try {
        const [SceneMod, TrackerMod] = await Promise.all([loader.scene(), loader.tracker()]);
        
        sceneManager = new SceneMod.SceneManager(canvas);
        handTracker = new TrackerMod.HandTracker();
        await sceneManager.init();

        // âœ… ä¼ é€’ç…§ç‰‡ç»™åœºæ™¯
        if (currentProductKey === 'Birthdaycake' && uploadedPhotos.length > 0) {
            uploadedPhotos.forEach((url, i) => {
                if (sceneManager.product?.updatePhoto) sceneManager.product.updatePhoto(i, url);
            });
        }

        landingPage.style.display = 'none';
        document.getElementById('view-ar').classList.add('active');
        document.getElementById('camera-box').style.display = 'block';
        
        // æ›´æ–°æŒ‡å—
        const guideTitle = document.getElementById('guide-title');
        const guideList = document.getElementById('guide-list');
        const config = PRODUCT_CONFIG[currentProductKey];
        if(guideTitle) guideTitle.textContent = config.title;
        if(guideList) guideList.innerHTML = config.guides.map(g => `<div class="guide-item"><span class="tag gold">${g.icon}</span><span class="text">${g.text}</span></div>`).join('');

        await handTracker.init();
        tick();

    } catch (e) {
        console.error(e);
        alert('å¯åŠ¨å¤±è´¥: ' + e.message);
        backToHome();
    }
}

function tick() {
    animationFrameId = requestAnimationFrame(tick);
    if (handTracker && sceneManager) {
        sceneManager.render(handTracker.detect(), 0);
    }
}

// è¿”å›ä¸»é¡µ
document.getElementById('home-btn')?.addEventListener('click', backToHome);
function backToHome() {
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    const video = document.getElementById('ar-camera-feed');
    if (video?.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    
    if (handTracker?.dispose) handTracker.dispose();
    if (sceneManager?.dispose) sceneManager.dispose();
    
    // æ¸…ç©ºç”»å¸ƒ
    const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
    if (gl) { gl.clearColor(0,0,0,0); gl.clear(gl.COLOR_BUFFER_BIT); }

    document.getElementById('view-ar').classList.remove('active');
    document.getElementById('camera-box').style.display = 'none';
    landingPage.style.display = 'flex';
    
    // é‡ç½®
    uploadedPhotos = [];
    if(wishModal) wishModal.style.display = 'none';
    startBtn.disabled = false;
    startBtn.textContent = PRODUCT_CONFIG[currentProductKey].btnText;
    
    // é‡ç½®ä¸Šä¼ UI
    const thumb = document.getElementById('preview-thumb');
    const icon = document.querySelector('.upload-box span');
    const count = document.getElementById('upload-count');
    if(thumb) { thumb.src=''; thumb.style.display='none'; }
    if(icon) icon.style.display='block';
    if(count) count.innerText='0/4';
}

initShowcase();
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
// âœ… å¼•å…¥è›‹ç³•åœºæ™¯
import { BirthdayCakeScene } from './BirthdayCakeScene.js?v=final';

export class SceneManager {
    constructor(canvas) {
        this.canvas = canvas;
        this.width = window.innerWidth;
        this.height = window.innerHeight;

        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x000000); 

        // æ­£äº¤ç›¸æœºï¼šé€‚åˆ 2D/3D æ··åˆ UI
        const aspect = this.width / this.height;
        const frustumSize = 10;
        this.camera = new THREE.OrthographicCamera(
            frustumSize * aspect / -2, frustumSize * aspect / 2,
            frustumSize / 2, frustumSize / -2,
            0.1, 1000
        );
        this.camera.position.set(0, 5, 10);
        this.camera.lookAt(0, 0, 0);

        this._setupRenderer();
        this.product = new BirthdayCakeScene(this.scene, this.camera, this.renderer);
        this._setupPostProcessing();
        
        window.addEventListener('resize', this._onResize.bind(this));
        window.addEventListener('pointerdown', () => this.product?.handleTap?.());
    }

    async init() {
        if (this.product?.init) await this.product.init();
    }

    render(gestureData, beat) {
        if (this.product) this.product.update(gestureData, beat);
        if (this.composer) this.composer.render();
        else this.renderer.render(this.scene, this.camera);
    }

    _setupRenderer() {
        this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: false, alpha: true });
        this.renderer.setSize(this.width, this.height);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    }

    _setupPostProcessing() {
        this.composer = new EffectComposer(this.renderer);
        this.composer.addPass(new RenderPass(this.scene, this.camera));
        // è¾‰å…‰
        this.composer.addPass(new UnrealBloomPass(new THREE.Vector2(this.width, this.height), 1.5, 0.4, 0.85));
    }

    _onResize() {
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        const aspect = this.width / this.height;
        const f = 10;
        this.camera.left = -f * aspect / 2;
        this.camera.right = f * aspect / 2;
        this.camera.top = f / 2;
        this.camera.bottom = -f / 2;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.width, this.height);
        this.composer.setSize(this.width, this.height);
    }

    dispose() {
        if (this.product?.dispose) this.product.dispose();
        this.renderer.dispose();
        this.composer.dispose();
    }
}
import * as THREE from 'three';

export class BirthdayCakeScene {
    constructor(scene, camera, renderer) {
        this.scene = scene;
        this.camera = camera;
        this.renderer = renderer;
        
        this.cakeGroup = new THREE.Group();
        this.photoGroup = new THREE.Group();
        this.bgParticles = null;
        this.particles = null;
        this.borderParticles = null;
        this.photoSlots = [];
        
        this.state = 'CAKE'; // CAKE -> EXPLODING -> FORMING -> DONE
        this.candles = [];
        this.isLit = true;
        this.clock = new THREE.Clock();
        this.currentLight = 1.0;
        this.explosionTime = 0;
    }

    async init() {
        this._buildBackground();
        this.scene.add(this.cakeGroup);
        this._buildCake();
        this._buildParticles();
        this._buildPhotoFrames();

        // ç¯å…‰
        this.scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        this.scene.add(dirLight);
        
        this.candleLight = new THREE.PointLight(0xffa500, 0, 10);
        this.candleLight.position.set(0, 2, 0);
        this.scene.add(this.candleLight);
    }

    _buildBackground() {
        const geo = new THREE.BufferGeometry();
        const pos = [];
        for(let i=0; i<1500; i++) {
            pos.push((Math.random()-0.5)*25, (Math.random()-0.5)*25, -5 + (Math.random()-0.5)*10);
        }
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({ color: 0xffd700, size: 0.1, transparent: true, opacity: 0.6 });
        this.bgParticles = new THREE.Points(geo, mat);
        this.scene.add(this.bgParticles);
    }

    _buildCake() {
        // é»„è‰²åº•åº§
        const base = new THREE.Mesh(new THREE.CylinderGeometry(2,2,1.5,32), new THREE.MeshLambertMaterial({color: 0xffd166}));
        base.position.y = -1;
        this.cakeGroup.add(base);
        // å¥¶æ²¹é¡¶
        const top = new THREE.Mesh(new THREE.CylinderGeometry(1.6,1.6,1,32), new THREE.MeshLambertMaterial({color: 0xfdfcdc}));
        top.position.y = 0.25;
        this.cakeGroup.add(top);
        // è£±èŠ±
        for(let i=0; i<24; i++) {
            const a = (i/24)*Math.PI*2;
            const d = new THREE.Mesh(new THREE.SphereGeometry(0.2,16,16), new THREE.MeshLambertMaterial({color: 0xfdfcdc}));
            d.scale.set(1,0.8,1);
            d.position.set(Math.cos(a)*1.5, 0.75, Math.sin(a)*1.5);
            this.cakeGroup.add(d);
        }
        // èœ¡çƒ›
        [[0,0.9], [-0.7,0.7], [0.7,0.7]].forEach(p => this._addCandle(p[0], p[1]));
    }

    _addCandle(x, z) {
        const c = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.8,12), new THREE.MeshStandardMaterial({color: 0xff3333}));
        c.position.set(x, 1.15, z);
        const f = new THREE.Mesh(new THREE.SphereGeometry(0.15,8,8), new THREE.MeshBasicMaterial({color: 0xffaa00}));
        f.position.y = 0.5;
        c.add(f);
        this.cakeGroup.add(c);
        this.candles.push({mesh:c, fire:f});
    }

    _buildParticles() {
        const geo = new THREE.BufferGeometry();
        const pos = [], vel = [];
        for(let i=0; i<1500; i++) {
            pos.push((Math.random()-0.5)*3, (Math.random()-0.5)*2, (Math.random()-0.5)*3);
            const s = 0.05 + Math.random()*0.1;
            vel.push(pos[i*3]*s, pos[i*3+1]*s, pos[i*3+2]*s);
        }
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geo.userData = { vel };
        this.particles = new THREE.Points(geo, new THREE.PointsMaterial({color: 0xffd700, size: 0.15, transparent:true, opacity:0, blending:THREE.AdditiveBlending}));
        this.scene.add(this.particles);
    }

    _buildPhotoFrames() {
        this.photoGroup.visible = false;
        this.photoGroup.scale.set(0,0,0);
        
        // æ¸¸åŠ¨ç²’å­æ¡†
        const bGeo = new THREE.BufferGeometry();
        const bPos = [];
        // åŠ¨æ€è®¡ç®—å°ºå¯¸
        const aspect = window.innerWidth/window.innerHeight;
        let fw = 6 * aspect * 0.9; let fh = fw * (4.6/3.4);
        if(fh > 8) { fh = 8; fw = fh * (3.4/4.6); }

        for(let i=0; i<800; i++) {
            bPos.push((Math.random()-0.5)*fw, (Math.random()-0.5)*fh, (Math.random()-0.5)*0.2);
        }
        bGeo.setAttribute('position', new THREE.Float32BufferAttribute(bPos, 3));
        bGeo.userData = { init: [...bPos] };
        this.borderParticles = new THREE.Points(bGeo, new THREE.PointsMaterial({color: 0xffd700, size: 0.12, transparent:true, opacity:0.8, blending:THREE.AdditiveBlending}));
        this.photoGroup.add(this.borderParticles);

        // ç…§ç‰‡æ§½
        const m = fw*0.05; 
        const pw = (fw - m*3)/2; const ph = (fh - m*3)/2;
        const offX = pw/2 + m/2; const offY = ph/2 + m/2;
        
        [[-offX, offY], [offX, offY], [-offX, -offY], [offX, -offY]].forEach((p, i) => {
            const slot = new THREE.Mesh(new THREE.PlaneGeometry(pw, ph), new THREE.MeshBasicMaterial({color: 0xcccccc, side: THREE.DoubleSide}));
            slot.position.set(p[0], p[1], 0.02);
            this.photoGroup.add(slot);
            this.photoSlots.push(slot);
        });
        this.scene.add(this.photoGroup);
    }

    updatePhoto(index, url) {
        if(!this.photoSlots[index]) return;
        new THREE.TextureLoader().load(url, tex => {
            tex.colorSpace = THREE.SRGBColorSpace;
            this.photoSlots[index].material.map = tex;
            this.photoSlots[index].material.color.set(0xffffff);
            this.photoSlots[index].material.needsUpdate = true;
        });
    }

    handleTap() { if(this.state==='CAKE') this.isLit = true; }

    update(gesture, beat) {
        const dt = this.clock.getDelta();
        const t = this.clock.getElapsedTime();

        // èƒŒæ™¯æ—‹è½¬
        if(this.bgParticles) this.bgParticles.rotation.y += 0.0005;

        if(this.state === 'CAKE') {
            if(this.isLit && gesture?.isBlowing) {
                this.isLit = false;
                setTimeout(() => {
                    this.state = 'EXPLODING';
                    this.cakeGroup.visible = false;
                    this.particles.material.opacity = 1;
                    this.explosionTime = t;
                }, 800);
            }
            this.currentLight = THREE.MathUtils.lerp(this.currentLight, this.isLit?1:0, 0.05);
            if(this.candleLight) this.candleLight.intensity = this.currentLight * (1+Math.sin(t*3)*0.1);
            this.candles.forEach(c => {
                const s = THREE.MathUtils.lerp(c.fire.scale.x, this.isLit?1:0, 0.1);
                c.fire.scale.setScalar(s);
                c.fire.visible = s > 0.01;
            });
        } else if (this.state === 'EXPLODING') {
            const pos = this.particles.geometry.attributes.position.array;
            const vel = this.particles.geometry.userData.vel;
            for(let i=0; i<pos.length; i+=3) {
                pos[i] += vel[i]*2; pos[i+1] += vel[i+1]*2; pos[i+2] += vel[i+2]*2;
            }
            this.particles.geometry.attributes.position.needsUpdate = true;
            if(t - this.explosionTime > 1.5) this.state = 'FORMING';
        } else if (this.state === 'FORMING' || this.state === 'DONE') {
            this.particles.material.opacity = THREE.MathUtils.lerp(this.particles.material.opacity, 0, 0.05);
            this.photoGroup.visible = true;
            const s = THREE.MathUtils.lerp(this.photoGroup.scale.x, 1, 0.05);
            this.photoGroup.scale.setScalar(s);
            this.photoGroup.rotation.y = Math.sin((1-s)*Math.PI)*0.3;
            
            // è¾¹æ¡†ç²’å­æ¸¸åŠ¨
            const pos = this.borderParticles.geometry.attributes.position.array;
            const init = this.borderParticles.geometry.userData.init;
            for(let i=0; i<pos.length; i+=3) {
                pos[i] = init[i] + Math.sin(t*2 + init[i+1])*0.1;
                pos[i+1] = init[i+1] + Math.cos(t*1.5 + init[i])*0.1;
            }
            this.borderParticles.geometry.attributes.position.needsUpdate = true;
            if(Math.abs(1-s)<0.01) this.state = 'DONE';
        }
    }

    dispose() {
        this.scene.traverse(o => { if(o.isMesh||o.isPoints) { o.geometry.dispose(); o.material?.dispose(); } });
    }
}
              import { FilesetResolver, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm";

export class HandTracker {
    constructor() {
        this.landmarker = null;
        this.video = null;
        this.lastVideoTime = -1;
        this.gestureData = { isBlowing: false };
    }

    async init() {
        try {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            this.landmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numFaces: 1,
                outputFaceBlendshapes: true
            });
            await this._setupCamera();
        } catch (e) { console.error(e); }
    }

    detect() {
        if (!this.landmarker || !this.video) return this.gestureData;
        if (this.video.currentTime !== this.lastVideoTime) {
            this.lastVideoTime = this.video.currentTime;
            const results = this.landmarker.detectForVideo(this.video, performance.now());
            if (results?.faceBlendshapes?.[0]) {
                const shapes = results.faceBlendshapes[0].categories;
                const pucker = shapes.find(s => s.categoryName === 'mouthPucker')?.score || 0;
                const funnel = shapes.find(s => s.categoryName === 'mouthFunnel')?.score || 0;
                this.gestureData.isBlowing = (pucker > 0.4 || funnel > 0.4);
            } else {
                this.gestureData.isBlowing = false;
            }
        }
        return this.gestureData;
    }

    _setupCamera() {
        return new Promise(resolve => {
            let v = document.getElementById("ar-camera-feed-hidden");
            if (!v) {
                v = document.createElement("video");
                v.id = "ar-camera-feed-hidden";
                v.style.display = "none";
                v.autoplay = true; v.playsInline = true;
                document.body.appendChild(v);
            }
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width:640, height:480 } })
                .then(s => { v.srcObject=s; v.onloadedmetadata=()=>{v.play(); this.video=v; resolve();}; })
                .catch(resolve);
        });
    }

    dispose() {
        if(this.video?.srcObject) this.video.srcObject.getTracks().forEach(t=>t.stop());
        this.landmarker?.close();
    }
}
