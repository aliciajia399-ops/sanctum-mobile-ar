<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden AR - Dual Mode</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        /* ========================
           å…¨å±€ä¸åŸºç¡€æ ·å¼
           ======================== */
        :root {
            --gold: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --dark-bg: #050505;
            --glass: rgba(10, 10, 10, 0.85);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--dark-bg);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            color: var(--gold);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        
        /* è§†å›¾å®¹å™¨ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.8s ease;
        }
        .view-section.active { display: flex; opacity: 1; }

        /* æŒ‰é’®æ ·å¼ */
        .btn-gold {
            background: linear-gradient(135deg, #b8860b, #ffd700);
            border: none; color: #000; padding: 12px 30px;
            font-size: 16px; font-weight: bold; border-radius: 25px;
            cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s; margin-top: 20px;
        }
        .btn-gold:active { transform: scale(0.95); }

        /* ========================
           ä¼ª AR æ ·å¼ (iOS/Fallback)
           ======================== */
        #fake-ar-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; transform: scaleX(1); /* åç½®æ‘„åƒå¤´é€šå¸¸ä¸é•œåƒ */
        }
        #fake-ar-content {
            position: relative; width: 300px; height: 450px;
            perspective: 1000px; transform-style: preserve-3d; 
            transform: scale(0); transition: transform 0.1s linear;
        }
        #fake-ar-tree-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 20px var(--gold-glow)) brightness(1.2);
        }

        /* ========================
           UI å…ƒç´ 
           ======================== */
        .hero-container { display: flex; gap: 20px; perspective: 1000px; }
        .hero-card {
            width: 90px; height: 140px; background: rgba(20, 20, 20, 0.9);
            border: 1px solid #444; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.4s; position: relative;
        }
        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(100%) brightness(0.5); }
        
        .ar-overlay-ui {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        #ar-timer {
            position: absolute; top: 40px; right: 30px; 
            font-size: 32px; font-weight: bold; color: var(--gold);
            text-shadow: 0 0 10px black;
        }
        .hand-guide {
            font-size: 18px; color: #fff; text-shadow: 0 0 5px #000;
            animation: fadeUp 2s infinite; margin-bottom: 20px;
        }
        @keyframes fadeUp { 0% {opacity:0; transform:translateY(20px);} 50% {opacity:1;} 100% {opacity:0; transform:translateY(-20px);} }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: rgba(20,20,20,0.95); border: 1px solid var(--gold);
            padding: 25px; border-radius: 10px; text-align: center; width: 85%;
            box-shadow: 0 0 30px var(--gold-glow);
        }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 15px; border-radius: 20px; margin: 5px; font-size: 14px;
        }

        /* çˆ†ç‚¸å±‚ */
        #explosion-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
        .particle-boom { position: absolute; background: var(--gold); border-radius: 50%; }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <section id="view-login" class="view-section active">
        <h2 style="color:var(--gold);">AR CHRISTMAS</h2>
        <div style="width:200px; height:200px; border:2px dashed var(--gold); border-radius:50%; animation:spin 4s linear infinite; display:flex; align-items:center; justify-content:center;">
            <span style="font-size:50px;">ğŸ„</span>
        </div>
        <button class="btn-gold" onclick="app.login()">ENTER WORLD</button>
        <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="margin-bottom:30px;">é€‰æ‹©ä½ çš„è£…å¤‡</h2>
        <div class="hero-container">
            <div class="hero-card unlocked" onclick="alert('å·²è£…å¤‡ï¼šç›èæ‹‰è’‚')">
                <span>ğŸï¸</span><span style="font-size:10px; color:gold;">ç›èæ‹‰è’‚</span>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.clickTreeCard()">
                <span style="font-size:10px; position:absolute; top:5px; right:5px;">ğŸ”’</span>
                <span>ğŸ„</span><span style="font-size:10px; color:#aaa;">å¹»å½±æ ‘</span>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ç¥ç¦</h2>
        <input type="text" id="wish-input" style="background:transparent; border:1px solid gold; color:gold; padding:10px; text-align:center;" placeholder="è¾“å…¥ç¥ç¦è¯­">
        <button class="btn-gold" onclick="app.confirmCustomization()">ç¡®è®¤</button>
    </section>

    <section id="view-santa" class="view-section">
        <img src="image_1.png" style="width:80%; max-width:300px; filter:drop-shadow(0 0 20px gold);" id="santa-img">
        <h2 style="color:red; text-shadow:0 0 10px red;">æ‘‡æ™ƒæ‰‹æœº!</h2>
    </section>

    <section id="view-fake-ar" class="view-section">
        <video id="fake-ar-video" autoplay playsinline muted></video>
        <div id="fake-ar-content">
            <img id="fake-ar-tree-img" src="image_0.png" alt="Tree">
        </div>
        <div class="ar-overlay-ui">
            <div id="fake-ar-timer" style="font-size:30px; font-weight:bold; color:gold; margin-bottom:auto; margin-top:40px;">12s</div>
            <div class="hand-guide">ğŸ‘† å·¦å³æ‹–åŠ¨æ—‹è½¬</div>
        </div>
    </section>

    <div id="webxr-overlay" style="display:none;" class="ar-overlay-ui">
        <div id="xr-timer" style="font-size:30px; font-weight:bold; color:gold; margin-bottom:auto; margin-top:40px;">12s</div>
        <div id="xr-guide" class="hand-guide">ğŸ‘€ å¯»æ‰¾åœ°é¢ -> ç‚¹å‡»æ”¾ç½®</div>
        <button id="xr-exit-btn" class="btn-outline" style="background:rgba(0,0,0,0.5); margin-bottom:30px;">é€€å‡º AR</button>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">æ ‡é¢˜</h3>
            <p id="modal-content" style="color:#ccc; font-size:14px;">å†…å®¹</p>
            <div id="modal-btns" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
        </div>
    </div>

    <div id="explosion-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // ============================
        // å…¨å±€ APP çŠ¶æ€ç®¡ç†
        // ============================
        window.app = {
            state: {
                treeUnlocked: false,
                isSantaDone: false,
                shakeCount: 0,
                hasWebXR: false
            },

            async init() {
                this.initParticles();
                
                // æ£€æµ‹ WebXR æ”¯æŒ
                if ('xr' in navigator) {
                    try {
                        this.state.hasWebXR = await navigator.xr.isSessionSupported('immersive-ar');
                        console.log("WebXR Supported:", this.state.hasWebXR);
                    } catch (e) {
                        console.log("WebXR Check Failed", e);
                    }
                }
            },

            // --- è§†å›¾åˆ‡æ¢ ---
            switchView(id) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                const el = document.getElementById(id);
                if(el) el.classList.add('active');
            },

            // --- æµç¨‹é€»è¾‘ ---
            login() { setTimeout(() => this.switchView('view-hero'), 800); },
            
            clickTreeCard() {
                if (this.state.treeUnlocked) {
                    this.showModal("å·²è§£é”", "é€‰æ‹© AR æ¨¡å¼å†æ¬¡æ¬£èµ", this.getARButtons());
                } else {
                    this.showModal("æ˜¯å¦å®šåˆ¶ï¼Ÿ", "å®šåˆ¶ä¸“å±ç¤¼ç‰©æˆ–ç›´æ¥ä½“éªŒ", [
                        { text: "å¦ (ç›´æ¥ä½“éªŒ)", action: () => { this.closeModal(); this.showARChoice(); } },
                        { text: "æ˜¯ (å»å®šåˆ¶)", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            confirmCustomization() {
                if(!document.getElementById('wish-input').value) return alert("è¯·è¾“å…¥å†…å®¹");
                this.switchView('view-santa');
                this.startSantaGame();
            },

            showARChoice() {
                // æ ¹æ®è®¾å¤‡èƒ½åŠ›å±•ç¤ºæŒ‰é’®
                this.showModal("é€‰æ‹© AR æ¨¡å¼", "WebXR éœ€è¦å…¼å®¹çš„å®‰å“è®¾å¤‡", this.getARButtons());
            },

            getARButtons() {
                const btns = [
                    { text: "ğŸ“· æ™®é€š AR (å…¼å®¹æ‰€æœ‰)", action: () => { this.closeModal(); fakeAR.start(); } }
                ];
                if (this.state.hasWebXR) {
                    btns.push({ 
                        text: "âœ¨ çœŸå®ç©ºé—´ AR (WebXR)", 
                        action: () => { this.closeModal(); realAR.start(); } 
                    });
                }
                return btns;
            },

            // --- åœ£è¯è€äººæ‘‡ä¸€æ‘‡ ---
            startSantaGame() {
                this.state.shakeCount = 0;
                const handler = (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if(acc && (Math.abs(acc.x+acc.y+acc.z) > 20)) {
                        this.state.shakeCount++;
                        document.getElementById('santa-img').style.transform = `scale(${1 + this.state.shakeCount/20})`;
                        if(this.state.shakeCount > 10) {
                            window.removeEventListener('devicemotion', handler);
                            this.santaSuccess();
                        }
                    }
                };
                window.addEventListener('devicemotion', handler);
                // æ¨¡æ‹Ÿç‚¹å‡»æ‘‡åŠ¨
                document.getElementById('view-santa').onclick = () => {
                    this.state.shakeCount += 3;
                    if(this.state.shakeCount > 10) this.santaSuccess();
                }
            },

            santaSuccess() {
                alert("ç¤¼ç‰©å·²é€è¾¾ï¼");
                this.state.isSantaDone = true;
                this.showARChoice();
            },

            // --- é€šç”¨ï¼šçˆ†ç‚¸è§£é” ---
            triggerExplosionAndUnlock() {
                // 1. çˆ†ç‚¸ç‰¹æ•ˆ
                const container = document.getElementById('explosion-container');
                const cx = window.innerWidth / 2; 
                const cy = window.innerHeight / 2;
                
                for(let i=0; i<80; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle-boom';
                    const size = Math.random() * 10 + 2;
                    p.style.cssText = `width:${size}px; height:${size}px; left:${cx}px; top:${cy}px;`;
                    container.appendChild(p);

                    const angle = Math.random() * Math.PI * 2;
                    const vel = Math.random() * 300 + 50;
                    p.animate([
                        { transform: 'translate(0,0) scale(1)', opacity: 1 },
                        { transform: `translate(${Math.cos(angle)*vel}px, ${Math.sin(angle)*vel}px) scale(0)`, opacity: 0 }
                    ], { duration: 1000 }).onfinish = () => p.remove();
                }

                // 2. è§£é”é€»è¾‘
                setTimeout(() => {
                    this.state.treeUnlocked = true;
                    const card = document.getElementById('card-tree');
                    card.classList.remove('locked');
                    card.classList.add('unlocked');
                    this.switchView('view-hero');
                    
                    // å¼ºåˆ¶å…³é—­ WebXR Session å¦‚æœè¿˜åœ¨è¿è¡Œ
                    if(realAR.session) realAR.endSession();
                    if(fakeAR.stream) fakeAR.stop();
                }, 1000);
            },

            // --- é€šç”¨ï¼šUI å·¥å…· ---
            showModal(t, c, btns) {
                document.getElementById('modal-title').innerText = t;
                document.getElementById('modal-content').innerText = c;
                const grp = document.getElementById('modal-btns');
                grp.innerHTML = '';
                btns.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-outline';
                    btn.innerText = b.text;
                    btn.onclick = b.action;
                    grp.appendChild(btn);
                });
                document.getElementById('modal').style.display = 'flex';
            },
            closeModal() { document.getElementById('modal').style.display = 'none'; },

            // --- ç²’å­èƒŒæ™¯ ---
            initParticles() {
                const cvs = document.getElementById('particle-canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                const parts = Array.from({length:50}, () => ({
                    x: Math.random()*cvs.width, y: Math.random()*cvs.height, s: Math.random()*2, a: Math.random()
                }));
                function loop(){
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    parts.forEach(p=>{
                        p.y -= 0.5; if(p.y<0) p.y=cvs.height;
                        ctx.fillStyle=`rgba(255,215,0,${p.a})`;
                        ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,6.28); ctx.fill();
                    });
                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        // ============================
        // æ¨¡å— A: ä¼ª AR (Camera Overlay)
        // å…¼å®¹ iOS / ä¸æ”¯æŒ WebXR çš„ç¯å¢ƒ
        // ============================
        const fakeAR = {
            stream: null,
            timer: null,

            async start() {
                app.switchView('view-fake-ar');
                const video = document.getElementById('fake-ar-video');
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = this.stream;
                    
                    // æ ‘çš„å‡ºç°åŠ¨ç”»
                    const content = document.getElementById('fake-ar-content');
                    setTimeout(() => {
                        content.style.transform = "scale(1)";
                        this.initGestures();
                        this.startTimer();
                    }, 500);

                } catch (e) {
                    alert("æ— æ³•è®¿é—®æ‘„åƒå¤´: " + e.message);
                }
            },

            stop() {
                if(this.stream) this.stream.getTracks().forEach(t=>t.stop());
                if(this.timer) clearInterval(this.timer);
            },

            initGestures() {
                const zone = document.getElementById('view-fake-ar');
                const target = document.getElementById('fake-ar-content');
                let startX = 0, curRot = 0;
                zone.ontouchstart = (e) => startX = e.touches[0].clientX;
                zone.ontouchmove = (e) => {
                    const delta = e.touches[0].clientX - startX;
                    target.style.transform = `scale(1) rotateY(${curRot + delta*0.5}deg)`;
                };
                zone.ontouchend = (e) => curRot += (e.changedTouches[0].clientX - startX)*0.5;
            },

            startTimer() {
                let t = 12;
                const el = document.getElementById('fake-ar-timer');
                el.innerText = t + "s";
                this.timer = setInterval(() => {
                    t--; el.innerText = t + "s";
                    if(t<=0) {
                        this.stop();
                        app.triggerExplosionAndUnlock();
                    }
                }, 1000);
            }
        };

        // ============================
        // æ¨¡å— B: çœŸ WebXR AR (Three.js)
        // åŒ…å« Hit Test, é”šå®š, 3D æ¸²æŸ“
        // ============================
        const realAR = {
            session: null,
            renderer: null,
            scene: null,
            camera: null,
            reticle: null,
            treeGroup: null,
            hitTestSource: null,
            xrOverlay: null,
            isPlaced: false,

            async start() {
                // 1. åˆå§‹åŒ– Three.js ç¯å¢ƒ
                this.initThree();

                // 2. è¯·æ±‚ Session
                const sessionInit = { 
                    requiredFeatures: ['hit-test'], 
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.getElementById('webxr-overlay') } 
                };
                
                try {
                    this.session = await navigator.xr.requestSession('immersive-ar', sessionInit);
                    this.session.addEventListener('end', () => this.onSessionEnded());
                    
                    // WebGL ç»‘å®š
                    this.renderer.xr.setReferenceSpaceType('local');
                    this.renderer.xr.setSession(this.session);
                    
                    // UI æ˜¾ç¤º
                    this.xrOverlay = document.getElementById('webxr-overlay');
                    this.xrOverlay.style.display = 'flex';
                    document.getElementById('xr-guide').innerText = "ğŸ‘€ ç§»åŠ¨æ‰‹æœºæ£€æµ‹åœ°é¢ -> å‡ºç°åœ†ç¯åç‚¹å‡»";
                    document.getElementById('xr-exit-btn').onclick = () => this.endSession();

                    // Hit Test å‡†å¤‡
                    const viewerSpace = await this.session.requestReferenceSpace('viewer');
                    this.hitTestSource = await this.session.requestHitTestSource({ space: viewerSpace });
                    
                    // äº¤äº’äº‹ä»¶
                    this.session.addEventListener('select', () => this.onSelect());

                    // å¼€å§‹æ¸²æŸ“å¾ªç¯
                    this.session.requestAnimationFrame((t, f) => this.onXRFrame(t, f));

                } catch (e) {
                    alert("å¯åŠ¨ WebXR å¤±è´¥: " + e.message);
                }
            },

            initThree() {
                if(this.renderer) return; // é¿å…é‡å¤åˆå§‹åŒ–

                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

                // ç¯å…‰
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
                this.scene.add(light);

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                // æ³¨æ„ï¼šWebXR æ¨¡å¼ä¸‹ canvas ä¸éœ€è¦ append åˆ° bodyï¼Œå®ƒä¼šè¢« session ç®¡ç†ï¼Œ
                // ä½†ä¸ºäº†é¿å…æ··ä¹±ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªéšè—çš„ div æ”¾å®ƒï¼Œæˆ–è€…ä¸æ”¾ï¼Œ
                // xr.setSession ä¼šæ¥ç®¡ç”»é¢ã€‚
            },

            // åˆ›å»ºâ€œç„å‡†å…‰æ ‡â€
            createReticle() {
                const geom = new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI/2);
                const mat = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
                this.reticle = new THREE.Mesh(geom, mat);
                this.reticle.matrixAutoUpdate = false;
                this.reticle.visible = false;
                this.scene.add(this.reticle);
            },

            // åˆ›å»º 3D æ ‘ (ä½¿ç”¨å›¾ç‰‡åš Billboard åå­—äº¤å‰ï¼Œæ€§èƒ½å¥½ä¸”è¿˜åŸ)
            createTreeAt(matrix) {
                if(this.treeGroup) this.scene.remove(this.treeGroup);

                // æè´¨åŠ è½½ç”¨æˆ·æä¾›çš„ image_0.png
                const loader = new THREE.TextureLoader();
                const tex = loader.load('image_0.png'); 
                const mat = new THREE.MeshBasicMaterial({ 
                    map: tex, 
                    transparent: true, 
                    side: THREE.DoubleSide,
                    depthWrite: false // é¿å…é€æ˜é®æŒ¡é—®é¢˜
                });

                // åå­—äº¤å‰å¹³é¢æ¨¡æ‹Ÿ 3D æ ‘
                const geom = new THREE.PlaneGeometry(0.6, 1.0); // å®½0.6ç±³ é«˜1ç±³
                const p1 = new THREE.Mesh(geom, mat);
                const p2 = new THREE.Mesh(geom, mat);
                p2.rotation.y = Math.PI / 2; // æ—‹è½¬90åº¦

                this.treeGroup = new THREE.Group();
                this.treeGroup.add(p1);
                this.treeGroup.add(p2);

                // åº”ç”¨ç‚¹å‡»å¤„çš„ä½ç½®
                this.treeGroup.position.setFromMatrixPosition(matrix);
                // ç¨å¾®æŠ¬é«˜ä¸€ç‚¹ï¼Œè®©æ ‘åº•å¯¹é½åœ°é¢
                this.treeGroup.position.y += 0.5; 

                this.scene.add(this.treeGroup);
                
                // æˆåŠŸæ”¾ç½®
                this.isPlaced = true;
                this.reticle.visible = false;
                document.getElementById('xr-guide').innerText = "âœ¨ åœ£è¯æ ‘å·²é”šå®šï¼å¯ä»¥ç»•ç€å®ƒèµ°";
                
                // å¼€å§‹ WebXR å†…çš„å€’è®¡æ—¶
                this.startXRTimer();
            },

            onSelect() {
                if (this.reticle.visible && !this.isPlaced) {
                    this.createTreeAt(this.reticle.matrix);
                }
            },

            onXRFrame(t, frame) {
                const session = frame.session;
                session.requestAnimationFrame((t, f) => this.onXRFrame(t, f));

                const viewerPose = frame.getViewerPose(this.renderer.xr.getReferenceSpace());

                if (viewerPose) {
                    // Hit Test é€»è¾‘
                    if (this.hitTestSource && !this.isPlaced) {
                        const hitTestResults = frame.getHitTestResults(this.hitTestSource);
                        if (hitTestResults.length > 0) {
                            const hit = hitTestResults[0];
                            const hitPose = hit.getPose(this.renderer.xr.getReferenceSpace());
                            
                            // åˆå§‹åŒ–å…‰æ ‡
                            if(!this.reticle) this.createReticle();

                            this.reticle.visible = true;
                            this.reticle.matrix.fromArray(hitPose.transform.matrix);
                        } else {
                            if(this.reticle) this.reticle.visible = false;
                        }
                    }

                    // æ¸²æŸ“åœºæ™¯
                    this.renderer.render(this.scene, this.camera);
                }
            },

            startXRTimer() {
                let t = 12;
                const el = document.getElementById('xr-timer');
                el.innerText = t + "s";
                const timer = setInterval(() => {
                    t--; el.innerText = t + "s";
                    if(t <= 0) {
                        clearInterval(timer);
                        this.endSession();
                        app.triggerExplosionAndUnlock();
                    }
                }, 1000);
            },

            endSession() {
                if(this.session) this.session.end();
            },

            onSessionEnded() {
                this.session = null;
                this.hitTestSource = null;
                this.isPlaced = false;
                if(this.xrOverlay) this.xrOverlay.style.display = 'none';
            }
        };

        // å¯åŠ¨ App
        window.onload = () => app.init();
        
        // æš´éœ²ç»™å…¨å±€ä»¥ä¾¿ HTML onclick è°ƒç”¨
        window.fakeAR = fakeAR;
        window.realAR = realAR;

    </script>
</body>
</html>
