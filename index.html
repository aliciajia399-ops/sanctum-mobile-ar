<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden Christmas AR - Starry Night</title>
    <style>
        /* =========================================
           1. å…¨å±€ CSS å˜é‡ä¸åŸºç¡€è®¾å®š
           ========================================= */
        :root {
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            overflow: hidden; color: var(--gold); user-select: none;
        }

        /* å…¨å±€èƒŒæ™¯ç²’å­ç”»å¸ƒ */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* é€šç”¨è§†å›¾å®¹å™¨ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.5s ease;
            background: rgba(0,0,0,0.3);
        }
        .view-section.active { display: flex; opacity: 1; }

        /* é€šç”¨é‡‘è‰²æŒ‰é’® */
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: none; color: #000; padding: 12px 30px; font-size: 16px; font-weight: bold;
            border-radius: 25px; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s; margin-top: 20px; width: 80%; max-width: 200px;
        }
        .btn-gold:active { transform: scale(0.95); }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 20px; font-size: 14px; margin: 0 5px;
        }

        .input-gold {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: var(--gold);
            border-radius: 8px; text-align: center; font-size: 16px; outline: none;
        }
        .input-gold:focus { border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }

        /* =========================================
           2. ç™»å½•ã€é€‰è§’ã€å®šåˆ¶é¡µæ ·å¼
           ========================================= */
        /* ç™»å½•é¡µ */
        .login-panel {
            width: 85%; max-width: 320px; padding: 30px 20px;
            background: var(--glass-bg); border: 1px solid var(--gold); border-radius: 15px;
            text-align: center; backdrop-filter: blur(10px); position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .bg-anim-item { position: absolute; font-size: 40px; opacity: 0.6; filter: drop-shadow(0 0 10px gold); pointer-events: none; }
        .anim-car { top: 70%; left: -100px; animation: driveBy 8s linear infinite; }
        .anim-tree { top: 20%; right: -100px; animation: floatBy 10s linear infinite; animation-delay: 2s; font-size: 50px; }
        @keyframes driveBy { 0% { opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(120vw); opacity:0; } }
        @keyframes floatBy { 0% { opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(-120vw) rotate(360deg); opacity:0; } }

        /* è‹±é›„é¡µ */
        .hero-grid { display: flex; gap: 15px; justify-content: center; perspective: 1000px; }
        .hero-card {
            width: 90px; height: 150px; background: rgba(20,20,20,0.9); border: 1px solid #444;
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.3s; cursor: pointer; animation: cardFloat 3s ease-in-out infinite;
        }
        .hero-card:nth-child(2) { animation-delay: 0.5s; }
        @keyframes cardFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(1) brightness(0.5); }
        .hero-icon { font-size: 40px; margin-bottom: 10px; }
        .lock-tag { position: absolute; top: 5px; right: 5px; font-size: 12px; }

        /* åœ£è¯è€äººé¡µ */
        #santa-story-img {
            width: 90%; max-width: 400px; object-fit: contain; margin-bottom: 30px;
            filter: drop-shadow(0 0 30px var(--gold)); transform: scale(0.8); opacity: 0;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .santa-appear { transform: scale(1.1) !important; opacity: 1 !important; }
        .shake-alert { color: #ff3333; font-size: 22px; font-weight: bold; text-align: center; text-shadow: 0 0 10px #000; animation: pulseFast 0.5s infinite; }
        @keyframes pulseFast { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
        .shake-success { color: var(--gold); font-size: 22px; font-weight: bold; text-align: center; text-shadow: 0 0 10px var(--gold-glow); }


        /* =========================================
           3. AR æ ¸å¿ƒåœºæ™¯ (PiP + èˆå°ä¸­å¿ƒåŒ–)
           ========================================= */
        
        /* æ ¸å¿ƒä¿®æ”¹ï¼šAR åœºæ™¯èƒŒæ™¯æ”¹ä¸ºæ˜Ÿç©ºï¼Œä¸å†é€è§†æ‘„åƒå¤´ */
        #view-ar {
            background:
                radial-gradient(circle at 20% 0%, rgba(255, 215, 0, 0.12), transparent 55%),
                radial-gradient(circle at 80% 100%, rgba(255, 215, 0, 0.08), transparent 55%),
                radial-gradient(circle at 50% 50%, #050510, #020308 70%, #000 100%);
        }

        /* æ ¸å¿ƒä¿®æ”¹ï¼šå‰ç½®æ‘„åƒå¤´å³ä¸Šè§’å°çª—å£ */
        #ar-camera-feed {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 28vw;
            max-width: 130px;
            aspect-ratio: 3 / 4;
            height: auto;
            object-fit: cover;
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            z-index: 5; /* åœ¨èƒŒæ™¯ä¹‹ä¸Šï¼ŒUIä¹‹ä¸‹ */
            transform: scaleX(-1); /* é•œåƒ */
            background: #000;
        }

        /* æ ¸å¿ƒä¿®æ”¹ï¼šèˆå°ä¸­å¿ƒåŒ– */
        #ar-tree-container {
            position: relative;
            width: 60vw;
            max-width: 320px;
            height: auto;
            aspect-ratio: 3 / 4;
            margin: auto; /* ç»å¯¹å±…ä¸­ */
            perspective: 1200px;
            transform-style: preserve-3d;
            transition: transform 0.15s linear; /* æ‰‹åŠ¿è·Ÿæ‰‹ */
            transform: scale(1) rotateY(0deg);
            opacity: 1;
            z-index: 1; /* ç¡®ä¿åœ¨ç²’å­ä¹‹ä¸Š */
        }

        #ar-tree-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.9)) brightness(1.1);
            /* è®©æ‰‹åŠ¿ç©¿é€å›¾ç‰‡ï¼Œç”±çˆ¶çº§æˆ–èƒŒæ™¯å“åº” */
            pointer-events: none; 
            will-change: transform;
        }

        /* AR UI æµ®å±‚ */
        .ar-ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px 20px;
            z-index: 10;
        }
        .ar-timer { 
            position: absolute; top: 30px; left: 20px;
            font-size: 36px; font-weight: 800; text-shadow: 0 0 10px #000; 
        }

        .ar-guide {
            align-self: center; text-align: center; background: rgba(0,0,0,0.6);
            padding: 15px; border-radius: 12px; border: 1px solid var(--gold-glow);
            animation: floatGuide 2s infinite ease-in-out;
            min-width: 260px;
        }
        @keyframes floatGuide { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }

        /* =========================================
           4. å¼¹çª—ä¸ç‰¹æ•ˆ
           ========================================= */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-body {
            background: var(--glass-bg); border: 1px solid var(--gold);
            padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px;
            box-shadow: 0 0 40px var(--gold-glow); transform: scale(0.9); transition: 0.3s;
        }
        .modal-body.show { transform: scale(1); }

        #flying-gift {
            position: fixed; top: 50%; left: 50%; font-size: 100px; z-index: 200;
            transform: translate(-50%, -50%) scale(0); pointer-events: none;
        }
        #explosion-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .boom-particle { position: absolute; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold-glow); }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <section id="view-login" class="view-section active">
        <div class="bg-anim-item anim-car">ğŸï¸</div>
        <div class="bg-anim-item anim-tree">ğŸ„</div>
        <div class="bg-anim-item anim-santa">ğŸ…</div>
        <div class="login-panel">
            <h2 style="margin-top:0; text-shadow: 0 0 10px var(--gold);">VIP ACCESS</h2>
            <div style="margin-bottom:20px; font-size:14px; color:#aaa;">å¼€å¯ä½ çš„é‡‘è‰²åœ£è¯ä¹‹æ—…</div>
            <input type="tel" class="input-gold" placeholder="æ‰‹æœºå·">
            <input type="text" class="input-gold" placeholder="éªŒè¯ç ">
            <button class="btn-gold" onclick="app.handleLogin()">ç«‹å³ç™»å½•</button>
        </div>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="margin-bottom:40px; text-shadow: 0 0 15px var(--gold);">é€‰æ‹©ä½ çš„è‹±é›„</h2>
        <div class="hero-grid">
            <div class="hero-card unlocked" onclick="app.toast('å·²è£…å¤‡ï¼šé‡‘è‰²ç›èæ‹‰è’‚')">
                <div class="hero-icon">ğŸï¸</div>
                <div class="hero-name">é»„é‡‘ GT</div>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.handleTreeClick()">
                <div class="lock-tag">ğŸ”’</div>
                <div class="hero-icon">ğŸ„</div>
                <div class="hero-name">å¹»å½±æ ‘</div>
            </div>
            <div class="hero-card locked" onclick="app.toast('æ•¬è¯·æœŸå¾…')">
                <div class="hero-icon">â“</div>
                <div class="hero-name">ç¥ç§˜å˜‰å®¾</div>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ä½ çš„ç¥ç¦</h2>
        <input type="text" id="wish-input" class="input-gold" style="width:80%;" maxlength="20" placeholder="ä¾‹å¦‚ï¼šé—ºèœœä»Šå¹´ä¸€èµ·æš´å¯Œï¼">
        <button class="btn-gold" onclick="app.confirmWish()">ç¡®è®¤ç”Ÿæˆ</button>
    </section>

    <section id="view-santa" class="view-section">
        <img id="santa-story-img" src="ChatGPT Image Dec 1, 2025, 10_09_26 PM.png" alt="Golden Santa">
        <div id="santa-hint" class="shake-alert">
            é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼<br>ä¸ç„¶åœ£è¯è€äººè¦æ’ä¸Šä½ äº†ï¼
        </div>
        <button onclick="app.triggerShakeMock()" style="margin-top:30px; opacity:0.6; background:none; border:1px solid #666; color:#888; padding:6px 12px; border-radius:20px; font-size:12px;">
            (æ¨¡æ‹Ÿæ‘‡æ™ƒ)
        </button>
    </section>

    <section id="view-ar" class="view-section">
        <video id="ar-camera-feed" autoplay playsinline muted></video>
        
        <div id="ar-tree-container">
            <img id="ar-tree-img" src="ChatGPT Image Dec 1, 2025, 09_36_29 PM.png" alt="Golden AR Tree">
        </div>

        <div class="ar-ui-overlay">
            <div id="ar-timer" class="ar-timer">12s</div>
            
            <div class="ar-guide">
                <div style="font-size:18px; font-weight:bold; margin-bottom:8px; color:var(--gold);">ğŸ‘‹ æ‰‹åŠ¿æ§åˆ¶</div>
                <div style="font-size:14px; line-height:1.6; color:#fff;">
                    å·¦å³æ»‘åŠ¨å±å¹• â†’ åœ£è¯æ ‘æ—‹è½¬<br>
                    åŒæŒ‡æåˆ â†’ åœ£è¯æ ‘æ”¾å¤§ / ç¼©å°
                </div>
                <div style="font-size:10px; opacity:0.6; margin-top:8px; border-top:1px solid rgba(255,255,255,0.2); padding-top:5px;">
                    å³ä¸Šè§’å°çª—å£ä»…ç”¨äºè¯†åˆ«æ‰‹åŠ¿ï¼Œä¸ä¼šå­˜å‚¨äººè„¸æ•°æ®
                </div>
            </div>
        </div>
    </section>

    <div id="flying-gift">ğŸ</div>
    <div id="explosion-layer"></div>

    <div id="modal" class="modal-mask">
        <div class="modal-body" id="modal-box">
            <h3 id="modal-title" style="color:var(--gold); margin-top:0;">æç¤º</h3>
            <p id="modal-content" style="color:#ccc; margin:20px 0;">å†…å®¹</p>
            <div id="modal-btns" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                treeUnlocked: false,
                passedSantaFlow: false,
                shakeCount: 0,
                cameraStream: null,
                isArRunning: false
            },

            init() {
                this.initParticles();
                console.log("Golden AR App Initialized.");
            },

            // --- è§†å›¾åˆ‡æ¢ ---
            switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId !== 'view-ar') this.stopCamera();
            },

            // --- ä¸šåŠ¡æµç¨‹ï¼šç™»å½•/é€‰è§’/å®šåˆ¶/å‰§æƒ… ---
            handleLogin() {
                const btn = document.querySelector('#view-login .btn-gold');
                btn.innerText = "æ­£åœ¨éªŒè¯..."; btn.disabled = true;
                setTimeout(() => {
                    btn.innerText = "ç™»å½•æˆåŠŸ";
                    setTimeout(() => {
                        this.switchView('view-hero');
                        btn.innerText = "ç«‹å³ç™»å½•"; btn.disabled = false;
                    }, 800);
                }, 1000);
            },

            handleTreeClick() {
                if (this.state.treeUnlocked) {
                    this.showModal("å·²è§£é”", "å†æ¬¡æ¬£èµé‡‘è‰²åœ£è¯æ ‘ï¼Ÿ", [
                        { text: "å–æ¶ˆ", action: () => this.closeModal() },
                        { text: "è¿›å…¥ AR", action: () => { this.closeModal(); this.startArFlow(); } }
                    ]);
                } else {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±åœ£è¯ç¤¼ç‰©ï¼Ÿ", [
                        { text: "ç›´æ¥ä½“éªŒ", action: () => { this.closeModal(); this.startArFlow(); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            confirmWish() {
                if (!document.getElementById('wish-input').value.trim()) return this.toast("è¯·è¾“å…¥ç¥ç¦å†…å®¹~");
                this.startSantaFlow();
            },

            startSantaFlow() {
                this.switchView('view-santa');
                const img = document.getElementById('santa-story-img');
                const hint = document.getElementById('santa-hint');
                this.state.shakeCount = 0;
                img.classList.remove('santa-appear');
                hint.className = 'shake-alert'; hint.innerHTML = "é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼<br>ä¸ç„¶åœ£è¯è€äººè¦æ’ä¸Šä½ äº†ï¼";
                setTimeout(() => img.classList.add('santa-appear'), 100);

                this.shakeHandler = (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if (!acc) return;
                    if ((Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z)) > 25) this.handleShakeAction();
                };
                window.addEventListener('devicemotion', this.shakeHandler);
            },

            triggerShakeMock() { this.handleShakeAction(2); },

            handleShakeAction(amount = 1) {
                this.state.shakeCount += amount;
                document.getElementById('santa-story-img').style.transform = `scale(1.15) rotate(${Math.random()*6-3}deg)`;
                if (this.state.shakeCount >= 8) {
                    window.removeEventListener('devicemotion', this.shakeHandler);
                    this.finishSantaFlow();
                }
            },

            finishSantaFlow() {
                const hint = document.getElementById('santa-hint');
                hint.className = 'shake-success'; hint.innerText = "ä¿¡å·å·²æ¥æ”¶ï¼ç¤¼ç‰©æ´¾é€ä¸­...";
                const gift = document.getElementById('flying-gift');
                gift.style.transition = "all 0.8s cubic-bezier(0.6, 0.05, 0.2, 0.99)";
                gift.style.opacity = 1;
                gift.style.transform = "translate(-50%, -50%) scale(20)";
                
                setTimeout(() => {
                    document.body.style.background = "#000";
                    setTimeout(() => {
                        gift.style.display = 'none'; gift.style.transform = "translate(-50%, -50%) scale(0)";
                        document.body.style.background = "";
                        this.state.passedSantaFlow = true;
                        this.startArFlow();
                    }, 500);
                }, 800);
            },

            // --- AR æ ¸å¿ƒæµç¨‹ ---
            async startArFlow() {
                this.switchView('view-ar');
                this.state.isArRunning = true;
                const videoEl = document.getElementById('ar-camera-feed');
                const treeContainer = document.getElementById('ar-tree-container');
                const timerEl = document.getElementById('ar-timer');

                // å¼€å¯å°çª—å£æ‘„åƒå¤´
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    videoEl.srcObject = stream;
                    this.state.cameraStream = stream;
                } catch (e) {
                    console.error("Camera Error:", e);
                    // å³ä½¿æ²¡æœ‰æ‘„åƒå¤´ï¼Œæ¼”ç¤ºä¾ç„¶å¯ä»¥ç»§ç»­ï¼Œåªæ˜¯å°çª—å£é»‘å±
                }

                // åœ£è¯æ ‘å…¥åœº
                treeContainer.style.transform = "scale(0) rotateY(0deg)"; treeContainer.style.opacity = 0;
                setTimeout(() => {
                    treeContainer.style.opacity = 1;
                    treeContainer.style.transform = "scale(1) rotateY(0deg)";
                    setTimeout(() => this.initGestures(), 1000);
                }, 500);

                // å€’è®¡æ—¶
                let timeLeft = 12;
                timerEl.innerText = "12s";
                this.arTimer = setInterval(() => {
                    if (!this.state.isArRunning) return clearInterval(this.arTimer);
                    timeLeft--; timerEl.innerText = timeLeft + "s";
                    if (timeLeft <= 0) {
                        clearInterval(this.arTimer);
                        this.explodeTree();
                    }
                }, 1000);
            },

            // æ‰‹åŠ¿æ§åˆ¶ï¼šåªæ§åˆ¶ #ar-tree-container
            initGestures() {
                const touchSurface = document.getElementById('view-ar');
                const target = document.getElementById('ar-tree-container');
                let startX = 0, currentRotY = 0;
                let startDist = 0, currentScale = 1;
                let isDragging = false, isPinching = false;

                const getDist = (t1, t2) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);

                touchSurface.ontouchstart = (e) => {
                    if (e.touches.length === 1) {
                        startX = e.touches[0].clientX; isDragging = true;
                    } else if (e.touches.length === 2) {
                        startDist = getDist(e.touches[0], e.touches[1]); isPinching = true;
                    }
                };
                touchSurface.ontouchmove = (e) => {
                    e.preventDefault();
                    if (isDragging && e.touches.length === 1) {
                        const deltaX = e.touches[0].clientX - startX;
                        // çµæ•åº¦ 0.5
                        const newRot = currentRotY + deltaX * 0.5;
                        target.style.transform = `scale(${currentScale}) rotateY(${newRot}deg)`;
                    } else if (isPinching && e.touches.length === 2) {
                        const newDist = getDist(e.touches[0], e.touches[1]);
                        const scaleDelta = (newDist / startDist) * currentScale;
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´ 0.5 - 1.5
                        target.style.transform = `scale(${Math.min(Math.max(scaleDelta, 0.5), 1.5)}) rotateY(${currentRotY}deg)`;
                    }
                };
                touchSurface.ontouchend = (e) => {
                    if (isDragging) {
                        currentRotY += (e.changedTouches[0].clientX - startX) * 0.5; isDragging = false;
                    }
                    if (isPinching && e.touches.length < 2) {
                        const newDist = getDist(e.changedTouches[0], e.touches[0] || e.changedTouches[1]);
                        currentScale = Math.min(Math.max((newDist / startDist) * currentScale, 0.5), 1.5); isPinching = false;
                    }
                };
            },

            stopCamera() {
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(t => t.stop());
                    this.state.cameraStream = null;
                }
                this.state.isArRunning = false;
            },

            explodeTree() {
                const treeImg = document.getElementById('ar-tree-img');
                const rect = treeImg.getBoundingClientRect();
                treeImg.style.transition = "0.3s"; treeImg.style.filter = "brightness(5) drop-shadow(0 0 50px gold)";
                setTimeout(() => {
                    treeImg.style.opacity = 0;
                    this.spawnExplosion(rect.left+rect.width/2, rect.top+rect.height/2);
                    this.stopCamera();
                    setTimeout(() => this.handleArFinish(), 1500);
                }, 300);
            },

            handleArFinish() {
                if (this.state.passedSantaFlow) {
                    this.state.treeUnlocked = true;
                    const card = document.getElementById('card-tree');
                    card.classList.remove('locked'); card.classList.add('unlocked');
                    card.querySelector('.lock-tag').style.display = 'none';
                    this.toast("ğŸ‰ ä½“éªŒå®Œæˆï¼é‡‘è‰²åœ£è¯æ ‘å·²æ°¸ä¹…è§£é”ï¼", 3000);
                    this.switchView('view-hero');
                    this.state.passedSantaFlow = false;
                } else {
                    this.showModal("ä½“éªŒç»“æŸ", "æƒ³æ°¸ä¹…è§£é”å¹¶å®šåˆ¶ç¤¼ç‰©å—ï¼Ÿ", [
                        { text: "è¿”å›ä¸»é¡µ", action: () => { this.closeModal(); this.switchView('view-hero'); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
                 setTimeout(() => {
                    const treeImg = document.getElementById('ar-tree-img');
                    treeImg.style.opacity = 1; treeImg.style.filter = "";
                 }, 1000);
            },

            // --- å·¥å…·å‡½æ•° ---
            showModal(t, c, btns) {
                document.getElementById('modal-title').innerText = t;
                document.getElementById('modal-content').innerText = c;
                const g = document.getElementById('modal-btns'); g.innerHTML = '';
                btns.forEach(b => {
                    const btn = document.createElement('button'); btn.className = 'btn-outline';
                    btn.innerText = b.text; btn.onclick = b.action; g.appendChild(btn);
                });
                document.getElementById('modal').style.display = 'flex';
                setTimeout(() => document.getElementById('modal-box').classList.add('show'), 10);
            },
            closeModal() {
                document.getElementById('modal-box').classList.remove('show');
                setTimeout(() => document.getElementById('modal').style.display = 'none', 300);
            },
            toast(msg, time=2000) { console.log(msg); alert(msg); },
            spawnExplosion(x, y) {
                const layer = document.getElementById('explosion-layer');
                for (let i = 0; i < 60; i++) {
                    const p = document.createElement('div'); p.className = 'boom-particle';
                    const s = Math.random() * 8 + 3;
                    p.style.cssText = `width:${s}px; height:${s}px; left:${x}px; top:${y}px;`;
                    layer.appendChild(p);
                    const angle = Math.random() * 6.28; const v = Math.random() * 200 + 80;
                    p.animate([
                        { transform: 'translate(0,0) scale(1)', opacity: 1 },
                        { transform: `translate(${Math.cos(angle)*v}px, ${Math.sin(angle)*v}px) scale(0)`, opacity: 0 }
                    ], { duration: 800 + Math.random()*600, easing: 'cubic-bezier(0,.9,.57,1)' }).onfinish = () => p.remove();
                }
            },
            initParticles() {
                const cvs = document.getElementById('particle-canvas');
                const ctx = cvs.getContext('2d');
                let w, h; const resize = () => { w = cvs.width = window.innerWidth; h = cvs.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();
                const parts = Array.from({length: 50}, () => ({ x: Math.random()*w, y: Math.random()*h, s: Math.random()*2, sp: Math.random()*0.5+0.2 }));
                function draw() {
                    ctx.clearRect(0,0,w,h); ctx.fillStyle = "rgba(255, 215, 0, 0.5)";
                    parts.forEach(p => {
                        p.y -= p.sp; if(p.y < 0) p.y = h;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    });
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
