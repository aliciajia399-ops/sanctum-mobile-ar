<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden Christmas AR Gift</title>
    <style>
        /* =========================================
           1. å…¨å±€ CSS å˜é‡ä¸åŸºç¡€è®¾å®š
           ========================================= */
        :root {
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            overflow: hidden; color: var(--gold); user-select: none;
        }

        /* å…¨å±€èƒŒæ™¯ç²’å­ç”»å¸ƒ */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* é€šç”¨è§†å›¾å®¹å™¨ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.5s ease;
            background: rgba(0,0,0,0.3); /* ç¨å¾®å‹æš—èƒŒæ™¯å¢å¼ºå¯¹æ¯” */
        }
        .view-section.active { display: flex; opacity: 1; }

        /* é€šç”¨é‡‘è‰²æŒ‰é’® */
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: none; color: #000; padding: 12px 30px; font-size: 16px; font-weight: bold;
            border-radius: 25px; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s; margin-top: 20px; width: 80%; max-width: 200px;
        }
        .btn-gold:active { transform: scale(0.95); }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 20px; font-size: 14px; margin: 0 5px;
        }

        /* é€šç”¨è¾“å…¥æ¡† */
        .input-gold {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: var(--gold);
            border-radius: 8px; text-align: center; font-size: 16px; outline: none;
        }
        .input-gold::placeholder { color: rgba(255,215,0,0.5); }
        .input-gold:focus { border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); }

        /* =========================================
           2. å„è§†å›¾ç‰¹å®šæ ·å¼
           ========================================= */
        
        /* --- ç™»å½•é¡µ --- */
        .login-panel {
            width: 85%; max-width: 320px; padding: 30px 20px;
            background: var(--glass-bg); border: 1px solid var(--gold); border-radius: 15px;
            text-align: center; backdrop-filter: blur(10px); position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        /* ç™»å½•é¡µèƒŒæ™¯åŠ¨ç”»å…ƒç´  */
        .bg-anim-item { position: absolute; font-size: 40px; opacity: 0.6; filter: drop-shadow(0 0 10px gold); pointer-events: none; }
        .anim-car { top: 70%; left: -100px; animation: driveBy 8s linear infinite; }
        .anim-tree { top: 20%; right: -100px; animation: floatBy 10s linear infinite; animation-delay: 2s; font-size: 50px; }
        .anim-santa { top: 40%; left: -150px; animation: driveBy 12s linear infinite; animation-delay: 5s; font-size: 60px; }
        @keyframes driveBy { 0% { transform: translateX(0); opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(120vw); opacity:0; } }
        @keyframes floatBy { 0% { transform: translateX(0) rotate(0deg); opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { transform: translateX(-120vw) rotate(360deg); opacity:0; } }

        /* --- è‹±é›„é€‰æ‹©é¡µ --- */
        .hero-grid { display: flex; gap: 15px; justify-content: center; perspective: 1000px; }
        .hero-card {
            width: 90px; height: 150px; background: rgba(20,20,20,0.9); border: 1px solid #444;
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.3s; cursor: pointer; animation: cardFloat 3s ease-in-out infinite;
        }
        .hero-card:nth-child(2) { animation-delay: 0.5s; } .hero-card:nth-child(3) { animation-delay: 1s; }
        @keyframes cardFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(1) brightness(0.5); }
        .hero-icon { font-size: 40px; margin-bottom: 10px; }
        .hero-name { font-size: 12px; color: #aaa; }
        .hero-card.unlocked .hero-name { color: var(--gold); }
        .lock-tag { position: absolute; top: 5px; right: 5px; font-size: 12px; }

        /* --- åœ£è¯è€äººå‰§æƒ…é¡µ --- */
        #santa-story-img {
            width: 90%; max-width: 400px; object-fit: contain; margin-bottom: 30px;
            filter: drop-shadow(0 0 30px var(--gold)); transform: scale(0.8); opacity: 0;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .santa-appear { transform: scale(1.1) !important; opacity: 1 !important; }
        .shake-alert { color: #ff3333; font-size: 22px; font-weight: bold; text-align: center; text-shadow: 0 0 10px #000; animation: pulseFast 0.5s infinite; }
        @keyframes pulseFast { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
        .shake-success { color: var(--gold); font-size: 22px; font-weight: bold; text-align: center; text-shadow: 0 0 10px var(--gold-glow); }

        /* --- AR æ ¸å¿ƒåœºæ™¯é¡µ --- */
        /* å‰ç½®æ‘„åƒå¤´è§†é¢‘ï¼šå…³é”®æ˜¯ scaleX(-1) å®ç°é•œåƒ */
        #ar-camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2; transform: scaleX(-1); background: #000;
        }
        /* ä¼ª 3D å®¹å™¨ */
        #ar-tree-container {
            position: relative; width: 300px; height: 400px;
            perspective: 1200px; /* é€è§†æ·±åº¦ */
            transform-style: preserve-3d; /* ä¿ç•™ 3D ç©ºé—´ */
            transition: transform 0.1s linear; /* æ‰‹åŠ¿è·Ÿæ‰‹çš„å¹³æ»‘åº¦ */
            /* åˆå§‹çŠ¶æ€ï¼šç¼©å°ä¸”é€æ˜ */
            transform: scale(0) rotateY(0deg); opacity: 0;
        }
        /* åœ£è¯æ ‘ PNG å›¾ç‰‡ */
        #ar-tree-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 40px var(--gold-glow)) brightness(1.1);
            /* é‡è¦ï¼šè®©æ‰‹åŠ¿äº‹ä»¶ç©¿é€å›¾ç‰‡ï¼Œç”±çˆ¶å®¹å™¨æˆ–èƒŒæ™¯å±‚æ¥æ”¶ */
            pointer-events: none; 
            will-change: transform;
        }
        /* AR UI å±‚ */
        .ar-ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* UI ä¸æŒ¡æ‰‹åŠ¿ */
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px 20px;
        }
        .ar-timer { align-self: flex-end; font-size: 36px; font-weight: 800; text-shadow: 0 0 10px #000; }
        .ar-guide {
            align-self: center; text-align: center; background: rgba(0,0,0,0.6);
            padding: 15px; border-radius: 12px; border: 1px solid var(--gold-glow);
            animation: floatGuide 2s infinite ease-in-out;
        }
        @keyframes floatGuide { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        /* =========================================
           3. å¼¹çª—ä¸ç‰¹æ•ˆå±‚
           ========================================= */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-body {
            background: var(--glass-bg); border: 1px solid var(--gold);
            padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px;
            box-shadow: 0 0 40px var(--gold-glow); transform: scale(0.9); transition: 0.3s;
        }
        .modal-body.show { transform: scale(1); }

        /* ç¤¼ç‰©é£å‡ºåŠ¨ç”» */
        #flying-gift {
            position: fixed; top: 50%; left: 50%; font-size: 100px; z-index: 200;
            transform: translate(-50%, -50%) scale(0); pointer-events: none;
        }
        /* ç²’å­çˆ†ç‚¸å®¹å™¨ */
        #explosion-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .boom-particle { position: absolute; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold-glow); }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <section id="view-login" class="view-section active">
        <div class="bg-anim-item anim-car">ğŸï¸</div>
        <div class="bg-anim-item anim-tree">ğŸ„</div>
        <div class="bg-anim-item anim-santa">ğŸ…</div>
        
        <div class="login-panel">
            <h2 style="margin-top:0; text-shadow: 0 0 10px var(--gold);">VIP ACCESS</h2>
            <div style="margin-bottom:20px; font-size:14px; color:#aaa;">å¼€å¯ä½ çš„é‡‘è‰²åœ£è¯ä¹‹æ—…</div>
            <input type="tel" class="input-gold" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            <input type="text" class="input-gold" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
            <button class="btn-gold" onclick="app.handleLogin()">ç«‹å³ç™»å½•</button>
        </div>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="margin-bottom:40px; text-shadow: 0 0 15px var(--gold);">é€‰æ‹©ä½ çš„è‹±é›„</h2>
        <div class="hero-grid">
            <div class="hero-card unlocked" onclick="app.toast('å·²è£…å¤‡ï¼šé‡‘è‰²ç›èæ‹‰è’‚')">
                <div class="hero-icon">ğŸï¸</div>
                <div class="hero-name">é»„é‡‘ GT</div>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.handleTreeClick()">
                <div class="lock-tag">ğŸ”’</div>
                <div class="hero-icon">ğŸ„</div>
                <div class="hero-name">å¹»å½±æ ‘</div>
            </div>
            <div class="hero-card locked" onclick="app.toast('æ•¬è¯·æœŸå¾…')">
                <div class="hero-icon">â“</div>
                <div class="hero-name">ç¥ç§˜å˜‰å®¾</div>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ä½ çš„ç¥ç¦</h2>
        <p style="color:#aaa; font-size:14px; margin-bottom:30px;">(æœ€å¤š20å­—ï¼Œå°†ç”Ÿæˆä¸“å±æ•°å­—ç¤¼ç‰©)</p>
        <input type="text" id="wish-input" class="input-gold" style="width:80%;" maxlength="20" placeholder="ä¾‹å¦‚ï¼šé—ºèœœä»Šå¹´ä¸€èµ·æš´å¯Œï¼">
        <button class="btn-gold" onclick="app.confirmWish()">ç¡®è®¤ç”Ÿæˆ</button>
    </section>

    <section id="view-santa" class="view-section">
        <img id="santa-story-img" src="image_2.png" alt="Santa">
        <div id="santa-hint" class="shake-alert">
            é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼<br>ä¸ç„¶åœ£è¯è€äººè¦æ’ä¸Šä½ äº†ï¼
        </div>
        <button onclick="app.triggerShakeMock()" style="margin-top:30px; background:none; border:1px solid #666; color:#888; padding:6px 12px; border-radius:20px; font-size:12px;">
            (ç”µè„‘ç«¯ç‚¹æ­¤æ¨¡æ‹Ÿæ‘‡æ™ƒ)
        </button>
    </section>

    <section id="view-ar" class="view-section" style="background: #000;">
        <video id="ar-camera-feed" autoplay playsinline muted></video>
        
        <div id="ar-tree-container">
            <img id="ar-tree-img" src="image_3.png" alt="Golden AR Tree">
        </div>

        <div class="ar-ui-overlay">
            <div id="ar-timer" class="ar-timer">12s</div>
            <div class="ar-guide">
                ğŸ‘‹ <span style="color:var(--gold); font-weight:bold;">æ‰‹åŠ¿æ§åˆ¶</span><br>
                å·¦å³æ»‘åŠ¨æ—‹è½¬ | æåˆç¼©æ”¾<br>
                <span style="font-size:12px; opacity:0.8;">(ä½¿ç”¨å‰ç½®æ‘„åƒå¤´ï¼Œä¸ä¼šæ‹æ‘„ä½ çš„è„¸)</span>
            </div>
        </div>
    </section>

    <div id="flying-gift">ğŸ</div>
    <div id="explosion-layer"></div>

    <div id="modal" class="modal-mask">
        <div class="modal-body" id="modal-box">
            <h3 id="modal-title" style="color:var(--gold); margin-top:0;">æç¤º</h3>
            <p id="modal-content" style="color:#ccc; margin:20px 0;">å†…å®¹</p>
            <div id="modal-btns" style="display:flex; justify-content:center;"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                treeUnlocked: false, // æ ‘æ˜¯å¦å·²è§£é”
                passedSantaFlow: false, // æ˜¯å¦èµ°è¿‡åœ£è¯è€äººæµç¨‹
                shakeCount: 0, // æ‘‡æ™ƒæ¬¡æ•°
                cameraStream: null, // æ‘„åƒå¤´æµ
                isArRunning: false // AR æ˜¯å¦æ­£åœ¨è¿è¡Œ
            },

            init() {
                this.initParticles(); // å¯åŠ¨èƒŒæ™¯ç²’å­
                console.log("Golden AR App Initialized.");
            },

            // --- è§†å›¾åˆ‡æ¢ä¸èµ„æºç®¡ç† ---
            switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                // ç¦»å¼€ AR ç•Œé¢æ—¶å¿…é¡»å…³é—­æ‘„åƒå¤´
                if (viewId !== 'view-ar') this.stopCamera();
            },

            // --- 1. ç™»å½•é€»è¾‘ ---
            handleLogin() {
                const btn = document.querySelector('#view-login .btn-gold');
                const originalText = btn.innerText;
                btn.innerText = "æ­£åœ¨éªŒè¯..."; btn.disabled = true;
                setTimeout(() => {
                    btn.innerText = "ç™»å½•æˆåŠŸ";
                    setTimeout(() => {
                        this.switchView('view-hero');
                        btn.innerText = originalText; btn.disabled = false;
                    }, 800);
                }, 1200);
            },

            // --- 2. é€‰è§’é€»è¾‘ ---
            handleTreeClick() {
                if (this.state.treeUnlocked) {
                    this.showModal("å·²è§£é”", "åœ£è¯æ ‘å·²å±äºä½ ï¼Œæ˜¯å¦å†æ¬¡ä½“éªŒ AR ç‰¹æ•ˆï¼Ÿ", [
                        { text: "å–æ¶ˆ", action: () => this.closeModal() },
                        { text: "å†æ¬¡ä½“éªŒ", action: () => { this.closeModal(); this.startArFlow(); } }
                    ]);
                } else {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±åœ£è¯æ•°å­—ç¤¼ç‰©ï¼Ÿ", [
                        { text: "å¦ (ç›´æ¥ä½“éªŒ)", action: () => { this.closeModal(); this.startArFlow(); } },
                        { text: "æ˜¯ (å»å®šåˆ¶)", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            // --- 3. å®šåˆ¶é€»è¾‘ ---
            confirmWish() {
                const input = document.getElementById('wish-input');
                if (!input.value.trim()) return this.toast("è¯·å…ˆè¾“å…¥ç¥ç¦å†…å®¹~");
                this.startSantaFlow();
            },

            // --- 4. åœ£è¯è€äººæ‘‡ä¸€æ‘‡å‰§æƒ… ---
            startSantaFlow() {
                this.switchView('view-santa');
                const img = document.getElementById('santa-story-img');
                const hint = document.getElementById('santa-hint');
                // é‡ç½®çŠ¶æ€
                this.state.shakeCount = 0;
                img.classList.remove('santa-appear');
                hint.className = 'shake-alert'; hint.innerHTML = "é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹æœºï¼<br>ä¸ç„¶åœ£è¯è€äººè¦æ’ä¸Šä½ äº†ï¼";
                
                // å…¥åœºåŠ¨ç”»
                setTimeout(() => img.classList.add('santa-appear'), 100);

                // å¼€å¯è®¾å¤‡åŠ¨ä½œç›‘å¬
                this.shakeHandler = (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if (!acc) return;
                    // è®¡ç®—ç¬æ—¶åŠ é€Ÿåº¦å¹…åº¦
                    const delta = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                    if (delta > 25) this.handleShakeAction(); // é˜ˆå€¼å¯è°ƒ
                };
                window.addEventListener('devicemotion', this.shakeHandler);
            },

            triggerShakeMock() { this.handleShakeAction(2); }, // ç”µè„‘ç«¯æ¨¡æ‹Ÿ

            handleShakeAction(amount = 1) {
                this.state.shakeCount += amount;
                // ç®€å•çš„è§†è§‰åé¦ˆ
                document.getElementById('santa-story-img').style.transform = `scale(1.15) rotate(${Math.random()*6-3}deg)`;

                if (this.state.shakeCount >= 8) { // æ‘‡æ™ƒè¾¾æˆ
                    window.removeEventListener('devicemotion', this.shakeHandler);
                    this.finishSantaFlow();
                }
            },

            finishSantaFlow() {
                const hint = document.getElementById('santa-hint');
                hint.className = 'shake-success'; hint.innerText = "åœ£è¯è€äººæ”¶åˆ°ä½ çš„ä¿¡å·ï¼ç¤¼ç‰©å·²é€å‡ºï¼";
                document.getElementById('santa-story-img').style.transform = "scale(1.1)";

                // ç¤¼ç‰©é£å‡ºåŠ¨ç”»
                const gift = document.getElementById('flying-gift');
                gift.style.transition = "all 0.8s cubic-bezier(0.6, 0.05, 0.2, 0.99)";
                gift.style.opacity = 1;
                gift.style.transform = "translate(-50%, -50%) scale(20)"; // æ”¾å¤§å†²å‘å±å¹•

                setTimeout(() => {
                    document.body.style.background = "#000"; // é»‘å±è¿‡æ¸¡
                    setTimeout(() => {
                        gift.style.display = 'none'; gift.style.transform = "translate(-50%, -50%) scale(0)"; // é‡ç½®ç¤¼ç‰©
                        document.body.style.background = ""; // æ¢å¤èƒŒæ™¯
                        this.state.passedSantaFlow = true; // æ ‡è®°å·²é€šè¿‡å‰§æƒ…
                        this.startArFlow(); // è¿›å…¥ AR
                    }, 500);
                }, 800);
            },

            // --- 5. AR æ ¸å¿ƒæµç¨‹ (å‰ç½®æ‘„åƒå¤´ + æ‰‹åŠ¿) ---
            async startArFlow() {
                this.switchView('view-ar');
                this.state.isArRunning = true;
                const videoEl = document.getElementById('ar-camera-feed');
                const treeContainer = document.getElementById('ar-tree-container');
                const timerEl = document.getElementById('ar-timer');

                // A. å¼€å¯å‰ç½®æ‘„åƒå¤´
                try {
                    // å…³é”®å‚æ•°ï¼šfacingMode: 'user' è¯·æ±‚å‰ç½®
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    videoEl.srcObject = stream;
                    this.state.cameraStream = stream;
                } catch (e) {
                    this.toast("æ— æ³•è®¿é—®å‰ç½®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
                    console.error("Camera Error:", e);
                    // å¯ä»¥è®¾ç½®ä¸€ä¸ª fallback èƒŒæ™¯å›¾ï¼Œè¿™é‡Œæš‚ç•¥
                }

                // B. åœ£è¯æ ‘å…¥åœºä¸æ‰‹åŠ¿åˆå§‹åŒ–
                treeContainer.style.transform = "scale(0) rotateY(0deg)"; treeContainer.style.opacity = 0; // é‡ç½®
                setTimeout(() => {
                    treeContainer.style.opacity = 1;
                    treeContainer.style.transform = "scale(1) rotateY(0deg)"; // æ”¾å¤§å‡ºç°
                    // åŠ¨ç”»ç»“æŸåå¼€å¯æ‰‹åŠ¿æ§åˆ¶
                    setTimeout(() => this.initGestures(), 1000);
                }, 500);

                // C. 12ç§’å€’è®¡æ—¶
                let timeLeft = 12;
                timerEl.innerText = "12s";
                this.arTimer = setInterval(() => {
                    if (!this.state.isArRunning) return clearInterval(this.arTimer);
                    timeLeft--; timerEl.innerText = timeLeft + "s";
                    if (timeLeft <= 0) {
                        clearInterval(this.arTimer);
                        this.explodeTree(); // è§¦å‘çˆ†ç‚¸
                    }
                }, 1000);
            },

            // æ ¸å¿ƒï¼šä¼ª 3D æ‰‹åŠ¿æ§åˆ¶å®ç°
            initGestures() {
                const touchSurface = document.getElementById('view-ar');
                const target = document.getElementById('ar-tree-container');
                let startX = 0, currentRotY = 0; // æ—‹è½¬ç›¸å…³
                let startDist = 0, currentScale = 1; // ç¼©æ”¾ç›¸å…³
                let isDragging = false, isPinching = false;

                // è®¡ç®—ä¸¤æŒ‡è·ç¦»
                const getDist = (t1, t2) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);

                touchSurface.ontouchstart = (e) => {
                    if (e.touches.length === 1) { // å•æŒ‡æ‹–åŠ¨æ—‹è½¬
                        startX = e.touches[0].clientX; isDragging = true;
                    } else if (e.touches.length === 2) { // åŒæŒ‡æåˆç¼©æ”¾
                        startDist = getDist(e.touches[0], e.touches[1]); isPinching = true;
                    }
                };
                touchSurface.ontouchmove = (e) => {
                    e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
                    if (isDragging && e.touches.length === 1) {
                        const deltaX = e.touches[0].clientX - startX;
                        // çµæ•åº¦ 0.4ï¼Œå°†æ°´å¹³ä½ç§»æ˜ å°„ä¸ºæ—‹è½¬è§’åº¦
                        const newRot = currentRotY + deltaX * 0.4;
                        target.style.transform = `scale(${currentScale}) rotateY(${newRot}deg)`;
                    } else if (isPinching && e.touches.length === 2) {
                        const newDist = getDist(e.touches[0], e.touches[1]);
                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œé™åˆ¶åœ¨ 0.5 åˆ° 2 å€ä¹‹é—´
                        const scaleDelta = (newDist / startDist) * currentScale;
                        target.style.transform = `scale(${Math.min(Math.max(scaleDelta, 0.5), 2)}) rotateY(${currentRotY}deg)`;
                    }
                };
                touchSurface.ontouchend = (e) => {
                    if (isDragging) { // ä¿å­˜å½“å‰æ—‹è½¬è§’åº¦
                        currentRotY += (e.changedTouches[0].clientX - startX) * 0.4; isDragging = false;
                    }
                    if (isPinching && e.touches.length < 2) { // ä¿å­˜å½“å‰ç¼©æ”¾æ¯”ä¾‹
                        const newDist = getDist(e.changedTouches[0], e.touches[0] || e.changedTouches[1]);
                        currentScale = Math.min(Math.max((newDist / startDist) * currentScale, 0.5), 2); isPinching = false;
                    }
                };
            },

            stopCamera() {
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(t => t.stop());
                    this.state.cameraStream = null;
                }
                this.state.isArRunning = false;
            },

            // --- 6. çˆ†ç‚¸ä¸ç»“ç®— ---
            explodeTree() {
                const treeImg = document.getElementById('ar-tree-img');
                const rect = treeImg.getBoundingClientRect();
                // é«˜äº®é¢„è­¦
                treeImg.style.transition = "0.3s"; treeImg.style.filter = "brightness(5) drop-shadow(0 0 50px gold)";
                setTimeout(() => {
                    treeImg.style.opacity = 0; // æ¶ˆå¤±
                    // åœ¨æ ‘çš„ä½ç½®ç”Ÿæˆçˆ†ç‚¸ç²’å­
                    this.spawnExplosion(rect.left + rect.width/2, rect.top + rect.height/2);
                    this.stopCamera();
                    // å»¶è¿Ÿè·³è½¬
                    setTimeout(() => this.handleArFinish(), 1500);
                }, 300);
            },

            handleArFinish() {
                if (this.state.passedSantaFlow) {
                    // èµ°å®Œæµç¨‹ï¼šè§£é”æˆåŠŸ
                    this.state.treeUnlocked = true;
                    const card = document.getElementById('card-tree');
                    card.classList.remove('locked'); card.classList.add('unlocked');
                    card.querySelector('.lock-tag').style.display = 'none';
                    this.toast("ğŸ‰ ä½“éªŒå®Œæˆï¼é‡‘è‰²åœ£è¯æ ‘å·²æ°¸ä¹…è§£é”ï¼", 3000);
                    this.switchView('view-hero');
                    this.state.passedSantaFlow = false; // é‡ç½®æµç¨‹çŠ¶æ€
                } else {
                    // ç›´æ¥ä½“éªŒçš„ï¼šæç¤ºå»å®šåˆ¶
                    this.showModal("ä½“éªŒç»“æŸ", "æƒ³æ‹¥æœ‰æ°¸ä¹…çš„é‡‘è‰²åœ£è¯æ ‘å¹¶å®šåˆ¶ç¤¼ç‰©å—ï¼Ÿ", [
                        { text: "è¿”å›ä¸»é¡µ", action: () => { this.closeModal(); this.switchView('view-hero'); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
                 // æ¢å¤æ ‘çš„çŠ¶æ€ä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨
                 setTimeout(() => {
                    const treeImg = document.getElementById('ar-tree-img');
                    treeImg.style.opacity = 1; treeImg.style.filter = "";
                 }, 1000);
            },

            // --- é€šç”¨ç»„ä»¶ï¼šå¼¹çª—ã€Toastã€ç²’å­ ---
            showModal(title, content, btns) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerText = content;
                const btnGroup = document.getElementById('modal-btns'); btnGroup.innerHTML = '';
                btns.forEach(b => {
                    const btn = document.createElement('button'); btn.className = 'btn-outline';
                    btn.innerText = b.text; btn.onclick = b.action; btnGroup.appendChild(btn);
                });
                document.getElementById('modal').style.display = 'flex';
                setTimeout(() => document.getElementById('modal-box').classList.add('show'), 10);
            },
            closeModal() {
                document.getElementById('modal-box').classList.remove('show');
                setTimeout(() => document.getElementById('modal').style.display = 'none', 300);
            },
            toast(msg, time=2000) {
                // ç®€å•å®ç°ï¼šç”¨ alert ä»£æ›¿ toastï¼Œå®é™…é¡¹ç›®å¯å†™ DOM toast
                // ä¸ºäº†æ¼”ç¤ºæµç•…æ€§ï¼Œè¿™é‡Œä¸´æ—¶ç”¨ consoleï¼Œå®é™…å¯ç”¨è‡ªå®šä¹‰ UI
                console.log("TOAST:", msg); 
                // å¦‚æœéœ€è¦ UI Toastï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ DOM
            },

            // çˆ†ç‚¸ç²’å­æ•ˆæœ
            spawnExplosion(x, y) {
                const container = document.getElementById('explosion-layer');
                for (let i = 0; i < 60; i++) {
                    const p = document.createElement('div'); p.className = 'boom-particle';
                    const size = Math.random() * 8 + 3;
                    p.style.cssText = `width:${size}px; height:${size}px; left:${x}px; top:${y}px;`;
                    container.appendChild(p);
                    const angle = Math.random() * Math.PI * 2; const vel = Math.random() * 200 + 80;
                    p.animate([
                        { transform: 'translate(0,0) scale(1)', opacity: 1 },
                        { transform: `translate(${Math.cos(angle)*vel}px, ${Math.sin(angle)*vel}px) scale(0)`, opacity: 0 }
                    ], { duration: 800 + Math.random()*600, easing: 'cubic-bezier(0,.9,.57,1)' }).onfinish = () => p.remove();
                }
            },

            // èƒŒæ™¯ç¯å¢ƒç²’å­
            initParticles() {
                const canvas = document.getElementById('particle-canvas');
                const ctx = canvas.getContext('2d');
                let w, h; const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();
                const parts = Array.from({length: 50}, () => ({ x: Math.random()*w, y: Math.random()*h, s: Math.random()*2, sp: Math.random()*0.5+0.2 }));
                function draw() {
                    ctx.clearRect(0,0,w,h); ctx.fillStyle = "rgba(255, 215, 0, 0.5)";
                    parts.forEach(p => {
                        p.y -= p.sp; if(p.y < 0) p.y = h;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    });
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // å¯åŠ¨åº”ç”¨
        window.onload = () => app.init();
    </script>
</body>
</html>
