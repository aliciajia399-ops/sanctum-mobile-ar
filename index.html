<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden AR Christmas - Gesture Edition</title>
    <style>
        /* ========================
           1. å…¨å±€æ ·å¼ (Global Styles)
           ======================== */
        :root {
            --gold: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --dark-bg: #050505;
            --glass: rgba(10, 10, 10, 0.85);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--dark-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, sans-serif;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            color: var(--gold);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç²’å­èƒŒæ™¯ç”»å¸ƒ (å±‚çº§æœ€ä½) */
        #particle-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        /* è§†å›¾å®¹å™¨ï¼šç”¨äºåˆ‡æ¢ç•Œé¢ */
        .view-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; transition: opacity 0.6s ease;
            background: rgba(0,0,0,0.4); /* è½»å¾®é®ç½©è®©æ–‡å­—æ›´æ¸…æ™° */
        }
        .view-section.active { display: flex; opacity: 1; }

        /* é€šç”¨é‡‘è‰²æŒ‰é’® */
        .btn-gold {
            background: linear-gradient(135deg, #b8860b, #ffd700);
            border: none; color: #000; padding: 12px 30px;
            font-size: 16px; font-weight: bold; border-radius: 25px;
            cursor: pointer; box-shadow: 0 0 15px var(--gold-glow);
            transition: transform 0.2s, box-shadow 0.2s; margin-top: 20px;
        }
        .btn-gold:active { transform: scale(0.95); }

        /* ========================
           2. ç™»å½•é¡µ & èƒŒæ™¯åŠ¨ç”»
           ======================== */
        /* èƒŒæ™¯æ¼‚æµ®å…ƒç´ å®¹å™¨ */
        #bg-anim-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden;
        }
        
        .anim-element { position: absolute; font-size: 40px; opacity: 0.8; filter: drop-shadow(0 0 10px gold); }
        /* ç›èæ‹‰è’‚åŠ¨ç”» */
        .maserati-anim { bottom: 20%; left: -100px; animation: driveRight 3s linear infinite; animation-delay: 2s; }
        @keyframes driveRight { 0% { left: -100px; opacity:0; } 20% { opacity:1; } 80% { opacity:1; } 100% { left: 110%; opacity:0; } }
        /* æ—‹è½¬é£ç«è½®èƒŒæ™¯ */
        .wheel-bg {
            position: absolute; width: 300px; height: 300px; border-radius: 50%;
            border: 2px dashed var(--gold); opacity: 0.3;
            animation: spin 10s linear infinite; z-index: -1;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .login-panel {
            width: 80%; max-width: 320px; padding: 30px;
            background: var(--glass); border: 1px solid var(--gold); border-radius: 15px;
            text-align: center; backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .input-gold {
            width: 100%; padding: 10px; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #555;
            color: var(--gold); border-radius: 5px; box-sizing: border-box;
        }

        /* ========================
           3. è‹±é›„é€‰æ‹©é¡µ
           ======================== */
        .hero-container {
            display: flex; gap: 15px; justify-content: center; align-items: center;
            perspective: 800px;
        }
        .hero-card {
            width: 90px; height: 140px; background: rgba(20, 20, 20, 0.9);
            border: 1px solid #444; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s, border-color 0.3s;
            position: relative; animation: floatCard 3s ease-in-out infinite;
        }
        .hero-card:nth-child(2) { animation-delay: 0.5s; }
        .hero-card:nth-child(3) { animation-delay: 1s; }
        @keyframes floatCard { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .hero-card.unlocked { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }
        .hero-card.locked { filter: grayscale(100%) brightness(0.6); }
        .hero-icon { font-size: 36px; margin-bottom: 8px; }
        .lock-badge { position: absolute; top: 5px; right: 5px; font-size: 12px; }

        /* ========================
           4. åœ£è¯è€äººé¡µ (æ‘‡ä¸€æ‘‡)
           ======================== */
        #santa-img {
            width: 90%; max-width: 350px; object-fit: contain;
            filter: drop-shadow(0 0 20px var(--gold));
            transform: scale(0); transition: transform 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        .shake-hint {
            color: #ff4444; font-size: 22px; font-weight: bold;
            text-shadow: 0 0 10px #000; margin-top: 20px; text-align: center;
            animation: pulseText 0.5s infinite alternate;
        }
        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* ========================
           5. AR åœºæ™¯ (æ ¸å¿ƒ)
           ======================== */
        /* è§†é¢‘èƒŒæ™¯ */
        #ar-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2;
            /* åªæœ‰åœ¨å‰ç½®æ‘„åƒå¤´æ—¶æ‰éœ€è¦ scaleX(-1)ï¼Œåç½®é€šå¸¸ä¸éœ€è¦ï¼Œä½†ä¸ºäº†ä¿é™©å¯ä»¥JSåˆ¤æ–­ï¼Œè¿™é‡Œé»˜è®¤æ­£å¸¸ */
            background: #000; /* è§†é¢‘åŠ è½½å‰çš„åº•è‰² */
        }
        
        /* å¤‡ç”¨èƒŒæ™¯ (å½“æ‹’ç»æƒé™æ—¶) */
        #ar-fallback-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #222, #000);
            z-index: -3; display: none;
        }

        /* 3D æ—‹è½¬å®¹å™¨ */
        #ar-content-container {
            position: relative;
            width: 300px; height: 400px;
            /* å…³é”®ï¼šé€è§†æ•ˆæœï¼Œè®©æ—‹è½¬çœ‹èµ·æ¥åƒ 3D */
            perspective: 1000px; 
            transform-style: preserve-3d;
            /* åˆå§‹éšè—ï¼Œç”± JS æ§åˆ¶å…¥åœº */
            transform: scale(0) rotateY(0deg); 
            transition: transform 0.1s linear; /* æ—‹è½¬æ—¶çš„å¹³æ»‘è¿‡æ¸¡ */
        }

        #ar-tree-image {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 0 30px var(--gold-glow));
            /* é¿å…æ—‹è½¬åˆ°èƒŒé¢ä¸å¯è§ï¼Œè™½ç„¶æ˜¯2Då›¾ï¼Œä½†æˆ‘ä»¬è¦æ¨¡æ‹Ÿ3D */
            backface-visibility: visible; 
            pointer-events: none; /* è®©æ‰‹åŠ¿äº‹ä»¶ç©¿é€åˆ°çˆ¶å®¹å™¨æˆ– document */
        }

        /* AR UI æµ®å±‚ */
        .ar-ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* è®©æ“ä½œç©¿é€ï¼Œé™¤äº†æŒ‰é’® */
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        .ar-timer {
            align-self: flex-end; font-size: 32px; font-weight: bold;
            color: var(--gold); text-shadow: 0 0 5px #000;
        }

        .ar-guide-text {
            align-self: center; margin-bottom: 40px; font-size: 16px;
            color: #fff; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;
            border: 1px solid rgba(255,215,0,0.3);
            animation: floatUp 2s infinite; text-align: center;
        }
        @keyframes floatUp { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        /* ========================
           6. å¼¹çª—ä¸ç‰¹æ•ˆ
           ======================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1a1a1a; border: 1px solid var(--gold);
            padding: 25px; border-radius: 12px; text-align: center; width: 80%;
            box-shadow: 0 0 40px var(--gold-glow);
        }
        .modal-btn-group { display: flex; justify-content: space-around; margin-top: 20px; }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 20px; font-size: 14px;
        }

        /* ç¤¼ç‰©é£å…¥åŠ¨ç”» */
        #gift-fly {
            position: fixed; top: 50%; left: 50%; font-size: 80px;
            transform: translate(-50%, -50%) scale(0); z-index: 200; pointer-events: none;
        }

        /* ç²’å­ */
        #explosion-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .particle { position: absolute; background: var(--gold); border-radius: 50%; }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <section id="view-login" class="view-section active">
        <div id="bg-anim-layer">
            <div class="wheel-bg" style="top:10%; right:-50px;"></div>
            <div class="anim-element maserati-anim">ğŸï¸</div>
            <div class="anim-element" style="top:15%; right:20px; animation: floatCard 4s infinite;">ğŸ„</div>
        </div>
        
        <div class="login-panel">
            <h2 style="color:var(--gold); margin-top:0;">VIP ACCESS</h2>
            <input type="tel" class="input-gold" placeholder="æ‰‹æœºå· (ä»»æ„)">
            <input type="text" class="input-gold" placeholder="éªŒè¯ç  (ä»»æ„)">
            <button class="btn-gold" onclick="app.login()">ç«‹å³ç™»å½•</button>
        </div>
    </section>

    <section id="view-hero" class="view-section">
        <h2 style="text-shadow: 0 0 10px var(--gold);">é€‰æ‹©ä½ çš„è‹±é›„</h2>
        <div class="hero-container">
            <div class="hero-card unlocked" onclick="alert('å·²è£…å¤‡ï¼šé‡‘è‰²ç›èæ‹‰è’‚')">
                <div class="hero-icon">ğŸï¸</div>
                <div style="font-size:12px; color:var(--gold);">é»„é‡‘ GT</div>
            </div>
            <div id="card-tree" class="hero-card locked" onclick="app.handleTreeCardClick()">
                <div class="lock-badge">ğŸ”’</div>
                <div class="hero-icon">ğŸ„</div>
                <div style="font-size:12px; color:#aaa;">å¹»å½±æ ‘</div>
            </div>
            <div class="hero-card locked" onclick="alert('æ•¬è¯·æœŸå¾…')">
                <div class="hero-icon">â“</div>
                <div style="font-size:12px; color:#aaa;">ç¥ç§˜å˜‰å®¾</div>
            </div>
        </div>
    </section>

    <section id="view-customize" class="view-section">
        <h2>å®šåˆ¶ä½ çš„ç¥ç¦</h2>
        <input type="text" id="wish-input" class="input-gold" style="width: 80%; text-align:center;" maxlength="20" placeholder="ä¾‹å¦‚ï¼šé—ºèœœä»Šå¹´ä¸€èµ·æš´å¯Œ">
        <button class="btn-gold" onclick="app.confirmCustomize()">ç¡®è®¤ç”Ÿæˆ</button>
    </section>

    <section id="view-santa" class="view-section">
        <img id="santa-img" src="image_1.png" alt="Santa Claus">
        
        <div id="santa-text" class="shake-hint">
            é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹ï¼<br>é¿å…åœ£è¯è€äººæ’ä¸Šä½ ï¼
        </div>

        <button onclick="app.triggerShake(3)" style="margin-top:20px; background:none; border:1px solid #555; color:#777; padding:5px 10px; border-radius:15px; font-size:12px;">
            (ç”µè„‘ç«¯ç‚¹å‡»æ¨¡æ‹Ÿæ‘‡æ‰‹)
        </button>
    </section>

    <section id="view-ar" class="view-section" style="background:transparent;">
        <video id="ar-video" autoplay playsinline muted></video>
        <div id="ar-fallback-bg"></div>

        <div id="ar-content-container">
            <img id="ar-tree-image" src="image_0.png" alt="Golden AR Tree">
        </div>

        <div class="ar-ui-layer">
            <div id="ar-timer" class="ar-timer">12s</div>
            <div class="ar-guide-text">
                éœ€è¦æ‰“å¼€ã€åç½®ã€‘æ‘„åƒå¤´<br>
                âœ‹ å·¦å³æ»‘åŠ¨å±å¹•ï¼Œæ—‹è½¬æŸ¥çœ‹åœ£è¯æ ‘<br>
                (ä¸ä¼šæ‹æ‘„ä½ çš„è„¸)
            </div>
        </div>
    </section>

    <div id="gift-fly">ğŸ</div>
    <div id="explosion-container"></div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="color:var(--gold); margin-top:0;">æ ‡é¢˜</h3>
            <p id="modal-content" style="color:#ccc; font-size:14px; line-height:1.5;">å†…å®¹</p>
            <div id="modal-btns" class="modal-btn-group"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                treeUnlocked: false, // æ ‘æ˜¯å¦è§£é”
                isSantaFlow: false,  // æ˜¯å¦åˆšèµ°å®Œåœ£è¯è€äººæµç¨‹
                videoStream: null,   // æ‘„åƒå¤´æµ
                shakeCount: 0,       // æ‘‡ä¸€æ‘‡è®¡æ•°
                isArActive: false    // AR åœºæ™¯æ˜¯å¦æ¿€æ´»
            },

            init() {
                this.initParticles();
                console.log("App Initialized: Gesture Edition");
            },

            // --- è§†å›¾åˆ‡æ¢ ---
            switchView(viewId) {
                // åˆ‡æ¢ class
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(viewId);
                if(target) target.classList.add('active');

                // èµ„æºç®¡ç†ï¼šå¦‚æœåœ¨ AR ç•Œé¢ï¼Œä¸åšå¤„ç†ï¼›å¦‚æœç¦»å¼€äº† AR ç•Œé¢ï¼Œå…³é—­æ‘„åƒå¤´
                if (viewId !== 'view-ar') {
                    this.stopCamera();
                    this.state.isArActive = false;
                }
            },

            // --- 1. ç™»å½•é€»è¾‘ ---
            login() {
                const btn = document.querySelector('#view-login .btn-gold');
                const originalText = btn.innerText;
                btn.innerText = "æ­£åœ¨éªŒè¯...";
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerText = "ç™»å½•æˆåŠŸ";
                    setTimeout(() => {
                        this.switchView('view-hero');
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }, 800);
                }, 1000);
            },

            // --- 2. è‹±é›„é€‰æ‹©é€»è¾‘ ---
            handleTreeCardClick() {
                if (this.state.treeUnlocked) {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "å†æ¬¡æ¬£èµ AR çƒŸèŠ±ç§€ï¼Ÿ", [
                        { text: "å–æ¶ˆ", action: () => this.closeModal() },
                        { text: "è¿›å…¥ AR", action: () => { this.closeModal(); this.startARScene(); } }
                    ]);
                } else {
                    this.showModal("å°Šè´µçš„ä¼šå‘˜", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±åœ£è¯ç¤¼ç‰©ï¼Ÿ", [
                        { text: "å¦ (ç›´æ¥ä½“éªŒ)", action: () => { this.closeModal(); this.startARScene(); } }, // ç›´æ¥ AR
                        { text: "æ˜¯ (ä¸“å±å®šåˆ¶)", action: () => { this.closeModal(); this.switchView('view-customize'); } } // å»å®šåˆ¶
                    ]);
                }
            },

            // --- 3. å®šåˆ¶é€»è¾‘ ---
            confirmCustomize() {
                const val = document.getElementById('wish-input').value;
                if (!val.trim()) return alert("è¯·è¾“å…¥ç¥ç¦å†…å®¹");
                
                this.switchView('view-santa');
                this.startSantaScene();
            },

            // --- 4. åœ£è¯è€äººæ‘‡ä¸€æ‘‡é€»è¾‘ ---
            startSantaScene() {
                const img = document.getElementById('santa-img');
                const text = document.getElementById('santa-text');
                
                // é‡ç½®
                this.state.shakeCount = 0;
                img.style.transform = "scale(0)";
                text.innerText = "é£å¿«æ‘‡åŠ¨ä½ çš„æ‰‹ï¼\né¿å…åœ£è¯è€äººæ’ä¸Šä½ ï¼";
                text.style.color = "#ff4444";

                // å…¥åœºåŠ¨ç”»
                setTimeout(() => img.style.transform = "scale(1.1)", 100);

                // ç›‘å¬æ‘‡åŠ¨
                this.shakeHandler = (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if (!acc) return;
                    const delta = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                    if (delta > 25) { // é˜ˆå€¼
                        this.triggerShake();
                    }
                };
                window.addEventListener('devicemotion', this.shakeHandler);
            },

            triggerShake(amount = 1) {
                this.state.shakeCount += amount;
                
                // è§†è§‰åé¦ˆ
                const img = document.getElementById('santa-img');
                img.style.transform = `scale(1.1) rotate(${Math.random()*10 - 5}deg)`;

                if (this.state.shakeCount >= 5) {
                    window.removeEventListener('devicemotion', this.shakeHandler);
                    this.finishSantaScene();
                }
            },

            finishSantaScene() {
                const text = document.getElementById('santa-text');
                text.innerText = "åœ£è¯è€äººæ”¶åˆ°äº†ä½ çš„ä¿¡å·ï¼";
                text.style.color = "var(--gold)";
                
                // ç¤¼ç‰©é£å…¥åŠ¨ç”»
                const gift = document.getElementById('gift-fly');
                gift.style.transition = "transform 0.8s cubic-bezier(0.6, 0.05, 0.2, 0.99)";
                gift.style.opacity = 1;
                gift.style.transform = "translate(-50%, -50%) scale(15)"; // å……æ»¡å±å¹•

                setTimeout(() => {
                    // é»‘å±è¿‡æ¸¡
                    document.body.style.background = "#000";
                    document.getElementById('view-santa').style.opacity = 0;
                    
                    setTimeout(() => {
                        // æ¸…ç†å¹¶è¿›å…¥ AR
                        gift.style.display = 'none';
                        gift.style.transform = "translate(-50%, -50%) scale(0)";
                        document.body.style.background = ""; // æ¢å¤
                        this.state.isSantaFlow = true;
                        this.startARScene();
                    }, 500);
                }, 800);
            },

            // --- 5. AR åœºæ™¯æ ¸å¿ƒé€»è¾‘ ---
            async startARScene() {
                this.switchView('view-ar');
                this.state.isArActive = true;

                // A. å¼€å¯æ‘„åƒå¤´
                const videoEl = document.getElementById('ar-video');
                const fallbackEl = document.getElementById('ar-fallback-bg');
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }, // åç½®
                        audio: false
                    });
                    videoEl.srcObject = stream;
                    this.state.videoStream = stream;
                    videoEl.style.display = 'block';
                    fallbackEl.style.display = 'none';
                } catch (err) {
                    console.warn("Camera failed:", err);
                    alert("å½“å‰æ— æ³•å¼€å¯æ‘„åƒå¤´ (å¯èƒ½æ˜¯æƒé™æ‹’ç»æˆ–ç³»ç»Ÿä¸æ”¯æŒ)ï¼Œå°†ä½¿ç”¨é»‘è‰²èƒŒæ™¯é¢„è§ˆã€‚");
                    videoEl.style.display = 'none';
                    fallbackEl.style.display = 'block';
                }

                // B. åœ£è¯æ ‘å…¥åœºåŠ¨ç”»
                const container = document.getElementById('ar-content-container');
                container.style.transition = "transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1)";
                container.style.transform = "scale(0) rotateY(0deg)"; // Reset
                
                setTimeout(() => {
                    container.style.transform = "scale(1) rotateY(0deg)";
                    // åŠ¨ç”»å®Œæˆåï¼Œå¼€å¯æ‰‹åŠ¿ç›‘å¬
                    setTimeout(() => {
                        container.style.transition = "transform 0.1s linear"; // åˆ‡æ¢ä¸ºè·Ÿæ‰‹æ¨¡å¼
                        this.initGestureControl();
                    }, 1200);
                }, 500);

                // C. å€’è®¡æ—¶
                let timeLeft = 12;
                const timerEl = document.getElementById('ar-timer');
                timerEl.innerText = "12s";
                
                this.arTimerInterval = setInterval(() => {
                    if (!this.state.isArActive) return clearInterval(this.arTimerInterval);
                    timeLeft--;
                    timerEl.innerText = timeLeft + "s";
                    if (timeLeft <= 0) {
                        clearInterval(this.arTimerInterval);
                        this.explodeTree();
                    }
                }, 1000);
            },

            // æ‰‹åŠ¿æ§åˆ¶ (Touch + Mouse)
            initGestureControl() {
                const zone = document.getElementById('view-ar');
                const target = document.getElementById('ar-content-container');
                let startX = 0;
                let currentRot = 0;
                let isDragging = false;

                const updateRot = (x) => {
                    const delta = x - startX;
                    // çµæ•åº¦ç³»æ•° 0.5
                    const newRot = currentRot + delta * 0.5;
                    target.style.transform = `scale(1) rotateY(${newRot}deg)`;
                };

                // Touch
                zone.ontouchstart = (e) => { startX = e.touches[0].clientX; isDragging = true; };
                zone.ontouchmove = (e) => { 
                    if(isDragging) {
                        e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
                        updateRot(e.touches[0].clientX); 
                    }
                };
                zone.ontouchend = (e) => { 
                    if(isDragging) {
                        currentRot += (e.changedTouches[0].clientX - startX) * 0.5;
                        isDragging = false;
                    }
                };

                // Mouse (PCæµ‹è¯•)
                zone.onmousedown = (e) => { startX = e.clientX; isDragging = true; };
                zone.onmousemove = (e) => { if(isDragging) updateRot(e.clientX); };
                zone.onmouseup = (e) => { 
                    if(isDragging) {
                        currentRot += (e.clientX - startX) * 0.5;
                        isDragging = false;
                    }
                };
            },

            stopCamera() {
                if (this.state.videoStream) {
                    this.state.videoStream.getTracks().forEach(track => track.stop());
                    this.state.videoStream = null;
                    document.getElementById('ar-video').srcObject = null;
                }
            },

            // --- 6. çˆ†ç‚¸ä¸ç»“ç®— ---
            explodeTree() {
                const img = document.getElementById('ar-tree-image');
                const rect = img.getBoundingClientRect();
                
                // é«˜äº®
                img.style.transition = "0.2s";
                img.style.filter = "brightness(5) drop-shadow(0 0 50px gold)";
                
                setTimeout(() => {
                    img.style.opacity = 0; // æ¶ˆå¤±
                    this.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2);
                    this.stopCamera(); // åœæ­¢æ‘„åƒå¤´

                    // å»¶è¿Ÿåç»“ç®—
                    setTimeout(() => {
                        this.handleAREnd();
                        // æ¢å¤æ ‘çš„çŠ¶æ€ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                        setTimeout(() => {
                            img.style.opacity = 1;
                            img.style.filter = "drop-shadow(0 0 30px var(--gold-glow))";
                            img.style.transform = "scale(1)";
                        }, 500);
                    }, 1500);
                }, 200);
            },

            createExplosion(x, y) {
                const container = document.getElementById('explosion-container');
                for (let i = 0; i < 80; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const size = Math.random() * 8 + 3;
                    p.style.cssText = `width:${size}px; height:${size}px; left:${x}px; top:${y}px;`;
                    container.appendChild(p);

                    // éšæœºæ‰©æ•£
                    const angle = Math.random() * Math.PI * 2;
                    const vel = Math.random() * 200 + 50; // çˆ†ç‚¸åŠå¾„
                    
                    p.animate([
                        { transform: 'translate(0,0) scale(1)', opacity: 1 },
                        { transform: `translate(${Math.cos(angle)*vel}px, ${Math.sin(angle)*vel}px) scale(0)`, opacity: 0 }
                    ], {
                        duration: 800 + Math.random() * 600,
                        easing: 'cubic-bezier(0, .9, .57, 1)'
                    }).onfinish = () => p.remove();
                }
            },

            handleAREnd() {
                // å¦‚æœæ˜¯ä»åœ£è¯è€äººæµç¨‹æ¥çš„ï¼Œæ°¸ä¹…è§£é”
                if (this.state.isSantaFlow) {
                    this.state.treeUnlocked = true;
                    // æ›´æ–° UI
                    const card = document.getElementById('card-tree');
                    card.classList.remove('locked');
                    card.classList.add('unlocked');
                    card.querySelector('.lock-badge').style.display = 'none';
                    card.querySelector('.hero-icon').style.filter = "none";
                    
                    alert("ä½“éªŒå®Œæˆï¼åœ£è¯æ ‘å·²æ°¸ä¹…è§£é”ã€‚");
                    this.switchView('view-hero');
                    this.state.isSantaFlow = false; // Reset flow
                } else {
                    // æ²¡èµ°å®šåˆ¶æµç¨‹ï¼Œæç¤ºå»å®šåˆ¶
                    this.showModal("AR ä½“éªŒç»“æŸ", "æ˜¯å¦å®šåˆ¶ä½ çš„ä¸“å±åœ£è¯ç¤¼ç‰©ï¼Ÿ", [
                        { text: "ä¸å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-hero'); } },
                        { text: "å»å®šåˆ¶", action: () => { this.closeModal(); this.switchView('view-customize'); } }
                    ]);
                }
            },

            // --- è¾…åŠ©åŠŸèƒ½ ---
            showModal(title, content, buttons) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerText = content;
                const btnGroup = document.getElementById('modal-btns');
                btnGroup.innerHTML = '';
                buttons.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-outline';
                    btn.innerText = b.text;
                    btn.onclick = b.action;
                    btnGroup.appendChild(btn);
                });
                document.getElementById('modal').style.display = 'flex';
            },
            closeModal() {
                document.getElementById('modal').style.display = 'none';
            },
            
            // èƒŒæ™¯ç²’å­æ•ˆæœ
            initParticles() {
                const canvas = document.getElementById('particle-canvas');
                const ctx = canvas.getContext('2d');
                let w, h;
                const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();
                
                const parts = Array.from({length: 60}, () => ({
                    x: Math.random()*w, y: Math.random()*h,
                    s: Math.random()*2, sp: Math.random()*0.5+0.2
                }));

                function draw() {
                    ctx.clearRect(0,0,w,h);
                    ctx.fillStyle = "rgba(255, 215, 0, 0.6)";
                    parts.forEach(p => {
                        p.y -= p.sp;
                        if(p.y < 0) p.y = h;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    });
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // å¯åŠ¨
        window.onload = () => app.init();
    </script>
</body>
</html>
