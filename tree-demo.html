<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Golden Particle AR Tree</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* æ ¸å¿ƒä¿®æ”¹ï¼šæ·±è‰²å¤œç©ºèƒŒæ™¯ */
            background: radial-gradient(circle at 50% 100%, #1a1200 0%, #050505 60%, #000 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #ffd700;
        }

        /* è§†é¢‘é¢„è§ˆå°çª—å£ (å³ä¸Šè§’) */
        #input-video {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 100px;
            height: auto;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            transform: scaleX(-1);
            z-index: 20;
            background: #000;
        }

        /* ä¸» Canvasï¼Œç”¨äºç»˜åˆ¶ç²’å­æ ‘ */
        #main-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            /* æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿ Canvas èƒŒæ™¯é€æ˜ */
            background: transparent;
        }

        /* UI è¦†ç›–å±‚ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡¶éƒ¨å€’è®¡æ—¶ */
        #timer {
            margin-top: 30px;
            font-size: 48px;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        /* æç¤ºæ–‡å­— */
        #instruction {
            margin-top: 15px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,215,0,0.2);
        }

        /* æœ€ç»ˆç¥ç¦æ–‡å­— */
        #final-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 165, 0, 1);
            opacity: 0;
            transition: opacity 1s ease-in;
            text-align: center;
            width: 90%;
            z-index: 30;
        }

        /* åŠ è½½é®ç½© */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            font-size: 16px;
            flex-direction: column;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,215,0,0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <video id="input-video" playsinline></video>
    <canvas id="main-canvas"></canvas>

    <div id="ui-layer">
        <div id="timer">12</div>
        <div id="instruction">
            ğŸ– ä¼¸æ‰‹å³å¯æ§åˆ¶<br>
            <span style="font-size:12px; opacity:0.8">å·¦å³ç§»åŠ¨æ—‹è½¬ Â· å‰åç§»åŠ¨ç¼©æ”¾</span>
        </div>
        <div id="final-message">âœ¨ é—ºèœœä»Šå¹´åœ£è¯ä¸€èµ·æš´å¯Œï¼âœ¨</div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <div>å¯åŠ¨ AR å¼•æ“ä¸­...</div>
    </div>

    <script>
        const state = {
            targetAngle: 0, currentAngle: 0,
            targetScale: 1, currentScale: 1,
            isExploded: false, timeLeft: 12, handDetected: false,
            particles: [], // å­˜å‚¨æ‰€æœ‰ç²’å­
            treeBuilt: false // æ ‡è®°æ ‘æ˜¯å¦å·²æ„å»º
        };

        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const timerElement = document.getElementById('timer');
        const msgElement = document.getElementById('final-message');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (!state.treeBuilt) {
                createTreeParticles();
                state.treeBuilt = true;
            }
        }
        window.addEventListener('resize', resize);
        
        // ==========================================
        // æ ¸å¿ƒä¿®æ”¹ï¼šæ„å»ºæ ‘å½¢ç²’å­ç³»ç»Ÿ
        // ==========================================
        function createTreeParticles() {
            state.particles = [];
            const width = canvas.width;
            const height = canvas.height;
            const cx = width / 2;
            const baseY = height * 0.85;
            const treeHeight = height * 0.6;
            const maxRadius = width * 0.25;

            // 1. æ ‘èº«ç²’å­ (é‡‘è‰²ç²‰å°˜)
            const bodyParticleCount = 1500;
            for (let i = 0; i < bodyParticleCount; i++) {
                // ä½¿ç”¨ç‰¹å®šåˆ†å¸ƒç”Ÿæˆåœ†é”¥ä½“
                const p = Math.random(); // é«˜åº¦æ¯”ä¾‹ 0 (åº•) -> 1 (é¡¶)
                const y = baseY - p * treeHeight;
                const r = (1 - p) * maxRadius; // åŠå¾„éšé«˜åº¦å‡å°
                const angle = Math.random() * Math.PI * 2;
                // åœ¨åœ†å†…éšæœºåˆ†å¸ƒï¼Œç¨å¾®èšé›†åœ¨è¡¨é¢
                const radius = r * Math.sqrt(Math.random()); 
                
                const tx = cx + Math.cos(angle) * radius;
                const ty = y;
                const tz = Math.sin(angle) * radius; // Zè½´ç”¨äºæ—‹è½¬è®¡ç®—

                state.particles.push({
                    tx, ty, tz, // ç›®æ ‡ä½ç½®
                    x: tx, y: ty, z: tz, // å½“å‰ä½ç½®
                    // åˆå§‹éšæœºæ•£å¼€ä¸€ç‚¹ï¼Œæ¨¡æ‹Ÿèšåˆå‰çš„çŠ¶æ€
                    ox: tx + (Math.random()-0.5)*width*0.5, 
                    oy: ty + (Math.random()-0.5)*height*0.5, 
                    oz: tz + (Math.random()-0.5)*width*0.5,
                    size: 1 + Math.random() * 2,
                    color: '#FFD700', // çº¯é‡‘
                    type: 'body',
                    phase: Math.random() * Math.PI * 2 // ç”¨äºå‘¼å¸åŠ¨ç”»çš„ç›¸ä½
                });
            }

            // 2. è£…é¥°ç‰©ç²’å­ (é‡‘å¸/å…ƒå®)
            const ornamentCount = 80;
            for (let i = 0; i < ornamentCount; i++) {
                const p = Math.random() * 0.9; // ä¸è¦åœ¨æœ€é¡¶éƒ¨
                const y = baseY - p * treeHeight;
                const r = (1 - p) * maxRadius;
                const angle = Math.random() * Math.PI * 2;
                // è£…é¥°ç‰©åœ¨è¡¨é¢
                const tx = cx + Math.cos(angle) * r;
                const ty = y;
                const tz = Math.sin(angle) * r;

                state.particles.push({
                    tx, ty, tz, x: tx, y: ty, z: tz,
                    ox: tx + (Math.random()-0.5)*width, oy: ty + (Math.random()-0.5)*height, oz: tz + (Math.random()-0.5)*width,
                    size: 4 + Math.random() * 4, // æ›´å¤§
                    color: '#FFA500', // åæ©™é‡‘è‰²
                    type: 'ornament',
                    phase: Math.random() * Math.PI * 2
                });
            }

            // 3. é¡¶éƒ¨æ˜Ÿæ˜Ÿç²’å­
            state.particles.push({
                tx: cx, ty: baseY - treeHeight * 1.05, tz: 0,
                x: cx, y: baseY - treeHeight * 1.05, z: 0,
                ox: cx, oy: -height*0.2, oz: 0,
                size: 12,
                color: '#FFFACD', // äº®é‡‘è‰²
                type: 'star',
                phase: 0
            });
        }

        // ==========================================
        // æ ¸å¿ƒä¿®æ”¹ï¼šç»˜åˆ¶ç²’å­ç³»ç»Ÿ
        // ==========================================
        function drawParticles(t) {
            // æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†æ¸…ç©ºä¸ºé»‘è‰²ï¼Œè€Œæ˜¯æ¸…ç©ºä¸ºé€æ˜ï¼Œé€å‡º CSS èƒŒæ™¯
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const time = t * 0.001;
            const cx = canvas.width / 2;

            // è®¡ç®—æ—‹è½¬è§’åº¦çš„ sin/cos
            const rotSin = Math.sin(state.currentAngle);
            const rotCos = Math.cos(state.currentAngle);

            state.particles.forEach(p => {
                // 1. è®¡ç®—èšåˆåŠ¨ç”» (ä» ox,oy,oz åˆ° tx,ty,tz)
                // è¿™é‡Œç®€åŒ–ä¸ºç›´æ¥åˆ°è¾¾ç›®æ ‡ä½ç½®ï¼Œä½ å¯ä»¥åŠ ä¸Šæ’å€¼å®ç°èšåˆæ•ˆæœ
                let targetX = p.tx;
                let targetY = p.ty;
                let targetZ = p.tz;

                // 2. åº”ç”¨æ—‹è½¬ (å›´ç»•ä¸­å¿ƒ Y è½´)
                // å°†åæ ‡å¹³ç§»åˆ°åŸç‚¹ï¼Œæ—‹è½¬ï¼Œå†å¹³ç§»å›å»
                const relX = targetX - cx;
                const relZ = targetZ;
                const rotatedX = relX * rotCos - relZ * rotSin;
                // const rotatedZ = relX * rotSin + relZ * rotCos; // Zç”¨äºé®æŒ¡å…³ç³»ï¼Œè¿™é‡Œç®€åŒ–ä¸è®¡ç®—
                
                // 3. åº”ç”¨ç¼©æ”¾ (å›´ç»•æ ‘åº•ä¸­å¿ƒç‚¹)
                const baseY = canvas.height * 0.85;
                let finalX = cx + rotatedX * state.currentScale;
                let finalY = baseY + (targetY - baseY) * state.currentScale;

                // 4. æ·»åŠ å‘¼å¸/æµ®åŠ¨åŠ¨ç”»
                const floatSpeed = p.type === 'body' ? 2 : 3;
                const floatRange = p.type === 'body' ? 1 : 2;
                finalY += Math.sin(time * floatSpeed + p.phase) * floatRange;

                // ç»˜åˆ¶ç²’å­
                ctx.save();
                // ç®€å•çš„é®æŒ¡æ¨¡æ‹Ÿï¼šèƒŒé¢çš„ç²’å­å˜æš—å˜å°
                // const depthScale = (rotatedZ + canvas.width*0.25) / (canvas.width*0.5);
                // const drawSize = p.size * state.currentScale * (0.5 + 0.5 * depthScale);
                // ctx.globalAlpha = 0.3 + 0.7 * depthScale;
                
                // ç®€åŒ–ç‰ˆç»˜åˆ¶ï¼Œä¸è€ƒè™‘ Z é®æŒ¡ï¼Œå…¨éƒ¨å åŠ å‘å…‰
                ctx.globalCompositeOperation = 'lighter'; 
                ctx.shadowColor = p.color;
                ctx.shadowBlur = p.size * 2;
                ctx.fillStyle = p.color;

                ctx.beginPath();
                ctx.arc(finalX, finalY, p.size * state.currentScale, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // ... (MediaPipe å’Œå…¶ä»–é€»è¾‘ä¿æŒä¸å˜) ...
        // ... (ä¸ºäº†ç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥äº† MediaPipe åˆå§‹åŒ–ã€å€’è®¡æ—¶ã€çˆ†ç‚¸ç­‰æœªä¿®æ”¹çš„ä»£ç ) ...
        // ... (è¯·ç¡®ä¿å°†å®Œæ•´çš„æœªä¿®æ”¹ä»£ç éƒ¨åˆ†å¤åˆ¶å›æ¥) ...

        // ==========================================
        // è¡¥å…¨çœç•¥çš„ä»£ç ä»¥ä¿è¯å®Œæ•´è¿è¡Œ
        // ==========================================
        
        window.onload = async function() {
            resize(); // è§¦å‘ resize ä»¥æ„å»ºåˆå§‹æ ‘

            const videoElement = document.getElementById('input-video');
            const loadingElement = document.getElementById('loading');

            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            hands.onResults(onResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            
            try {
                await cameraUtils.start();
                loadingElement.style.display = 'none'; startCountdown(); 
            } catch (err) { console.error(err); loadingElement.innerHTML = "<div>æ‘„åƒå¤´å¯åŠ¨å¤±è´¥</div>"; }

            function onResults(results) {
                if (state.isExploded) return;
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    state.handDetected = true;
                    const landmarks = results.multiHandLandmarks[0];
                    const palmX = landmarks[9].x; 
                    state.targetAngle = (palmX - 0.5) * 3;
                    const dx = landmarks[0].x - landmarks[9].x;
                    const dy = landmarks[0].y - landmarks[9].y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    state.targetScale = Math.min(Math.max(distance * 4, 0.7), 1.5);
                } else {
                    state.handDetected = false;
                    state.targetAngle = 0; state.targetScale = 1;
                }
            }

            function startCountdown() {
                const timerId = setInterval(() => {
                    state.timeLeft--; timerElement.innerText = state.timeLeft;
                    if (state.timeLeft <= 0) { clearInterval(timerId); triggerExplosion(); }
                }, 1000);
            }

            function triggerExplosion() {
                state.isExploded = true;
                timerElement.style.display = 'none'; document.getElementById('instruction').style.display = 'none';
                msgElement.style.opacity = 1; setTimeout(() => { msgElement.style.opacity = 0; }, 4000);
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªçœŸæ­£çš„çˆ†ç‚¸åŠ¨ç”»ï¼Œç›®å‰åªæ˜¯åœæ­¢ç»˜åˆ¶æ ‘
            }

            function renderFrame(timestamp) {
                const lerpSpeed = 0.1;
                state.currentAngle += (state.targetAngle - state.currentAngle) * lerpSpeed;
                state.currentScale += (state.targetScale - state.currentScale) * lerpSpeed;

                if (!state.isExploded) {
                    drawParticles(timestamp);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // å¯ä»¥åœ¨è¿™é‡Œç»˜åˆ¶çˆ†ç‚¸ç²’å­
                }
                requestAnimationFrame(renderFrame);
            }
            requestAnimationFrame(renderFrame);
        };
    </script>
</body>
</html>
